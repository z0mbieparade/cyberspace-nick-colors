// ==UserScript==
// @name         Cyberspace Nick Colors
// @author       https://z0m.bi/ (@z0ylent)
// @namespace    https://cyberspace.online/
// @version      1.0
// @description  Consistent bright colors for usernames across the site
// @match        https://cyberspace.online/*
// @updateURL    https://github.com/z0mbieparade/cyberspace-nick-colors/raw/refs/heads/main/cyberspace-nick-colors.user.js
// @downloadURL  https://github.com/z0mbieparade/cyberspace-nick-colors/raw/refs/heads/main/cyberspace-nick-colors.user.js
// @grant        GM_registerMenuCommand
// @grant        GM.registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      raw.githubusercontent.com
// @connect      gist.githubusercontent.com
// @run-at       document-idle
// ==/UserScript==

!function(){"use strict";const GM_setValue="function"==typeof window.GM_setValue?window.GM_setValue:(t,e)=>localStorage.setItem("nickColors_"+t,e),GM_getValue="function"==typeof window.GM_getValue?window.GM_getValue:(t,e)=>{const n=localStorage.getItem("nickColors_"+t);return null!==n?n:e};function t(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!e)return null;let n=parseInt(e[1],16)/255,o=parseInt(e[2],16)/255,r=parseInt(e[3],16)/255;const i=Math.max(n,o,r),a=Math.min(n,o,r);let s,l,c=(i+a)/2;if(i===a)s=l=0;else{const t=i-a;switch(l=c>.5?t/(2-i-a):t/(i+a),i){case n:s=((o-r)/t+(o<r?6:0))/6;break;case o:s=((r-n)/t+2)/6;break;case r:s=((n-o)/t+4)/6}}return{h:Math.round(360*s),s:Math.round(100*l),l:Math.round(100*c)}}function e(t,e="; "){return Object.entries(t).map(([t,e])=>{return`${n=t,n.replace(/([A-Z])/g,"-$1").toLowerCase()}: ${e}`;var n}).join(e)}function n(e){if(!e)return null;const n=e.match(/hsl\((\d+),\s*(\d+)%?,\s*(\d+)%?\)/);return n?{h:+n[1],s:+n[2],l:+n[3]}:e.startsWith("#")?t(e):null}function o(t,e,n){if(0===e&&360===n)return t;const o=t/360;if(e<=n)return e+o*(n-e);{const t=e+o*(360-e+n);return t>=360?t-360:t}}function r(t,e){return e.excludeRanges.some(([e,n])=>t>=e&&t<=n)}function i(t,e,n){return 0===e&&100===n?t:e+t/100*(n-e)}function a(){if(m&&m.bg){const e=t(m.bg);if(e)return e.l}const e=getComputedStyle(document.documentElement).getPropertyValue("--color-bg").trim();if(e){const n=t(e);if(n)return n.l}return 10}function s(){GM_setValue("siteThemeConfig",JSON.stringify(L))}function l(){const t={...w};if(C){if(L.useHueRange&&(t.minHue=(C.h-L.hueSpread+360)%360,t.maxHue=(C.h+L.hueSpread)%360),L.useSaturation){const e=L.saturationSpread||0;t.minSaturation=Math.max(0,C.s-e),t.maxSaturation=Math.min(100,C.s+e)}if(L.useLightness){const e=L.lightnessSpread||0;t.minLightness=Math.max(0,C.l-e),t.maxLightness=Math.min(100,C.l+e)}}return t}function c(){GM_setValue("colorConfig",JSON.stringify(w))}function d(t){let e=0;const n=t.toLowerCase().trim();for(let t=0;t<n.length;t++)e=n.charCodeAt(t)+((e<<5)-e),e&=e;return Math.abs(e)}let u="true"===GM_getValue("debugMode","false");const p="https://github.com/z0mbieparade/cyberspace-nick-colors/raw/refs/heads/main/overrides.json";let g={},m=null;try{const dt=localStorage.getItem("custom_theme");dt&&(m=JSON.parse(dt))}catch(ut){console.log("[Nick Colors] Could not parse site custom_theme:",ut)}const h={minSaturation:70,maxSaturation:100,minLightness:55,maxLightness:75,minHue:0,maxHue:360,excludeRanges:[],contrastThreshold:50},f={varyWeight:!1,varyItalic:!1,varyCase:!1,prependIcon:!1,appendIcon:!1,iconSet:"● ○ ◆ ◇ ■ □ ▲ △ ★ ☆ ♦ ♠ ♣ ♥ ☢ ☣ ☠ ⚙ ⬡ ⬢ ♻ ⚛ ⚠ ⛒"},b={useHueRange:!1,useSaturation:!1,useLightness:!1,hueSpread:30,saturationSpread:15,lightnessSpread:10},v=['a[href^="/"]'],y=[".chat-main-content",".profile-box-inverted"],x=[".sidebar","footer",".nc-dialog-attribution"],S=["feed","topics","jukebox","notes","write","chat","messages","bookmarks","notifications","me","guilds","support","wiki","changelog","netiquette","faq","loading","error"],k=[".profile-box-inverted"],$={"Full Spectrum":{color:{...h}},Dark:{color:{minSaturation:60,maxSaturation:80,minLightness:65,maxLightness:80,minHue:0,maxHue:360,excludeRanges:[],contrastThreshold:50}},Light:{color:{minSaturation:70,maxSaturation:90,minLightness:30,maxLightness:45,minHue:0,maxHue:360,excludeRanges:[],contrastThreshold:50}},C64:{color:{minSaturation:70,maxSaturation:90,minLightness:60,maxLightness:75,minHue:180,maxHue:280,excludeRanges:[],contrastThreshold:50}},VT320:{color:{minSaturation:90,maxSaturation:100,minLightness:50,maxLightness:65,minHue:15,maxHue:55,excludeRanges:[],contrastThreshold:50}},Matrix:{color:{minSaturation:75,maxSaturation:95,minLightness:45,maxLightness:60,minHue:70,maxHue:140,excludeRanges:[],contrastThreshold:50}},Poetry:{color:{minSaturation:40,maxSaturation:60,minLightness:30,maxLightness:45,minHue:0,maxHue:360,excludeRanges:[],contrastThreshold:50}},Brutalist:{color:{minSaturation:50,maxSaturation:70,minLightness:60,maxLightness:75,minHue:180,maxHue:260,excludeRanges:[],contrastThreshold:50}},GRiD:{color:{minSaturation:90,maxSaturation:100,minLightness:50,maxLightness:65,minHue:20,maxHue:60,excludeRanges:[],contrastThreshold:50}},System:{color:{minSaturation:60,maxSaturation:80,minLightness:65,maxLightness:80,minHue:0,maxHue:360,excludeRanges:[],contrastThreshold:50}}};let C=null;m&&m.fg&&(C=t(m.fg));let L={...b};try{const pt=GM_getValue("siteThemeConfig",null);pt&&(L={...b,...JSON.parse(pt)})}catch(gt){console.error("[Nick Colors] Failed to load site theme config:",gt)}let w={...h};try{const mt=GM_getValue("colorConfig",null);mt&&(w={...h,...JSON.parse(mt)})}catch(ht){console.error("[Nick Colors] Failed to load config:",ht)}let E={...f};try{const ft=GM_getValue("styleConfig",null);ft&&(E={...f,...JSON.parse(ft)})}catch(bt){console.error("[Nick Colors] Failed to load style config:",bt)}function T(){GM_setValue("styleConfig",JSON.stringify(E))}let I={};try{const vt=GM_getValue("customNickColors","{}");I=JSON.parse(vt)}catch(yt){I={}}function N(){GM_setValue("customNickColors",JSON.stringify(I))}function H(t,e){const n={};for(const o of Object.keys(t))JSON.stringify(t[o])!==JSON.stringify(e[o])&&(n[o]=t[o]);return Object.keys(n).length>0?n:null}function q(){const t={version:1,exportedAt:(new Date).toISOString()},e=H(w,h);e&&(t.colorConfig=e);const n=H(L,b);n&&(t.siteThemeConfig=n);const o=H(E,f);return o&&(t.styleConfig=o),Object.keys(I).length>0&&(t.customNickColors=I),t}function O(t){try{return t&&"object"==typeof t?(t=j(t)).version&&t.version>1?{success:!1,message:`Export version ${t.version} is newer than supported version 1`}:(t.colorConfig&&(w={...h,...t.colorConfig},c()),t.siteThemeConfig&&(L={...b,...t.siteThemeConfig},s()),t.styleConfig&&(E={...f,...t.styleConfig},T()),t.customNickColors&&(I={...t.customNickColors},N()),st(),{success:!0,message:"Settings imported successfully"}):{success:!1,message:"Invalid data format"}}catch(t){return{success:!1,message:`Import failed: ${t.message}`}}}const V={minSaturation:"mS",maxSaturation:"xS",minLightness:"mL",maxLightness:"xL",minHue:"mH",maxHue:"xH",excludeRanges:"eR",contrastThreshold:"cT",useHueRange:"uH",hueSpread:"hS",useSaturation:"uS",saturationSpread:"sS",useLightness:"uL",lightnessSpread:"lS",varyWeight:"vW",varyItalic:"vI",varyCase:"vC",prependIcon:"pI",appendIcon:"aI",iconSet:"iS",color:"c",backgroundColor:"bg",fontWeight:"fW",fontStyle:"fS",fontVariant:"fV",invert:"inv",colorConfig:"cc",siteThemeConfig:"stc",styleConfig:"sc",customNickColors:"cnc",version:"v",exportedAt:"at"},M=Object.fromEntries(Object.entries(V).map(([t,e])=>[e,t]));function R(t){if(null===t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(R);const e={};for(const[n,o]of Object.entries(t))e[V[n]||n]=R(o);return e}function j(t){if(null===t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(j);const e={};for(const[n,o]of Object.entries(t))e[M[n]||n]=j(o);return e}function F(t,e){!function(t,e){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}(R(t),e)}async function A(t){try{return await navigator.clipboard.writeText(JSON.stringify(R(t))),!0}catch(t){throw new Error(`Failed to copy: ${t.message}`)}}function z(t){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=e=>{const n=e.target.files[0];if(!n)return;const o=new FileReader;o.onload=e=>{try{const n=j(JSON.parse(e.target.result));t(n,null)}catch(e){t(null,new Error(`Failed to parse file: ${e.message}`))}},o.readAsText(n)},e.click()}function _(t){const e=document.createElement("div");e.className="nc-dialog-overlay",e.innerHTML='\n\t\t<div class="nc-dialog" style="min-width: 400px; max-width: 500px;">\n\t\t\t<div class="nc-dialog-header nc-flex nc-justify-between">\n\t\t\t\t<h3>Paste Settings</h3>\n\t\t\t\t<div class="spacer"></div>\n\t\t\t\t<button class="nc-header-close link-brackets"><span class="inner">ESC</span></button>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-content">\n\t\t\t\t<div class="hint" style="margin-bottom: 0.5rem;">Paste your settings JSON below (Ctrl+V or right-click → Paste)</div>\n\t\t\t\t<textarea id="paste-settings-input" style="min-height: 150px; width: 100%; font-family: monospace; font-size: 0.75rem;" placeholder="Paste settings JSON here..."></textarea>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-footer">\n\t\t\t\t<div class="buttons nc-flex nc-items-center nc-gap-2">\n\t\t\t\t\t<button class="nc-import-btn link-brackets"><span class="inner">IMPORT</span></button>\n\t\t\t\t\t<button class="nc-cancel-btn link-brackets"><span class="inner">CANCEL</span></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t';const n=()=>e.remove(),o=e.querySelector("#paste-settings-input");e.querySelector(".nc-header-close").addEventListener("click",n),e.querySelector(".nc-cancel-btn").addEventListener("click",n),e.querySelector(".nc-import-btn").addEventListener("click",()=>{const e=o.value.trim();if(e)try{const o=j(JSON.parse(e));n(),t(o,null)}catch(e){t(null,new Error(`Failed to parse: ${e.message}`))}else alert("Please paste settings JSON first")}),e.addEventListener("click",t=>{t.target===e&&n()}),e.addEventListener("keydown",t=>{"Escape"===t.key&&n()}),document.body.appendChild(e),o.focus()}function G(t,e=null){const n=`https://cyberspace.online/${t}`;if(window.location.pathname===`/${t}`)return console.log("navigated to user profile, triggering compose shortcut"),void document.dispatchEvent(new KeyboardEvent("keydown",{key:"c",code:"KeyC",bubbles:!0}));sessionStorage.setItem("nickColors_openCompose","true"),e&&sessionStorage.setItem("nickColors_composeMessage",e),window.location.href=n}if("true"===sessionStorage.getItem("nickColors_openCompose")){function xt(t=0){console.log(`[NickColors] tryOpenCompose attempt ${t}, readyState: ${document.readyState}`);let e=null;const n=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,!1);let o;for(;o=n.nextNode();){const t=o.textContent?.trim()||"";if(t.includes("[C]")&&t.includes("C-Mail")){e=o.parentElement,console.log(`[NickColors] Found text node with C-Mail, parent: ${e?.tagName}, text: "${t}"`);break}}if(e){console.log("[NickColors] Found C-Mail button, clicking it:",e),e.click();const t=sessionStorage.getItem("nickColors_composeMessage");t&&(sessionStorage.removeItem("nickColors_composeMessage"),setTimeout(()=>St(t,0),300))}else t>30?console.log("[NickColors] Max attempts reached, giving up"):(console.log("[NickColors] C-Mail button not found, retrying in 500ms"),setTimeout(()=>xt(t+1),500))}function St(t,e){console.log(`[NickColors] tryFillMessage attempt ${e}`);const n=document.querySelector('input[placeholder="Type a message..."], textarea[placeholder="Type a message..."]');n?(console.log("[NickColors] Found message input, filling it"),n.focus(),n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0}))):e<20?setTimeout(()=>St(t,e+1),200):console.log("[NickColors] Could not find message input, giving up")}sessionStorage.removeItem("nickColors_openCompose"),console.log("[NickColors] Detected openCompose flag, will try to open compose"),console.log("[NickColors] readyState:",document.readyState),"complete"===document.readyState?(console.log("[NickColors] Page already complete, starting in 1s"),setTimeout(xt,1e3)):(console.log("[NickColors] Waiting for load event"),window.addEventListener("load",()=>{console.log("[NickColors] Load event fired, starting in 1s"),setTimeout(xt,1e3)}))}function W(){const t=l(),e=[];e.push("=".repeat(60)),e.push("NICK COLORS DEBUG LOG"),e.push("=".repeat(60)),e.push(""),e.push(`Exported: ${(new Date).toISOString()}`),e.push(`URL: ${window.location.href}`),e.push(`User Agent: ${navigator.userAgent}`),e.push(""),e.push("-".repeat(60)),e.push("SITE THEME"),e.push("-".repeat(60)),e.push(`Site Theme: ${m?JSON.stringify(m):"none"}`),e.push(`Site Theme HSL: ${C?JSON.stringify(C):"none"}`),e.push(""),e.push("-".repeat(60)),e.push("COLOR CONFIG"),e.push("-".repeat(60)),e.push(JSON.stringify(w,null,2)),e.push(""),e.push("-".repeat(60)),e.push("EFFECTIVE CONFIG (after site theme integration)"),e.push("-".repeat(60)),e.push(JSON.stringify(t,null,2)),e.push(""),e.push("-".repeat(60)),e.push("SITE THEME CONFIG"),e.push("-".repeat(60)),e.push(JSON.stringify(L,null,2)),e.push(""),e.push("-".repeat(60)),e.push("STYLE CONFIG"),e.push("-".repeat(60)),e.push(JSON.stringify(E,null,2)),e.push(""),e.push("-".repeat(60)),e.push(`CUSTOM NICK COLORS (${Object.keys(I).length} total)`),e.push("-".repeat(60)),e.push(JSON.stringify(I,null,2)),e.push(""),e.push("-".repeat(60)),e.push(`MANUAL OVERRIDES (${Object.keys(g).length} total)`),e.push("-".repeat(60)),e.push(JSON.stringify(g,null,2)),e.push("");const n=document.querySelectorAll(".nc-dialog-debug, .nc-dynamic-debug");return n.length>0&&(e.push("-".repeat(60)),e.push(`DEBUG ELEMENTS (${n.length} found)`),e.push("-".repeat(60)),n.forEach((t,n)=>{e.push(`[${n+1}] ${t.textContent.trim()}`)}),e.push("")),e.push("=".repeat(60)),e.push("END OF DEBUG LOG"),e.push("=".repeat(60)),e.join("\n")}function J(t){if(I[t]){const e=I[t],o="string"==typeof e?e:e.color;if(o){const t=n(o);if(t)return t}}if(g[t]){const e=g[t],o="string"==typeof e?e:e.color;if(o){const t=n(o);if(t)return t}}return{h:d(t)%360,s:d(t+"_sat")%101,l:d(t+"_lit")%101}}function D(t,e){return{h:o(t.h,e.minHue,e.maxHue),s:i(t.s,e.minSaturation,e.maxSaturation),l:i(t.l,e.minLightness,e.maxLightness)}}function P(t){let e={};const o=l(),i=I[t]?.invert,s=D(J(t),o);let c=s.h,u=0;for(;r(c,o)&&u<36;)c=(c+10)%360,u++;if(e.color=`hsl(${c}, ${s.s}%, ${s.l}%)`,I[t]&&"object"==typeof I[t]){const n={...I[t]};delete n.color,delete n.invert,e={...e,...n}}else if(g[t]&&"object"==typeof g[t]){const n={...g[t]};delete n.color,e={...e,...n}}let p=!1;if(!0===i)p=!0;else if(!1===i)p=!1;else{const t=o.contrastThreshold||0;if(t>0&&e.color&&!e.backgroundColor){const o=n(e.color);if(o){const e=a();p=Math.abs(o.l-e)<t}}}p&&e.color&&!e.backgroundColor&&(e.backgroundColor=e.color,e.color="var(--color-fg, #fff)",e.padding="0 0.25em");const m=d(t+"_style");return E.varyWeight&&!e.fontWeight&&(e.fontWeight=m%2==0?"normal":"bold"),E.varyItalic&&!e.fontStyle&&(e.fontStyle=m%4==0?"italic":"normal"),E.varyCase&&!e.fontVariant&&(e.fontVariant=m%4==1?"small-caps":"normal"),e}function U(t,e=E){if(!e.prependIcon&&!e.appendIcon||!e.iconSet)return null;const n=e.iconSet.split(/\s+/).filter(Boolean);return 0===n.length?null:n[d(t+"_icon")%n.length]}function B(t){const e=d(t+"_style");return{fontWeight:e%2==0?"normal":"bold",fontStyle:e%4==0?"italic":"normal",fontVariant:e%4==1?"small-caps":"normal"}}function Z(t){const e=I[t]||{},n=g[t]||{},o="prependIcon"in n||"appendIcon"in n;if("prependIcon"in e||"appendIcon"in e)return{prepend:e.prependIcon||null,append:e.appendIcon||null};if(o)return{prepend:n.prependIcon||null,append:n.appendIcon||null};const r=U(t);return{prepend:E.prependIcon&&r?r:null,append:E.appendIcon&&r?r:null}}function X(t){return!!t&&(t.startsWith("@")&&(t=t.slice(1)),t=t.trim().toLowerCase(),!S.includes(t)&&!t.includes(" "))}function K(){const t=v.join(", ");document.querySelectorAll(t).forEach(t=>{if(!function(t){if(t.dataset.nickColored)return!1;const e=t.textContent.trim();if(e.includes(" ")){const t=e.split(" ");if(2!==t.length||t[1].includes(" ")||0===t[1].length)return!1}const n=t.getAttribute("href")||"";return!((n.match(/\//g)||[]).length>1)&&(!(y.length>0&&!y.some(e=>t.closest(e)))&&(!(x.length>0&&x.some(e=>t.closest(e)))&&X(n.startsWith("/")?n.slice(1):n)))}(t))return;const e=function(t){const e=t.getAttribute("href");if(e&&e.startsWith("/")){const t=e.slice(1);if(!t.includes("/")&&!t.includes(".")){const t=e.match(/^\/([^\/\?#]+)/);if(t&&X(t[1]))return t[1]}}if(t.dataset.username&&X(t.dataset.username))return t.dataset.username;let n=t.textContent.trim();if(n.includes(" ")){const t=n.split(" ");n=t[t.length-1]}return n&&n.length<30&&(n.startsWith("@")&&(n=n.slice(1)),X(n))?n:null}(t);e&&function(t,e){const n=P(e);k.length>0&&k.some(e=>t.closest(e))&&(n.backgroundColor?(n.color=n.backgroundColor,delete n.backgroundColor,delete n.padding):n.color&&(n.backgroundColor=n.color,n.color="var(--color-fg, #fff)",n.padding="0 0.25rem")),Object.assign(t.style,n),t.dataset.nickColored="true",t.dataset.username=e;const o=Z(e);if(o.prepend||o.append){t.dataset.iconApplied||(t.dataset.originalText=t.textContent,t.dataset.iconApplied="true");let e=t.dataset.originalText||t.textContent;o.prepend&&(e=o.prepend+" "+e),o.append&&(e=e+" "+o.append),t.textContent=e}else t.dataset.iconApplied&&(t.dataset.originalText&&(t.textContent=t.dataset.originalText),delete t.dataset.iconApplied,delete t.dataset.originalText)}(t,e)}),function(){const t=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:t=>{if(!t.textContent.includes("@"))return NodeFilter.FILTER_REJECT;if(t.parentElement?.closest("[data-mention-colored]"))return NodeFilter.FILTER_REJECT;if(t.parentElement?.closest("[data-nick-colored]"))return NodeFilter.FILTER_REJECT;if(t.parentElement?.closest(".nc-dialog-preview"))return NodeFilter.FILTER_REJECT;const e=t.parentElement?.tagName;return"SCRIPT"===e||"STYLE"===e||"TEXTAREA"===e||"INPUT"===e||x.length>0&&x.some(e=>t.parentElement?.closest(e))?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}}),e=[];let n;for(;n=t.nextNode();)e.push(n);e.forEach(t=>{const e=t.textContent,n=/@([a-zA-Z0-9_-]+)/g;let o;const r=[];for(;null!==(o=n.exec(e));){if(o.index>0&&/[a-zA-Z0-9._-]/.test(e[o.index-1]))continue;const t=e.slice(o.index+o[0].length);/^\.[a-zA-Z]/.test(t)||X(o[1])&&r.push({full:o[0],username:o[1],index:o.index})}if(0===r.length)return;const i=document.createDocumentFragment();let a=0;r.forEach(n=>{n.index>a&&i.appendChild(document.createTextNode(e.slice(a,n.index)));const o=document.createElement("span"),r=Z(n.username);let s=n.full;r.prepend&&(s=r.prepend+" "+s),r.append&&(s=s+" "+r.append),o.textContent=s,o.dataset.mentionColored="true",o.dataset.username=n.username,(r.prepend||r.append)&&(o.dataset.iconApplied="true");const l=P(n.username);k.length>0&&t.parentElement?.closest(k.join(", "))&&(l.backgroundColor?(l.color=l.backgroundColor,delete l.backgroundColor,delete l.padding):l.color&&(l.backgroundColor=l.color,l.color="var(--color-fg, #fff)",l.padding="0 0.25rem")),Object.assign(o.style,l),i.appendChild(o),a=n.index+n.full.length}),a<e.length&&i.appendChild(document.createTextNode(e.slice(a))),t.parentNode.replaceChild(i,t)})}()}const Y=document.createElement("style");function Q(t){const{type:e="single",simple:n=!1,min:o=0,max:r=100,onChange:i,label:a}=t,s="range"===e,l=document.createElement("div");l.innerHTML=`\n\t\t${a?`<label style="display:block;margin:0.5rem 0 0.25rem;font-size:0.75rem;color:var(--color-fg-dim,#888)">${a}</label>`:""}\n\t\t<div class="nc-slider${n?" nc-slider-simple":""}">\n\t\t\t<div class="nc-slider-track-mapped"></div>\n\t\t\t<div class="nc-slider-track"></div>\n\t\t\t${s?'<div class="nc-slider-thumb" data-i="0">▶</div><div class="nc-slider-thumb" data-i="1">◀</div>':'<div class="nc-slider-thumb" data-i="0"></div>'}\n\t\t</div>\n\t\t<div class="nc-slider-labels"><span></span>${s?"<span></span>":""}</div>\n\t`;const c=l.querySelector(".nc-slider-track"),d=l.querySelector(".nc-slider-track-mapped"),u=l.querySelectorAll(".nc-slider-thumb"),p=l.querySelectorAll(".nc-slider-labels span"),g=l.querySelector(".nc-slider");let m=s?[...t.values||[o,r]]:[t.value??o];function h(t){return(t-o)/(r-o)*100}function f(){u.forEach((t,e)=>t.style.left=h(m[e])+"%"),s?(p[0].textContent=`${m[0]}`,p[1].textContent=`${m[1]}`):p[0].textContent=`${m[0]}`}function b(t){if(s){const e=h(m[0]),n=h(m[1]),o=e>n,r=(t,e,n)=>{const[o,r,i,a,s]=t,[l,c,d,u,p]=e,g=p===s?0:(n-s)/(p-s);return[Math.round(o+g*(l-o)),Math.round(r+g*(c-r)),Math.round(i+g*(d-i)),a+g*(u-a),n]},i=e=>{for(let n=0;n<t.length-1;n++)if(e>=t[n][4]&&e<=t[n+1][4])return[t[n],t[n+1]];return[t[0],t[t.length-1]]},a=[],s=t.map(t=>t[4]);[...new Set([...s,e,n])].sort((t,e)=>t-e).forEach(t=>{const[s,l]=i(t),c=r(s,l,t);if(t===e||t===n)t===e?(a.push([...c.slice(0,3),.5,t]),a.push([...c.slice(0,3),1,t])):(a.push([...c.slice(0,3),1,t]),a.push([...c.slice(0,3),.5,t]));else{const r=o?t>=e||t<=n:t>=e&&t<=n;a.push([...c.slice(0,3),r?c[3]:.5,t])}}),t=a}c.style.background=`linear-gradient(to right, ${t.map(t=>{const[e,n,o,r=1,i=null]=t;let a=`hsla(${e}, ${n}%, ${o}%, ${r})`;return null!==i&&(a+=` ${i}%`),a}).join(", ")})`}let v=null;function y(t){const e=g.getBoundingClientRect(),n=(t.clientX??t.touches?.[0]?.clientX)-e.left;return i=Math.max(0,Math.min(100,n/e.width*100)),Math.round(o+i/100*(r-o));var i}function x(t){const e=t.target.closest(".nc-slider-thumb");e&&(v=+e.dataset.i,t.preventDefault())}function S(t){null!==v&&(m[v]=y(t),f(),i?.(s?[...m]:m[0]))}function k(){v=null}function $(t){return`linear-gradient(to right, ${t.map(t=>{const[e,n,o,r=1,i=null]=t;let a=`hsla(${e}, ${n}%, ${o}%, ${r})`;return null!==i&&(a+=` ${i}%`),a}).join(", ")})`}return g.addEventListener("mousedown",x),document.addEventListener("mousemove",S),document.addEventListener("mouseup",k),g.addEventListener("touchstart",x,{passive:!1}),document.addEventListener("touchmove",S,{passive:!1}),document.addEventListener("touchend",k),c.addEventListener("click",t=>{const e=y(t);if(s){const t=Math.abs(e-m[0]),n=Math.abs(e-m[1]);m[t<=n?0:1]=e}else m[0]=e;f(),i?.(s?[...m]:m[0])}),t.gradient&&b(t.gradient),f(),{el:l,getValue:()=>m[0],getValues:()=>[...m],setValue:t=>{m[0]=t,f()},setValues:t=>{m=[...t],f()},setGradient:b,setSplitGradient:function(t,e){if(!t)return g.classList.remove("nc-slider-split"),void(d.style.background="");g.classList.add("nc-slider-split"),d.style.background=$(t),c.style.background=$(e)},setThumbColor:function(t){const e=Array.isArray(t)?t:[t];u.forEach((t,n)=>{e[n]&&(t.style.background=e[n])})}}}Y.textContent="\n\t.nc-slider { position: relative; height: 24px; margin: 0.5rem 0; }\n\t.nc-slider-track {\n\t\tposition: absolute;\n\t\tinset: 4px 0;\n\t\tborder: 1px solid var(--color-border, #333);\n\t\tbackground: var(--color-code-bg, #444);\n\t\tbox-sizing: border-box;\n\t}\n\t/* Mapped track hidden by default */\n\t.nc-slider .nc-slider-track-mapped {\n\t\tdisplay: none;\n\t\tposition: absolute;\n\t\ttop: 4px;\n\t\tbottom: calc(50% + 1px);\n\t\tleft: 0;\n\t\tright: 0;\n\t\tborder: 1px solid var(--color-border, #333);\n\t\tbackground: var(--color-code-bg, #444);\n\t\tbox-sizing: border-box;\n\t}\n\t/* Split track for showing mapped vs full range - taller with gap */\n\t.nc-slider.nc-slider-split { height: 34px; }\n\t.nc-slider.nc-slider-split .nc-slider-track {\n\t\ttop: calc(50% + 1px);\n\t\tbottom: 4px;\n\t}\n\t.nc-slider.nc-slider-split .nc-slider-track-mapped {\n\t\tdisplay: block !important;\n\t}\n\t.nc-slider-thumb {\n\t\tposition: absolute; top: 0; width: 14px; height: 22px;\n\t\tbackground: var(--color-fg, #fff);\n\t\tborder: 2px solid var(--color-bg, #000);\n\t\toutline: 1px solid var(--color-border, #333);\n\t\tcursor: ew-resize; transform: translateX(-50%); z-index: 2;\n\t\tdisplay: flex; align-items: center; justify-content: center;\n\t\tfont-size: 8px;\n\t\tcolor: var(--color-bg, #000); user-select: none;\n\t\tbox-sizing: border-box;\n\t}\n\t.nc-slider.nc-slider-split .nc-slider-thumb { height: 32px; }\n\t.nc-slider-labels {\n\t\tdisplay: flex; justify-content: space-between; margin-top: 2px;\n\t\tfont-size: 0.625rem; color: var(--color-fg-dim, #888);\n\t}\n\t/* Simple single-value slider style */\n\t.nc-slider.nc-slider-simple { height: 16px; }\n\t.nc-slider-simple .nc-slider-track {\n\t\tinset: 7px 0; height: 2px;\n\t\tborder: none;\n\t\tbackground: var(--color-border, #333);\n\t}\n\t.nc-slider-simple .nc-slider-thumb {\n\t\ttop: 3px; width: 10px; height: 10px;\n\t\tborder-radius: 50%;\n\t}\n\t.nc-slider-simple .nc-slider-thumb::before {\n\t\tcontent: '';\n\t\tposition: absolute;\n\t\tinset: -8px;\n\t}\n",document.head.appendChild(Y);const tt=document.createElement("style");function et(t){const{label:e,id:n,type:o="text",value:r="",placeholder:i="",hint:a="",classes:s="",options:l,checked:c=!1,disabled:d=!1,state:u=null,defaultLabel:p="",buttonText:g="",stacked:m=!1}=t;if(m||["text","textarea","select"].includes(o)){let t;return t="textarea"===o?`<textarea id="${n}" placeholder="${i}">${r}</textarea>`:"select"===o&&l?`<select id="${n}">${l}</select>`:`<input type="${o}" id="${n}" value="${r}" placeholder="${i}">`,`\n\t\t\t<div class="${"nc-input-row-stacked"+(s?" "+s:"")}">\n\t\t\t\t${e?`<label for="${n}">${e}</label>`:""}\n\t\t\t\t${t}\n\t\t\t\t${a?`<div class="hint">${a}</div>`:""}\n\t\t\t</div>\n\t\t`}if("toggle"===o)return`\n\t\t\t<div class="${"nc-input-row nc-flex nc-items-center nc-justify-between nc-gap-4 nc-toggle"+(s?" "+s:"")}">\n\t\t\t\t<label>${e}</label>\n\t\t\t\t<label class="nc-toggle-label">\n\t\t\t\t\t<div class="nc-toggle-value">${c?"true":"false"}</div>\n\t\t\t\t\t<input type="checkbox" id="${n}" class="nc-sr-only" ${c?"checked":""} ${d?"disabled":""}>\n\t\t\t\t\t<div class="nc-toggle-track${c?" active":""}">\n\t\t\t\t\t\t<div class="nc-toggle-thumb ${c?"pos-end":"pos-start"}"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t`;if("tristate"===o){const t=!0===u;return`\n\t\t\t<div class="${"nc-input-row nc-flex nc-items-center nc-justify-between nc-gap-4 nc-toggle nc-tristate-toggle"+(s?" "+s:"")}">\n\t\t\t\t<label>${e}${p?` <span class="nc-text-dim">(default: ${p})</span>`:""}</label>\n\t\t\t\t<label class="nc-toggle-label">\n\t\t\t\t\t<div class="nc-toggle-value">${!0===u?"true":!1===u?"false":"auto"}</div>\n\t\t\t\t\t<input type="checkbox" id="${n}" class="nc-sr-only" ${t?"checked":""}>\n\t\t\t\t\t<div class="nc-toggle-track${t?" active":""}">\n\t\t\t\t\t\t<div class="nc-toggle-thumb ${!0===u?"pos-end":!1===u?"pos-start":"pos-middle"}"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t`}return"button"===o?`\n\t\t\t<div class="${"nc-input-row nc-flex nc-items-center nc-justify-between nc-gap-4"+(s?" "+s:"")}">\n\t\t\t\t<label>${e}</label>\n\t\t\t\t<button id="${n}" class="nc-inline-btn nc-flex-shrink-0">${g}</button>\n\t\t\t</div>\n\t\t`:""}function nt(t){return et({...t,type:"toggle"})}function ot(t){return et({...t,type:"tristate"})}function rt(t,e=""){const n=u?"":' style="display: none;"',o="nc-dialog-debug"+(e?" "+e:"");return"string"==typeof t?`<pre class="${o}"${n}>${t}</pre>`:`<pre class="${o}"${n}>\n${Object.entries(t).map(([t,e])=>`<strong>${t}:</strong> ${e??"N/A"}`).join("\n")}\n</pre>`}function it(t,e=""){let n=t.querySelector(".nc-dynamic-debug");return n||(n=document.createElement("pre"),n.className="nc-dynamic-debug nc-dialog-debug"+(e?" "+e:""),t.appendChild(n)),n.style.display=u?"":"none",n}function at(t){const{title:e,content:n,buttons:o=[],width:r="400px",onClose:i,onSettings:a,preview:s=""}=t,l=document.createElement("div");l.className="nc-dialog-overlay",l.innerHTML=`\n\t\t<div class="nc-dialog" style="min-width: ${r}; max-width: calc(${r} + 100px);">\n\t\t\t<div class="nc-dialog-header nc-flex nc-justify-between">\n\t\t\t\t<h3>${e}</h3>\n\t\t\t\t<div class="spacer"></div>\n\t\t\t\t${a?'<button class="nc-header-settings link-brackets"><span class="inner">SETTINGS</span></button>':""}\n\t\t\t\t<button class="nc-header-close link-brackets"><span class="inner">ESC</span></button>\n\t\t\t</div>\n\t\t\t${s?`<div class="nc-dialog-preview">${s}</div>`:""}\n\t\t\t<div class="nc-dialog-content">\n\t\t\t\t${n}\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-footer">\n\t\t\t\t<div class="nc-dialog-warning hint">\n\t\t\t\t\tThis is a custom userscript. Do NOT report issues to the creator of Cyberspace. Use the [SETTINGS] -> [REPORT ISSUE] button.\n\t\t\t\t</div>\n\t\t\t\t<div class="nc-dialog-attribution hint">\n\t\t\t\t\t<span>created by <a href="/z0ylent">@z0ylent</a></span>\n\t\t\t\t\t<span> | </span>\n\t\t\t\t\t<span><a href="https://z0m.bi" target="_blank">https://z0m.bi</a></span>\n\t\t\t\t\t<span> | </span>\n\t\t\t\t\t<span><a class="github-link" href="https://github.com/z0mbieparade/cyberspace-nick-colors" target="_blank" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="14px"> <path fill="currentColor" d="M5 2h4v2H7v2H5V2Zm0 10H3V6h2v6Zm2 2H5v-2h2v2Zm2 2v-2H7v2H3v-2H1v2h2v2h4v4h2v-4h2v-2H9Zm0 0v2H7v-2h2Zm6-12v2H9V4h6Zm4 2h-2V4h-2V2h4v4Zm0 6V6h2v6h-2Zm-2 2v-2h2v2h-2Zm-2 2v-2h2v2h-2Zm0 2h-2v-2h2v2Zm0 0h2v4h-2v-4Z"/> </svg></a></span>\n\t\t\t\t\t<span> | </span>\n\t\t\t\t\t<span>v1.0</span><br />\n\t\t\t\t</div>\n\t\t\t\t<hr />\n\t\t\t\t<div class="buttons nc-flex nc-flex-wrap nc-items-center nc-gap-2">\n\t\t\t\t\t${o.map(t=>`<button class="${t.class||""} link-brackets"><span class="inner">${t.label}</span></button>`).join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`;const c=()=>{l.remove(),i?.()};o.forEach(t=>{const e=l.querySelector(`.nc-dialog-footer button.${t.class}`);e&&t.onClick&&e.addEventListener("click",()=>t.onClick(c))});const d=l.querySelector(".nc-header-close");d&&d.addEventListener("click",c);const u=l.querySelector(".nc-header-settings");return u&&a&&u.addEventListener("click",()=>{c(),a()}),l.addEventListener("click",t=>{t.target===l&&c()}),l.addEventListener("keydown",t=>{"Escape"===t.key&&c()}),l.setAttribute("tabindex","-1"),document.body.appendChild(l),l.focus(),{el:l,close:c,querySelector:t=>l.querySelector(t),querySelectorAll:t=>l.querySelectorAll(t)}}function st(){document.querySelectorAll("[data-nick-colored]").forEach(t=>{t.dataset.originalText&&(t.textContent=t.dataset.originalText),delete t.dataset.nickColored,delete t.dataset.iconApplied,delete t.dataset.originalText,delete t.dataset.username,t.style.cssText=""}),document.querySelectorAll("[data-mention-colored]").forEach(t=>{const e=t.dataset.username,n=e?`@${e}`:t.textContent;t.replaceWith(document.createTextNode(n))}),K()}function lt(){const t=l(),e=at({title:"Nick Color Settings",width:"400px",preview:'<div class="preview-row" id="settings-preview"></div>',content:`\n\t\t\t\t${rt({"Site Theme":m?`fg:${m.fg} bg:${m.bg}`:"not detected","Site Theme HSL":C?`H:${C.h} S:${C.s} L:${C.l}`:"N/A","Effective Config":`H:${t.minHue}-${t.maxHue} S:${t.minSaturation}-${t.maxSaturation} L:${t.minLightness}-${t.maxLightness}`,"Contrast Threshold":t.contrastThreshold,"Custom Colors Saved":Object.keys(I).length})}\n\t\t\t\t${et({label:"Preset Theme:",id:"settings-preset",type:"select",options:`<option value="">-- Select a preset --</option>${Object.keys($).map(t=>`<option value="${t}">${t}</option>`).join("")}`})}\n\t\t\t\t<hr />\n\t\t\t\t<h4>Hue Range${C?"":' <span class="nc-text-dim">(no site theme)</span>'}</h4>\n\t\t\t\t${nt({label:"Use site theme foreground hue"+(C?` <span style="color:hsl(${C.h}, 100%, 50%)">(${C.h}°)</span>`:""),id:"settings-site-hue",checked:L.useHueRange,disabled:!C})}\n\t\t\t\t<div id="hue-spread-container" style="display: ${L.useHueRange?"block":"none"}"></div>\n\t\t\t\t<div id="hue-slider-container"></div>\n\t\t\t\t<hr />\n\t\t\t\t<h4>Saturation Range</h4>\n\t\t\t\t${nt({label:"Use site theme foreground saturation"+(m?.fg?` <span style="color:${m.fg}">(${C.s}%)</span>`:""),id:"settings-site-saturation",checked:L.useSaturation,disabled:!C})}\n\t\t\t\t<div id="sat-spread-container" style="display: ${L.useSaturation?"block":"none"}"></div>\n\t\t\t\t<div id="sat-slider-container"></div>\n\t\t\t\t<hr />\n\t\t\t\t<h4>Lightness Range</h4>\n\t\t\t\t${nt({label:"Use site theme foreground lightness"+(m?.fg?` <span style="color:${m.fg}">(${C.l}%)</span>`:""),id:"settings-site-lightness",checked:L.useLightness,disabled:!C})}\n\t\t\t\t<div id="lit-spread-container" style="display: ${L.useLightness?"block":"none"}"></div>\n\t\t\t\t<div id="lit-slider-container"></div>\n\t\t\t\t<hr />\n\t\t\t\t<h4>Contrast</h4>\n\t\t\t\t<div class="hint" style="margin-top: -0.25rem; margin-bottom: 0.25rem;">\n\t\t\t\t\tReverse foreground and background when lightness contrast is below threshold (0 = disabled)\n\t\t\t\t</div>\n\t\t\t\t<div id="contrast-slider-container"></div>\n\t\t\t\t<hr />\n\t\t\t\t<h4>Style Variation</h4>\n\t\t\t\t<div class="hint" style="margin-top: -0.25rem; margin-bottom: 0.25rem;">\n\t\t\t\t\tAdd non-color variation to usernames (useful for limited color ranges)\n\t\t\t\t</div>\n\t\t\t\t${nt({label:"Vary font weight",id:"settings-vary-weight",checked:E.varyWeight})}\n\t\t\t\t${nt({label:"Vary italic",id:"settings-vary-italic",checked:E.varyItalic})}\n\t\t\t\t${nt({label:"Vary small-caps",id:"settings-vary-case",checked:E.varyCase})}\n\t\t\t\t${nt({label:"Prepend icon",id:"settings-prepend-icon",checked:E.prependIcon})}\n\t\t\t\t${nt({label:"Append icon",id:"settings-append-icon",checked:E.appendIcon})}\n\t\t\t\t<div class="nc-input-row-stacked" id="icon-set-container" style="display: ${E.prependIcon||E.appendIcon?"block":"none"}">\n\t\t\t\t\t<label for="settings-icon-set">Icon set (space-separated)</label>\n\t\t\t\t\t<input type="text" id="settings-icon-set" value="${E.iconSet}" placeholder="● ○ ◆ ◇ ■ □ ▲ △ ★ ☆">\n\t\t\t\t</div>\n\t\t\t\t<hr />\n\t\t\t\t<h4>Backup</h4>\n\t\t\t\t${et({type:"button",label:"Export settings to file",id:"settings-export-file",buttonText:"Save Settings File"})}\n\t\t\t\t${et({type:"button",label:"Export settings to clipboard",id:"settings-export-copy",buttonText:"Copy to Clipboard"})}\n\t\t\t\t${et({type:"button",label:"Import settings from file",id:"settings-import-file",buttonText:"Load Settings File"})}\n\t\t\t\t${et({type:"button",label:"Import settings from clipboard",id:"settings-import-paste",buttonText:"Paste from Clipboard"})}\n\t\t\t\t<hr />\n\t\t\t\t<h4>Debug</h4>\n\t\t\t\t${et({type:"toggle",label:"Enable debug mode",id:"settings-debug-mode",checked:u})}\n\t\t\t\t${et({type:"button",label:"Export debug log to file",id:"settings-debug-export-file",buttonText:"Save Debug File"})}\n\t\t\t\t${et({type:"button",label:"Export debug log to clipboard",id:"settings-debug-export-copy",buttonText:"Copy to Clipboard"})}\n\t\t\t\t${et({type:"button",label:"Report an issue",id:"settings-report-issue",buttonText:"Report Issue"})}\n\t\t\t`,buttons:[{label:"Save",class:"save",onClick:t=>{const e=tt();w=e.color,L=e.siteTheme,E=e.style,c(),s(),T(),st(),t()}},{label:"Reset",class:"reset",onClick:()=>{i.setValues([h.minHue,h.maxHue]),p.setValues([h.minSaturation,h.maxSaturation]),v.setValues([h.minLightness,h.maxLightness]),y.setValue(h.contrastThreshold),x.setValue(b.hueSpread),S.setValue(b.saturationSpread),k.setValue(b.lightnessSpread),H&&(H.checked=b.useHueRange),V&&(V.checked=b.useSaturation),M&&(M.checked=b.useLightness),j&&(j.checked=f.varyWeight),J&&(J.checked=f.varyItalic),D&&(D.checked=f.varyCase),Z&&(Z.checked=f.prependIcon),X&&(X.checked=f.appendIcon),K&&(K.value=f.iconSet),Y&&(Y.style.display=f.prependIcon||f.appendIcon?"block":"none"),n.value="",it()}},{label:"Cancel",class:"cancel",onClick:t=>t()}]}),n=e.querySelector("#settings-preset"),o=e.querySelector("#settings-preview"),r=["z0ylent","CyB3rPuNk","ZeR0C00L","an0nym0us","Ph4nt0m_","enki","genghis_khan","ByteMe99","neo","l1sb3th","N3tRuNn3r","acidBurn","fr33Kevin","triNity"];r.forEach(t=>{const e=document.createElement("span");e.className="preview-nick",e.textContent=t,o.appendChild(e)});const i=Q({type:"range",min:0,max:360,values:[w.minHue,w.maxHue],label:"Hue Range",onChange:it}),p=Q({type:"range",min:0,max:100,values:[w.minSaturation,w.maxSaturation],label:"Saturation Range",onChange:it}),v=Q({type:"range",min:0,max:100,values:[w.minLightness,w.maxLightness],label:"Lightness Range",onChange:it}),y=Q({simple:!0,min:0,max:50,value:w.contrastThreshold||50,label:"Contrast Threshold",onChange:it}),x=Q({simple:!0,min:5,max:180,value:L.hueSpread,label:"Hue spread (±°)",onChange:()=>N()}),S=Q({simple:!0,min:0,max:50,value:L.saturationSpread||b.saturationSpread,label:"Saturation spread (±%)",onChange:()=>N()}),k=Q({simple:!0,min:0,max:50,value:L.lightnessSpread||b.lightnessSpread,label:"Lightness spread (±%)",onChange:()=>N()});let N=()=>{};e.querySelector("#hue-slider-container").appendChild(i.el),e.querySelector("#sat-slider-container").appendChild(p.el),e.querySelector("#lit-slider-container").appendChild(v.el),e.querySelector("#contrast-slider-container").appendChild(y.el),e.querySelector("#hue-spread-container").appendChild(x.el),e.querySelector("#sat-spread-container").appendChild(S.el),e.querySelector("#lit-spread-container").appendChild(k.el);const H=e.querySelector("#settings-site-hue"),V=e.querySelector("#settings-site-saturation"),M=e.querySelector("#settings-site-lightness"),j=e.querySelector("#settings-vary-weight"),J=e.querySelector("#settings-vary-italic"),D=e.querySelector("#settings-vary-case"),Z=e.querySelector("#settings-prepend-icon"),X=e.querySelector("#settings-append-icon"),K=e.querySelector("#settings-icon-set"),Y=e.querySelector("#icon-set-container");function tt(){const[t,e]=i.getValues(),[n,o]=p.getValues(),[r,a]=v.getValues();return{color:{minHue:t,maxHue:e,minSaturation:n,maxSaturation:o,minLightness:r,maxLightness:a,excludeRanges:w.excludeRanges,contrastThreshold:y.getValue()},siteTheme:{useHueRange:H?.checked||!1,hueSpread:x.getValue(),useSaturation:V?.checked||!1,saturationSpread:S.getValue(),useLightness:M?.checked||!1,lightnessSpread:k.getValue()},style:{varyWeight:j?.checked||!1,varyItalic:J?.checked||!1,varyCase:D?.checked||!1,prependIcon:Z?.checked||!1,appendIcon:X?.checked||!1,iconSet:K?.value||""}}}function ot(){const[t,e]=i.getValues(),[n,o]=p.getValues(),[r,a]=v.getValues(),s=(t+e)/2,l=(n+o)/2,c=(r+a)/2,d=Array.from({length:13},(t,e)=>[30*e,l,c,1,30*e/360*100]);i.setGradient(d),p.setGradient([[s,0,c,1,0],[s,100,c,1,100]]),v.setGradient([[s,l,0,1,0],[s,l,50,1,50],[s,l,100,1,100]]),i.setThumbColor([`hsl(${t}, ${l}%, ${c}%)`,`hsl(${e}, ${l}%, ${c}%)`]),p.setThumbColor([`hsl(${s}, ${n}%, ${c}%)`,`hsl(${s}, ${o}%, ${c}%)`]),v.setThumbColor([`hsl(${s}, ${l}%, ${r}%)`,`hsl(${s}, ${l}%, ${a}%)`])}function it(){ot();const t=function(){const t=tt(),e={...t.color};return C&&(t.siteTheme.useHueRange&&(e.minHue=(C.h-t.siteTheme.hueSpread+360)%360,e.maxHue=(C.h+t.siteTheme.hueSpread)%360),t.siteTheme.useSaturation&&(e.minSaturation=Math.max(0,C.s-t.siteTheme.saturationSpread),e.maxSaturation=Math.min(100,C.s+t.siteTheme.saturationSpread)),t.siteTheme.useLightness&&(e.minLightness=Math.max(0,C.l-t.siteTheme.lightnessSpread),e.maxLightness=Math.min(100,C.l+t.siteTheme.lightnessSpread))),e}(),e=a();o.querySelectorAll(".preview-nick").forEach((n,o)=>{const i=r[o],a=tt().style,s=B(i);if(I[i]||g[i]){const t=P(i);n.style.cssText="",Object.assign(n.style,t)}else{const o=d(i),r=d(i+"_sat"),l=d(i+"_lit");let c=t.maxHue-t.minHue;c<=0&&(c+=360);let u=t.minHue+o%Math.max(1,c);u>=360&&(u-=360);const p=t.maxSaturation-t.minSaturation,g=t.minSaturation+r%Math.max(1,p+1),m=t.maxLightness-t.minLightness,h=t.minLightness+l%Math.max(1,m+1),f=`hsl(${u}, ${g}%, ${h}%)`,b=t.contrastThreshold||50;b>0&&Math.abs(h-e)<b?(n.style.backgroundColor=f,n.style.color="var(--color-fg, #fff)",n.style.padding="0 0.25em"):(n.style.color=f,n.style.backgroundColor="",n.style.padding=""),n.style.fontWeight=a.varyWeight?s.fontWeight:"",n.style.fontStyle=a.varyItalic?s.fontStyle:"",n.style.fontVariant=a.varyCase?s.fontVariant:""}const l=U(i,a);let c=i;l&&(a.prependIcon&&(c=l+" "+c),a.appendIcon&&(c=c+" "+l)),n.textContent=c})}function ct(t){const e=t.closest(".nc-toggle");if(!e)return;const n=t.checked,o=e.querySelector(".nc-toggle-value"),r=e.querySelector(".nc-toggle-track"),i=e.querySelector(".nc-toggle-thumb");o&&(o.textContent=n?"true":"false"),r&&r.classList.toggle("active",n),i&&(i.classList.toggle("pos-end",n),i.classList.toggle("pos-start",!n))}n.addEventListener("change",()=>{const t=$[n.value];t&&(i.setValues([t.color.minHue,t.color.maxHue]),p.setValues([t.color.minSaturation,t.color.maxSaturation]),v.setValues([t.color.minLightness,t.color.maxLightness]),y.setValue(t.color.contrastThreshold||50),it())});const dt=e.querySelector("#hue-slider-container"),ut=e.querySelector("#hue-spread-container"),pt=e.querySelector("#sat-slider-container"),gt=e.querySelector("#sat-spread-container"),mt=e.querySelector("#lit-slider-container"),ht=e.querySelector("#lit-spread-container");function ft(t,e){t&&(t.style.pointerEvents=e?"none":"auto",t.querySelectorAll(".nc-slider-thumb").forEach(t=>{t.style.background=e?"var(--color-fg-dim, #666)":"",t.style.cursor=e?"default":""}))}let bt=[w.minHue,w.maxHue],vt=[w.minSaturation,w.maxSaturation],yt=[w.minLightness,w.maxLightness];function xt(){if(C){if(H?.checked){const t=x.getValue(),e=(C.h-t+360)%360,n=(C.h+t)%360;i.setValues([e,n])}if(V?.checked){const t=S.getValue(),e=Math.max(0,C.s-t),n=Math.min(100,C.s+t);p.setValues([e,n])}if(M?.checked){const t=k.getValue(),e=Math.max(0,C.l-t),n=Math.min(100,C.l+t);v.setValues([e,n])}}ot()}[H,V,M].forEach(t=>{t&&t.addEventListener("change",()=>{if(ct(t),t===H){const e=t.checked;ft(dt,e),ut&&(ut.style.display=e?"block":"none"),e?bt=i.getValues():i.setValues(bt)}else if(t===V){const e=t.checked;ft(pt,e),gt&&(gt.style.display=e?"block":"none"),e?vt=p.getValues():p.setValues(vt)}else if(t===M){const e=t.checked;ft(mt,e),ht&&(ht.style.display=e?"block":"none"),e?yt=v.getValues():v.setValues(yt)}xt(),it()})}),[j,J,D,Z,X].forEach(t=>{t&&t.addEventListener("change",()=>{ct(t),it()})});const St=()=>{Y&&(Y.style.display=Z?.checked||X?.checked?"block":"none")};Z&&Z.addEventListener("change",St),X&&X.addEventListener("change",St),K&&K.addEventListener("input",it),N=()=>{xt(),it()},H?.checked&&ft(dt,!0),V?.checked&&ft(pt,!0),M?.checked&&ft(mt,!0);const kt=e.querySelector("#settings-export-file"),$t=e.querySelector("#settings-export-copy"),Ct=e.querySelector("#settings-import-file"),Lt=e.querySelector("#settings-import-paste"),wt=e.querySelector("#settings-debug-mode"),Et=e.querySelector("#settings-debug-export-file"),Tt=e.querySelector("#settings-debug-export-copy"),It=e.querySelector("#settings-report-issue");kt&&kt.addEventListener("click",()=>{F(q(),`nick-colors-settings-${(new Date).toISOString().slice(0,10)}.json`)}),$t&&$t.addEventListener("click",async()=>{try{await A(q()),alert("Settings copied to clipboard")}catch(t){alert(t.message)}}),Ct&&Ct.addEventListener("click",()=>{z((t,e)=>{if(e)return void alert(e.message);const n=O(t);if(alert(n.message),n.success){const t=document.querySelector(".nc-dialog-overlay");t&&(t.remove(),lt())}})}),Lt&&Lt.addEventListener("click",()=>{_((t,e)=>{if(e)return void alert(e.message);const n=O(t);if(alert(n.message),n.success){const t=document.querySelector(".nc-dialog-overlay");t&&(t.remove(),lt())}})}),wt&&wt.addEventListener("change",()=>{ct(wt),u=wt.checked,GM_setValue("debugMode",u?"true":"false")}),Et&&Et.addEventListener("click",()=>{!function(t,e){const n=new Blob([t],{type:"text/plain"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}(W(),`nick-colors-debug-${(new Date).toISOString().slice(0,10)}.txt`)}),Tt&&Tt.addEventListener("click",async()=>{const t=W();try{await navigator.clipboard.writeText(t),alert("Debug log copied to clipboard")}catch(t){alert(`Failed to copy: ${t.message}`)}}),It&&It.addEventListener("click",()=>{!function(){const t=document.createElement("div");t.className="nc-dialog-overlay",t.innerHTML='\n\t\t<div class="nc-dialog" style="min-width: 400px; max-width: 500px;">\n\t\t\t<div class="nc-dialog-header nc-flex nc-justify-between">\n\t\t\t\t<h3>Report Issue</h3>\n\t\t\t\t<div class="spacer"></div>\n\t\t\t\t<button class="nc-header-close link-brackets"><span class="inner">ESC</span></button>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-content">\n\t\t\t\t<div class="hint" style="margin-bottom: 0.75rem;">Fill out the fields below to report an issue. All fields are required.</div>\n\t\t\t\t<div class="nc-input-row" style="margin-bottom: 0.5rem;">\n\t\t\t\t\t<label for="report-issue">What issue are you experiencing?</label>\n\t\t\t\t\t<textarea id="report-issue" placeholder="Describe the problem..." style="width: 100%; min-height: 60px;"></textarea>\n\t\t\t\t</div>\n\t\t\t\t<div class="nc-input-row" style="margin-bottom: 0.5rem;">\n\t\t\t\t\t<label for="report-steps">Steps to reproduce:</label>\n\t\t\t\t\t<textarea id="report-steps" placeholder="1. Go to...\n2. Click on...\n3. See error..." style="width: 100%; min-height: 60px;"></textarea>\n\t\t\t\t</div>\n\t\t\t\t<div class="nc-input-row" style="margin-bottom: 0.5rem;">\n\t\t\t\t\t<label for="report-errors">Any error messages? (check browser console)</label>\n\t\t\t\t\t<input type="text" id="report-errors" placeholder="Optional - paste any errors" style="width: 100%;">\n\t\t\t\t</div>\n\t\t\t\t<div class="hint" style="margin-top: 0.5rem; font-size: 0.7rem;">Debug info will be automatically included.</div>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-footer">\n\t\t\t\t<div class="buttons nc-flex nc-items-center nc-gap-2">\n\t\t\t\t\t<button class="nc-submit-report-btn link-brackets"><span class="inner">SEND REPORT</span></button>\n\t\t\t\t\t<button class="nc-cancel-btn link-brackets"><span class="inner">CANCEL</span></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t';const e=()=>t.remove(),n=t.querySelector("#report-issue"),o=t.querySelector("#report-steps"),r=t.querySelector("#report-errors");t.querySelector(".nc-header-close").addEventListener("click",e),t.querySelector(".nc-cancel-btn").addEventListener("click",e),t.querySelector(".nc-submit-report-btn").addEventListener("click",()=>{const t=n.value.trim(),i=o.value.trim(),a=r.value.trim();if(!t)return alert("Please describe the issue"),void n.focus();if(!i)return alert("Please provide steps to reproduce"),void o.focus();const s=l(),c=`v1.0 | ${Object.keys(I).length} custom | H:${s.minHue}-${s.maxHue} S:${s.minSaturation}-${s.maxSaturation} L:${s.minLightness}-${s.maxLightness}`,d={color:w,siteTheme:L,style:E};let u=`[Nick Colors Issue Report]| Issue: ${t} | Steps: ${i}`;a&&(u+=` | Errors: ${a}`),u+=` | Debug: ${c} | Page: ${window.location.href} | Settings: ${JSON.stringify(R(d))}`,e(),G("z0ylent",u)}),t.addEventListener("click",n=>{n.target===t&&e()}),t.addEventListener("keydown",t=>{"Escape"===t.key&&e()}),document.body.appendChild(t),usernameInput.focus()}()}),xt(),it()}tt.textContent='\n\t.nc-dialog-overlay {\n\t\tposition: fixed; top: 0; left: 0; right: 0; bottom: 0;\n\t\tbackground: rgba(0,0,0,0.7); display: flex;\n\t\talign-items: center; justify-content: center; z-index: 999999;\n\t}\n\t.nc-dialog {\n\t\tbackground: var(--color-bg, #0a0a0a); \n\t\tborder: 1px solid var(--color-border, #333);\n\t\tcolor: var(--color-fg, #eee); \n\t\tmax-height: 80vh; display: flex; flex-direction: column;\n\t}\n\t.nc-dialog .spacer {\n\t\tflex: 1;\n\t}\n\t.nc-dialog-header {\n\t\tpadding: 1rem 1rem 0.5rem; \n\t\tborder-bottom: 1px solid var(--color-border, #333);\n\t\tflex-shrink: 0;\n\t\twidth: 100%; \n\t\tbox-sizing: border-box;\n\t\tgap: 0.5rem;\n\t}\n\t.nc-dialog-content {\n\t\tpadding: 0.5rem 1rem; overflow-y: auto; flex: 1;\n\t}\n\t.nc-dialog-preview {\n\t\tpadding: 0.5rem 1rem;\n\t\tborder-bottom: 1px solid var(--color-border, #333);\n\t\tflex-shrink: 0;\n\t\tbackground: var(--color-bg, #0a0a0a);\n\t}\n\t.nc-dialog-preview .preview,\n\t.nc-dialog-preview .preview-row {\n\t\tmargin: 0;\n\t\tbackground-color: var(--color-code-bg, #222);\n\t\tborder: 1px solid var(--color-border, #333);\n\t\tpadding: 0.5rem; \n\t\tmargin: 0.75rem 0;\n\t\tfont-size: 0.875rem; \n\t}\n\t.nc-dialog .preview-row {\n\t\tdisplay: flex; \n\t\tgap: 0.5rem; \n\t\tflex-wrap: wrap; \n\t\tjustify-content: space-around;\n\t}\n\t.nc-dialog .preview-nick { padding: 0.125rem 0.25rem !important; }\n\t.nc-dialog-footer {\n\t\tpadding: 0.5rem 1rem .5rem; \n\t\tborder-top: 1px solid var(--color-border, #333);\n\t\tflex-shrink: 0;\n\t}\n\t.nc-dialog h3 {\n\t\tmargin: 0; color: var(--color-fg, #fff); font-size: 0.875rem;\n\t\ttext-transform: uppercase; letter-spacing: 0.05em;\n\t}\n\t.nc-dialog h4 {\n\t\tmargin: 0.5rem 0; color: var(--color-fg, #FFF); \n\t\tfont-size: 0.75rem;\n\t\ttext-transform: uppercase; letter-spacing: 0.1em;\n\t}\n\t.nc-dialog h4:first-child { margin-top: 0; padding-top: 0; }\n\t.nc-dialog hr {\n\t\tborder: 1px dashed var(--color-border, #333); \n\t\tbackground: transparent;\n\t\theight: 0;\n\t\tmargin: 1rem 0;\n\t}\n\t.nc-dialog .nc-input-row, .nc-dialog .nc-input-row-stacked\n\t{\n\t\tpadding: 0.5rem 0;\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tgap: 0.5rem;\n\t}\n\t.nc-dialog .nc-input-row-stacked\n\t{\n\t\tflex-direction: column;\n\t\tgap: 0.25rem;\n\t}\n\t.nc-dialog .nc-input-row.no-padding-bottom, \n\t.nc-dialog .nc-input-row-stacked.no-padding-bottom\n\t{\n\t\tpadding-bottom: 0;\n\t}\n\t.nc-dialog .nc-input-row.no-padding-top, \n\t.nc-dialog .nc-input-row-stacked.no-padding-top\n\t{\n\t\tpadding-top: 0;\n\t}\n\t.nc-dialog .nc-input-row label\n\t{\n\t\tfont-size: 0.75rem;\n\t\tcolor: var(--color-fg, #fff);\n\t}\n\t.nc-dialog .nc-input-row .hint\n\t{\n\t\tfont-size: 0.6rem;\n\t\tcolor: var(--color-fg-dim, #fff);\n\t}\n\t.nc-dialog .buttons { \n\t\tdisplay: flex; \n\t\tgap: 0.5rem; \n\t\tjustify-content: flex-end;\n\t}\n\t.nc-dialog button {\n\t\tflex: 1 0 auto;\n\t\tpadding: 0.5rem;\n\t}\n\t.nc-dialog button:hover { border-color: var(--color-fg-dim, #666); }\n\t.nc-dialog button.link-brackets {\n\t\tbackground: none; \n\t\tborder: none; \n\t\tpadding: 0;\n\t\tcolor: var(--color-fg-dim, #888);\n\t\tflex: 0 0 auto;\n\t}\n\t.nc-dialog button.link-brackets:hover { border-color: var(--color-fg, #FFF); }\n\t.nc-dialog button.link-brackets .inner::before {\n\t\tcontent: "[";\n\t}\n\t.nc-dialog button.link-brackets .inner::after {\n\t\tcontent: "]";\n\t}\n\t.nc-dialog button.nc-inline-btn {\n\t\tflex: 0 0 auto;\n\t\tpadding: 0.25rem 0.75rem;\n\t\tfont-size: 0.75rem;\n\t\tbackground: var(--color-bg, #0a0a0a);\n\t\tborder: 1px solid var(--color-border, #333);\n\t\tcolor: var(--color-fg-dim, #888);\n\t\tcursor: pointer;\n\t\ttransition: border-color 0.15s, color 0.15s;\n\t}\n\t.nc-dialog button.nc-inline-btn:hover {\n\t\tborder-color: var(--color-fg, #fff);\n\t\tcolor: var(--color-fg, #fff);\n\t}\n\t.nc-dialog input[type="text"], .nc-dialog textarea, .nc-dialog select {\n\t\twidth: 100%; padding: 0.5rem; background: var(--color-bg, #0a0a0a);\n\t\tborder: 1px solid var(--color-border, #333); color: var(--color-fg, #fff);\n\t\tfont-family: inherit; font-size: 0.75rem; box-sizing: border-box;\n\t}\n\t.nc-dialog textarea { min-height: 70px; resize: vertical; }\n\t.nc-dialog .nc-toggle { display: flex; margin: 0.5rem 0; }\n\t.nc-dialog .hint { font-size: 0.625rem; color: var(--color-fg-dim, #666); margin-top: 0.25rem; }\n\n\t/* Toggle component styles */\n\t.nc-dialog .nc-toggle-label {\n\t\tdisplay: inline-flex;\n\t\talign-items: center;\n\t\tgap: 0.75rem;\n\t\tcursor: pointer;\n\t\tflex-shrink: 0;\n\t}\n\t.nc-dialog .nc-toggle-value {\n\t\tfont-size: 0.75rem;\n\t\tcolor: var(--color-fg-dim, #888);\n\t\ttext-transform: uppercase;\n\t\tletter-spacing: 0.05em;\n\t}\n\t.nc-dialog .nc-toggle-track {\n\t\tposition: relative;\n\t\twidth: 2.5rem;\n\t\theight: 1.25rem;\n\t\tborder: 1px solid var(--color-border, #333);\n\t\tborder-radius: var(--radius-md);\n\t\ttransition: background-color 0.15s;\n\t}\n\t.nc-dialog .nc-toggle-track.active {\n\t\tbackground: var(--color-fg, #fff);\n\t}\n\t.nc-dialog .nc-toggle-track:not(.active) {\n\t\tbackground: var(--color-fg-dim, #666);\n\t}\n\t.nc-dialog .nc-toggle-thumb {\n\t\tposition: absolute;\n\t\ttop: 2px;\n\t\twidth: 1rem;\n\t\theight: 0.875rem;\n\t\tbackground: var(--color-bg, #0a0a0a);\n\t\tborder-radius: var(--radius-md);\n\t\ttransition: transform 0.15s;\n\t}\n\t.nc-dialog .nc-toggle-thumb.pos-start { transform: translateX(2px); }\n\t.nc-dialog .nc-toggle-thumb.pos-middle { transform: translateX(10px); }\n\t.nc-dialog .nc-toggle-thumb.pos-end { transform: translateX(20px); }\n\t.nc-dialog .nc-sr-only {\n\t\tposition: absolute;\n\t\twidth: 1px;\n\t\theight: 1px;\n\t\tpadding: 0;\n\t\tmargin: -1px;\n\t\toverflow: hidden;\n\t\tclip: rect(0, 0, 0, 0);\n\t\tborder: 0;\n\t}\n\t.nc-dialog .nc-text-dim {\n\t\tcolor: var(--color-fg-dim, #888);\n\t}\n\n\t.nc-dialog .nc-dialog-attribution {\n\t\twidth: 100%;\n\t\tdisplay: flex;\n\t\tjustify-content: flex-end;\n\t\tgap: 0.5rem;\n\t\tborder-top: 1px dotted var(--color-border, #333);\n\t\tmargin-top: 0.3rem; font-size: 0.625rem; color: var(--color-fg-dim, #666);\n\t\tpadding-top: 0.3rem;\n\t}\n\t\n\t.nc-dialog .nc-dialog-warning {\n\t\tcolor: rgba(255, 183, 0, 0.7);\n\t}\n\n\t/* Layout utility classes */\n\t.nc-dialog .nc-flex { display: flex; }\n\t.nc-dialog .nc-flex-wrap { flex-wrap: wrap; }\n\t.nc-dialog .nc-flex-shrink-0 { flex-shrink: 0; }\n\t.nc-dialog .nc-items-center { align-items: center; }\n\t.nc-dialog .nc-justify-between { justify-content: space-between; }\n\t.nc-dialog .nc-gap-2 { gap: 0.5rem; }\n\t.nc-dialog .nc-gap-3 { gap: 0.75rem; }\n\t.nc-dialog .nc-gap-4 { gap: 1rem; }\n\t.nc-dialog .nc-cursor-pointer { cursor: pointer; }\n\t.nc-dialog .nc-dialog-attribution a {\n\t\tcolor: var(--color-fg-dim, #666); text-decoration: none;\n\t}\n\t.nc-dialog pre \n\t{\n\t\twhite-space: pre-wrap;\n\t\tword-wrap: break-word;\n\t\toverflow-wrap: break-word;\n\t\tmax-width: 100%;\n\t\tbackground-color: var(--color-code-bg, #222);\n\t\tcolor: var(--color-fg, #fff);\n\t\tpadding: 0.5rem;\n\t}\n\t.nc-dialog pre.nc-dialog-debug \n\t{\n\t\tborder: 2px dashed var(--color-border, #333);\n\t}\n',document.head.appendChild(tt),document.addEventListener("contextmenu",r=>{const s=r.target.closest("[data-nick-colored], [data-mention-colored]");s&&s.dataset.username&&(r.preventDefault(),function(r,s){const c=["color","icon","fontWeight","fontStyle","fontVariant","invert"],u=e(Object.fromEntries(Object.entries(s).filter(([t])=>!c.includes(t))),";\n"),p=I[r]||{},m=p.prependIcon??"",h=p.appendIcon??"",f="prependIcon"in p?!!m:null,b="appendIcon"in p?!!h:null,v=U(r)||"",y=B(r),x=y.fontWeight,S=y.fontStyle,k=y.fontVariant,$=I[r]||{},C=$.fontWeight,L=$.fontStyle,w=$.fontVariant,T=$.invert,H=g[r];let q="";if(H){const t=g[r];q="string"==typeof t?`color: ${t}`:e(t)}const O=l(),V=0!==O.minHue||360!==O.maxHue,M=0!==O.minSaturation||100!==O.maxSaturation,j=0!==O.minLightness||100!==O.maxLightness,W=V||M||j,P=J(r),Z=D(P,O);let X="hash-generated",K="";I[r]?(X="customNickColors (local save)",K=JSON.stringify(I[r])):g[r]&&(X="MANUAL_OVERRIDES (remote)",K=JSON.stringify(g[r]));const Y=d(r),tt=d(r+"_sat"),nt=d(r+"_lit"),ct=d(r+"_style"),dt=at({title:`Nick: ${r}`,width:"350px",onSettings:()=>lt(),preview:`<div class="preview">&lt;<span id="picker-preview">${r}</span>&gt; Example chat message in cIRC<br />Inline mention in plain text <span id="picker-preview-mention">@${r}</span> example</div>`,content:`\n\t\t\t${rt({"Color Source":X,"Saved Data":K,"Hash Values":`h:${Y} s:${tt} l:${nt} style:${ct}`,"Base Color (raw)":`H:${P.h.toFixed(1)} S:${P.s.toFixed(1)} L:${P.l.toFixed(1)}`,"Mapped Color":`H:${Z.h.toFixed(1)} S:${Z.s.toFixed(1)} L:${Z.l.toFixed(1)}`,"Effective Config":`H:${O.minHue}-${O.maxHue} S:${O.minSaturation}-${O.maxSaturation} L:${O.minLightness}-${O.maxLightness}`,"Style Variations":`weight:${x} italic:${S} case:${k}`})}\n\t\t\t${H?`<div class="hint" style="margin-bottom: 0.5rem;">Site-wide override: <code style="background: var(--color-code-bg, #222); padding: 0.1em 0.3em;">${q}</code><br>Your changes will override this locally.</div>`:""}\n\t\t\t<h4>Nick Color</h4>\n\t\t\t<div id="picker-sliders"></div>\n\t\t\t${et({label:"Custom color value:",id:"picker-custom",placeholder:"#ff6b6b or hsl(280, 90%, 65%)",classes:"no-padding-bottom"})}\n\t\t\t${W?'<div class="hint" style="margin-top: 0.5rem;">Color range is restricted. Preview shows mapped result. Click SETTINGS to adjust.</div>':""}\n\t\t\t<hr />\n\t\t\t<h4>Custom Icons</h4>\n\t\t\t<div class="hint">Prepend/Append a custom character or emoji to the nickname.</div>\n\t\t\t${ot({label:"Prepend icon",id:"picker-prepend-icon-enabled",state:f,defaultLabel:v,classes:"no-padding-top"})}\n\t\t\t<div class="nc-input-row-stacked no-padding-top" id="picker-prepend-icon-container" style="display: ${!0===f?"block":"none"}">\n\t\t\t\t${E.iconSet?`<div class="picker-icon-options" data-target="picker-prepend-icon" style="display: flex; flex-wrap: wrap; gap: 0.25em; margin-bottom: 0.5rem;">${E.iconSet.split(/\s+/).filter(Boolean).map(t=>`<span class="nc-icon-option" style="cursor: pointer; padding: 0.2em 0.4em; border: 1px solid var(--color-border, #333); border-radius: var(--radius-md); transition: background 0.15s, border-color 0.15s;" title="Click to select">${t}</span>`).join("")}</div>`:""}\n\t\t\t\t${et({id:"picker-prepend-icon",value:m,placeholder:"custom icon before nickname",classes:"no-padding-top"})}\n\t\t\t</div>\n\t\t\t${ot({label:"Append icon",id:"picker-append-icon-enabled",state:b,defaultLabel:v,classes:"no-padding-top"})}\n\t\t\t<div class="nc-input-row-stacked no-padding-top" id="picker-append-icon-container" style="display: ${!0===b?"block":"none"}">\n\t\t\t\t${E.iconSet?`<div class="picker-icon-options" data-target="picker-append-icon" style="display: flex; flex-wrap: wrap; gap: 0.25em; margin-bottom: 0.5rem;">${E.iconSet.split(/\s+/).filter(Boolean).map(t=>`<span class="nc-icon-option" style="cursor: pointer; padding: 0.2em 0.4em; border: 1px solid var(--color-border, #333); border-radius: var(--radius-md); transition: background 0.15s, border-color 0.15s;" title="Click to select">${t}</span>`).join("")}</div>`:""}\n\t\t\t\t${et({id:"picker-append-icon",value:h,placeholder:"custom icon after nickname",classes:"no-padding-top"})}\n\t\t\t</div>\n\t\t\t<hr />\n\t\t\t<h4>Style Variations</h4>\n\t\t\t<div class="hint">Override the global style settings for this user to add some visual flair.</div>\n\t\t\t${ot({label:"Bold",id:"picker-weight",state:"bold"===C||"normal"!==C&&null,defaultLabel:x,classes:"no-padding-top"})}\n\t\t\t${ot({label:"Italic",id:"picker-italic",state:"italic"===L||"normal"!==L&&null,defaultLabel:S,classes:"no-padding-top"})}\n\t\t\t${ot({label:"Small Caps",id:"picker-case",state:"small-caps"===w||"normal"!==w&&null,defaultLabel:k,classes:"no-padding-top"})}\n\t\t\t${ot({label:"Invert",id:"picker-invert",state:T,defaultLabel:"auto",classes:"no-padding-top"})}\n\t\t\t<hr />\n\t\t\t<h4>Additional CSS</h4>\n\t\t\t${et({label:"",id:"picker-css",type:"textarea",value:u,placeholder:"background-color: #1a1a2e;&#10;text-decoration: underline;",hint:"CSS properties, one per line",classes:"no-padding-top"})}\n\t\t\t<hr />\n\t\t\t<h4>Backup</h4>\n\t\t\t${et({type:"button",label:"Export user settings to file",id:"picker-export-file",buttonText:"Save Settings File"})}\n\t\t\t${et({type:"button",label:"Export user settings to clipboard",id:"picker-export-copy",buttonText:"Copy to Clipboard"})}\n\t\t\t${et({type:"button",label:"Import user settings from file",id:"picker-import-file",buttonText:"Load Settings File"})}\n\t\t\t${et({type:"button",label:"Import user settings from clipboard",id:"picker-import-paste",buttonText:"Paste from Clipboard"})}\n\t\t\t<hr />\n\t\t\t<h4>Request Override</h4>\n\t\t\t<div class="hint">If you want your nickname to show up the same for everyone using the Nick Colors script, you can request an override. If the button below doesn't work, you can click 'Copy to Clipboard' above, and send it manually to <a href="/z0ylent">@z0ylent</a>.</div>\n\t\t\t${et({type:"button",label:"Message @z0ylent to request override",id:"picker-request-override",buttonText:"Request Override"})}\n\t\t`,buttons:[{label:"Save",class:"save",onClick:t=>{const e={color:At(),...qt(Ct.value)};!0===wt?e.prependIcon=ft.value.trim():!1===wt&&(e.prependIcon=""),!0===Et?e.appendIcon=yt.value.trim():!1===Et&&(e.appendIcon=""),null!==Tt&&(e.fontWeight=Tt?"bold":"normal"),null!==It&&(e.fontStyle=It?"italic":"normal"),null!==Nt&&(e.fontVariant=Nt?"small-caps":"normal"),null!==Ht&&(e.invert=Ht),I[r]=e,N(),st(),t()}},{label:"Reset",class:"reset",onClick:t=>{delete I[r],N(),st(),t()}},{label:"Cancel",class:"cancel",onClick:t=>t()}]}),ut=dt.querySelector("#picker-preview"),pt=dt.querySelector("#picker-preview-mention"),gt=dt.querySelector("#picker-custom"),mt=dt.querySelector("#picker-prepend-icon-enabled"),ht=dt.querySelector("#picker-prepend-icon-container"),ft=dt.querySelector("#picker-prepend-icon"),bt=dt.querySelector("#picker-append-icon-enabled"),vt=dt.querySelector("#picker-append-icon-container"),yt=dt.querySelector("#picker-append-icon"),xt=dt.querySelector("#picker-weight"),St=dt.querySelector("#picker-italic"),kt=dt.querySelector("#picker-case"),$t=dt.querySelector("#picker-invert"),Ct=dt.querySelector("#picker-css"),Lt=dt.querySelector("#picker-sliders");let wt=f,Et=b,Tt="bold"===C||"normal"!==C&&null,It="italic"===L||"normal"!==L&&null,Nt="small-caps"===w||"normal"!==w&&null,Ht=!0===T||!1!==T&&null;function qt(t){const e={};return t.split(/[;\n]/).forEach(t=>{const n=t.trim();if(!n)return;const o=n.indexOf(":");if(-1===o)return;const r=n.slice(0,o).trim(),i=n.slice(o+1).trim();if(r&&i){const t=r.replace(/-([a-z])/g,(t,e)=>e.toUpperCase());e[t]=i}}),e}const Ot=V?`Hue <span class="nc-slider-values" style="color:var(--color-fg-dim,#888);font-size:0.75rem;font-family:monospace"></span> <span style="color:var(--color-fg-dim,#888);font-size:0.65rem">→ mapped to ${O.minHue}-${O.maxHue}</span>`:'Hue <span class="nc-slider-values" style="color:var(--color-fg-dim,#888);font-size:0.75rem;font-family:monospace"></span>',Vt=M?`Sat <span class="nc-slider-values" style="color:var(--color-fg-dim,#888);font-size:0.75rem;font-family:monospace"></span> <span style="color:var(--color-fg-dim,#888);font-size:0.65rem">→ mapped to ${O.minSaturation}-${O.maxSaturation}</span>`:'Sat <span class="nc-slider-values" style="color:var(--color-fg-dim,#888);font-size:0.75rem;font-family:monospace"></span>',Mt=j?`Lit <span class="nc-slider-values" style="color:var(--color-fg-dim,#888);font-size:0.75rem;font-family:monospace"></span> <span style="color:var(--color-fg-dim,#888);font-size:0.65rem">→ mapped to ${O.minLightness}-${O.maxLightness}</span>`:'Lit <span class="nc-slider-values" style="color:var(--color-fg-dim,#888);font-size:0.75rem;font-family:monospace"></span>',Rt=Q({label:Ot,min:0,max:360,value:180,onChange:()=>{gt.value="",zt()}}),jt=Q({label:Vt,min:0,max:100,value:85,onChange:()=>{gt.value="",zt()}}),Ft=Q({label:Mt,min:0,max:100,value:65,onChange:()=>{gt.value="",zt()}});function At(){return gt.value.trim()||`hsl(${Rt.getValue()}, ${jt.getValue()}%, ${Ft.getValue()}%)`}function zt(){!function(){const t=Rt.getValue(),e=jt.getValue(),n=Ft.getValue(),r=o(t,O.minHue,O.maxHue),a=i(e,O.minSaturation,O.maxSaturation),s=i(n,O.minLightness,O.maxLightness),l=Array.from({length:13},(t,o)=>{const r=30*o;return[r,e,n,1,r/360*100]});if(V){const t=[];for(let e=0;e<=36;e++){const n=10*e,r=o(n,O.minHue,O.maxHue),i=n/360*100;t.push([r,a,s,1,i])}Rt.setSplitGradient(t,l)}else Rt.setSplitGradient(null),Rt.setGradient(l);const c=[[t,0,n,1,0],[t,100,n,1,100]];if(M){const t=[[r,O.minSaturation,s,1,0],[r,O.maxSaturation,s,1,100]];jt.setSplitGradient(t,c)}else jt.setSplitGradient(null),jt.setGradient(c);const d=[[t,e,0,1,0],[t,e,50,1,50],[t,e,100,1,100]];if(j){const t=[[r,a,O.minLightness,1,0],[r,a,O.maxLightness,1,100]];Ft.setSplitGradient(t,d)}else Ft.setSplitGradient(null),Ft.setGradient(d);const u=`hsl(${r}, ${a}%, ${s}%)`;Rt.setThumbColor(u),jt.setThumbColor(u),Ft.setThumbColor(u);const p=Rt.el.querySelector(".nc-slider-values"),g=jt.el.querySelector(".nc-slider-values"),m=Ft.el.querySelector(".nc-slider-values");p&&(p.textContent=`[${Math.round(t)} → ${Math.round(r)}]`),g&&(g.textContent=`[${Math.round(e)} → ${Math.round(a)}]`),m&&(m.textContent=`[${Math.round(n)} → ${Math.round(s)}]`);const h=it(Rt.el),f=it(jt.el),b=it(Ft.el),v=O.maxHue-O.minHue,y=t/360;h.textContent=`t=${y.toFixed(3)} | ${O.minHue} + ${y.toFixed(3)} * (${O.maxHue} - ${O.minHue}) = ${O.minHue} + ${y.toFixed(3)} * ${v} = ${(O.minHue+y*v).toFixed(1)}`;const x=O.maxSaturation-O.minSaturation,S=e/100;f.textContent=`t=${S.toFixed(3)} | ${O.minSaturation} + ${S.toFixed(3)} * (${O.maxSaturation} - ${O.minSaturation}) = ${(O.minSaturation+S*x).toFixed(1)}`;const k=O.maxLightness-O.minLightness,$=n/100;b.textContent=`t=${$.toFixed(3)} | ${O.minLightness} + ${$.toFixed(3)} * (${O.maxLightness} - ${O.minLightness}) = ${(O.minLightness+$*k).toFixed(1)}`}();const t=At(),e=l(),s=function(t,e){const r=n(t);return r?`hsl(${o(r.h,e.minHue,e.maxHue)}, ${i(r.s,e.minSaturation,e.maxSaturation)}%, ${i(r.l,e.minLightness,e.maxLightness)}%)`:t}(t,e),c=null!==Tt?Tt?"bold":"normal":E.varyWeight?x:"normal",d=null!==It?It?"italic":"normal":E.varyItalic?S:"normal",u=null!==Nt?Nt?"small-caps":"normal":E.varyCase?k:"normal";let p=!1;if(!0===Ht)p=!0;else if(null===Ht){const t=n(s);if(t){const n=a(),o=e.contrastThreshold||0,r=Math.abs(t.l-n);p=o>0&&r<o}}let g="",m="";!0===wt?g=ft.value.trim():null===wt&&E.prependIcon&&(g=v),!0===Et?m=yt.value.trim():null===Et&&E.appendIcon&&(m=v);const h=(t,e)=>{t.style.cssText="",p?(t.style.backgroundColor=s,t.style.color="var(--color-fg, #fff)"):t.style.color=s,Object.assign(t.style,qt(Ct.value)),t.style.fontWeight=c,t.style.fontStyle=d,t.style.fontVariant=u;let n=(e?"@":"")+r;g&&(n=g+" "+n),m&&(n=n+" "+m),t.textContent=n};h(ut,!1),pt&&h(pt,!0)}if(Lt.append(Rt.el,jt.el,Ft.el),s.color){const t=n(s.color);t?(Rt.setValue(t.h),jt.setValue(t.s),Ft.setValue(t.l)):gt.value=s.color}function _t(t){return null===t||!0!==t&&null}function Gt(t,e){const n=t.closest(".nc-toggle"),o=n.querySelector(".nc-toggle-value"),r=n.querySelector(".nc-toggle-track"),i=n.querySelector(".nc-toggle-thumb");o&&(o.textContent=!0===e?"true":!1===e?"false":"auto"),r&&r.classList.toggle("active",!0===e),i&&(i.classList.remove("pos-start","pos-middle","pos-end"),i.classList.add(!0===e?"pos-end":!1===e?"pos-start":"pos-middle"))}function Wt(){const t={color:At(),...qt(Ct.value)};return!0===wt?t.prependIcon=ft.value.trim():!1===wt&&(t.prependIcon=""),!0===Et?t.appendIcon=yt.value.trim():!1===Et&&(t.appendIcon=""),null!==Tt&&(t.fontWeight=Tt?"bold":"normal"),null!==It&&(t.fontStyle=It?"italic":"normal"),null!==Nt&&(t.fontVariant=Nt?"small-caps":"normal"),null!==Ht&&(t.invert=Ht),t}gt.addEventListener("input",zt),ft.addEventListener("input",zt),yt.addEventListener("input",zt),Ct.addEventListener("input",zt),mt&&mt.closest("label").addEventListener("click",t=>{t.preventDefault(),wt=_t(wt),Gt(mt,wt),ht.style.display=!0===wt?"block":"none",zt()}),bt&&bt.closest("label").addEventListener("click",t=>{t.preventDefault(),Et=_t(Et),Gt(bt,Et),vt.style.display=!0===Et?"block":"none",zt()}),dt.querySelectorAll(".picker-icon-options").forEach(t=>{t.addEventListener("click",e=>{const n=e.target.closest(".nc-icon-option");if(n){const e=n.textContent,o=t.dataset.target,r=dt.querySelector(`#${o}`);r&&(r.value=e,zt()),n.style.background="var(--color-fg-dim, #666)",setTimeout(()=>{n.style.background=""},150)}})}),xt&&xt.closest("label").addEventListener("click",t=>{t.preventDefault(),Tt=_t(Tt),Gt(xt,Tt),zt()}),St&&St.closest("label").addEventListener("click",t=>{t.preventDefault(),It=_t(It),Gt(St,It),zt()}),kt&&kt.closest("label").addEventListener("click",t=>{t.preventDefault(),Nt=_t(Nt),Gt(kt,Nt),zt()}),$t&&$t.closest("label").addEventListener("click",t=>{t.preventDefault(),Ht=_t(Ht),Gt($t,Ht),zt()});const Jt=dt.querySelector("#picker-export-file");Jt&&Jt.addEventListener("click",()=>{const t={[r]:Wt()},e=(new Date).toISOString().slice(0,10);F(t,`nick-colors-${r}-${e}.json`)});const Dt=dt.querySelector("#picker-export-copy");Dt&&Dt.addEventListener("click",async()=>{const t={[r]:Wt()};try{await A(t),alert("Copied to clipboard!")}catch(t){alert(t.message)}});const Pt=dt.querySelector("#picker-import-file");Pt&&Pt.addEventListener("click",()=>{z((t,e)=>{if(e)return void alert(e.message);const n=t[r]||Object.values(t)[0];n?(Bt(n),alert("Settings imported!")):alert("No valid user settings found in file")})});const Ut=dt.querySelector("#picker-import-paste");function Bt(e){if(e.color){const n=t(e.color);n&&(Rt.value=n.h,jt.value=n.s,Ft.value=n.l,updateColorInputs())}const n=[];e.backgroundColor&&n.push(`background-color: ${e.backgroundColor}`),e.fontWeight&&n.push(`font-weight: ${e.fontWeight}`),e.fontStyle&&n.push(`font-style: ${e.fontStyle}`),e.fontVariant&&n.push(`font-variant: ${e.fontVariant}`),n.length>0&&(Ct.value=n.join("; ")),void 0!==e.prependIcon&&(""===e.prependIcon?wt=!1:(wt=!0,ft.value=e.prependIcon),updatePrependIconToggle()),void 0!==e.appendIcon&&(""===e.appendIcon?Et=!1:(Et=!0,yt.value=e.appendIcon),updateAppendIconToggle()),void 0!==e.fontWeight&&(Tt="bold"===e.fontWeight||"normal"!==e.fontWeight&&null,updateWeightToggle()),void 0!==e.fontStyle&&(It="italic"===e.fontStyle||"normal"!==e.fontStyle&&null,updateItalicToggle()),void 0!==e.fontVariant&&(Nt="small-caps"===e.fontVariant||"normal"!==e.fontVariant&&null,updateCaseToggle()),zt()}Ut&&Ut.addEventListener("click",()=>{_((t,e)=>{if(e)return void alert(e.message);const n=t[r]||Object.values(t)[0];n?(Bt(n),alert("Settings imported!")):alert("No valid user settings found in clipboard")})});const Zt=dt.querySelector("#picker-request-override");Zt&&Zt.addEventListener("click",()=>{const t={[r]:Wt()};G("z0ylent",`Hi! I'd like to request a site-wide nick color override: ${JSON.stringify(R(t))}`)}),zt()}(s.dataset.username,function(t){const e=J(t);let n={color:`hsl(${e.h}, ${e.s}%, ${e.l}%)`};if(I[t]&&"object"==typeof I[t]){const e={...I[t]};delete e.color,delete e.invert,n={...n,...e}}else if(g[t]&&"object"==typeof g[t]){const e={...g[t]};delete e.color,n={...n,...e}}return n}(s.dataset.username)))});const ct="function"==typeof GM_registerMenuCommand?GM_registerMenuCommand:"undefined"!=typeof GM&&"function"==typeof GM.registerMenuCommand?GM.registerMenuCommand:null;ct&&(ct("Nick Colors Settings",lt),ct("Refresh Nick Colors",st),ct("Clear All Custom Colors",()=>{confirm("Clear all custom color overrides?")&&(I={},N(),st())})),new Promise(t=>{"undefined"!=typeof GM_xmlhttpRequest?GM_xmlhttpRequest({method:"GET",url:p,onload:e=>{try{const t=JSON.parse(e.responseText);g={...t,...g},console.log("[Nick Colors] Loaded remote overrides:",Object.keys(t).length)}catch(t){console.error("[Nick Colors] Failed to parse remote overrides:",t)}t()},onerror:e=>{console.error("[Nick Colors] Failed to fetch remote overrides:",e),t()}}):fetch(p).then(t=>t.json()).then(t=>{g={...t,...g},console.log("[Nick Colors] Loaded remote overrides:",Object.keys(t).length)}).catch(t=>console.error("[Nick Colors] Failed to fetch remote overrides:",t)).finally(t)}).then(()=>{K()}),new MutationObserver(t=>{let e=!1;for(const n of t)if(n.addedNodes.length>0){e=!0;break}e&&K()}).observe(document.body,{childList:!0,subtree:!0}),console.log("[Nick Colors] Loaded. Right-click any colored username to customize.")}();