// ==UserScript==
// @name         Cyberspace Nick Colors
// @author       https://z0m.bi/ (@z0ylent)
// @namespace    https://cyberspace.online/
// @version      1.2.0
// @description  Consistent bright colors for usernames across the site
// @match        https://cyberspace.online/*
// @updateURL    https://github.com/z0mbieparade/cyberspace-nick-colors/raw/refs/heads/main/cyberspace-nick-colors.user.js
// @downloadURL  https://github.com/z0mbieparade/cyberspace-nick-colors/raw/refs/heads/main/cyberspace-nick-colors.user.js
// @grant        GM_registerMenuCommand
// @grant        GM.registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @connect      raw.githubusercontent.com
// @connect      gist.githubusercontent.com
// @run-at       document-idle
// ==/UserScript==

!function(){"use strict";const e="1.2.0",t=document.createElement("style");t.id="nc-styles",t.textContent='.nc-dialog-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:999999}.nc-dialog{background:var(--nc-bg);border:1px solid var(--nc-border);color:var(--nc-fg);max-height:80vh;display:flex;flex-direction:column}.nc-dialog ::-webkit-scrollbar-track{background:var(--nc-code-bg);border-radius:0px;border:none}.nc-dialog ::-webkit-scrollbar-thumb{background:var(--nc-bg);opacity:.5;border-radius:0px;border:none;box-shadow:none}.nc-dialog ::-webkit-scrollbar-thumb:hover{opacity:.75}.nc-dialog ::-webkit-scrollbar-thumb:active{opacity:1}.nc-dialog ::-webkit-scrollbar-corner{background:var(--nc-bg)}.nc-dialog ::-webkit-scrollbar-button{background:var(--nc-bg)}.nc-dialog *{scrollbar-width:auto;scrollbar-color:var(--nc-bg) var(--nc-code-bg)}.nc-dialog .spacer{flex:1}.nc-dialog h3{margin:0;color:var(--nc-fg);font-size:var(--font-size-base, 1rem);text-transform:uppercase;letter-spacing:.05em}.nc-dialog h4{margin:var(--spacing-xs) 0;color:var(--nc-fg);font-size:var(--font-size-base, 1rem);text-transform:uppercase;letter-spacing:.1em}.nc-dialog h4:first-child{margin-top:0;padding-top:0}.nc-dialog hr{border:1px dashed var(--nc-border);background:rgba(0,0,0,0);height:0;margin:1rem 0}.nc-dialog .nc-input-row,.nc-dialog .nc-input-row-stacked{padding:var(--spacing-xs) 0;display:flex;flex-direction:row;gap:var(--spacing-sm)}.nc-dialog .nc-input-row-stacked{flex-direction:column;gap:var(--spacing-xs)}.nc-dialog .nc-input-row.no-padding-bottom,.nc-dialog .nc-input-row-stacked.no-padding-bottom{padding-bottom:0}.nc-dialog .nc-input-row.no-padding-top,.nc-dialog .nc-input-row-stacked.no-padding-top{padding-top:0}.nc-dialog .nc-input-row label{font-size:calc(var(--font-size-base)*.875);color:var(--nc-fg)}.nc-dialog .hint{font-size:calc(var(--font-size-base, 1rem)*.875);color:var(--nc-fg-dim)}.nc-dialog .buttons{display:flex;gap:var(--spacing-sm);justify-content:flex-end}.nc-dialog button{flex:1 0 auto;padding:var(--spacing-sm)}.nc-dialog button:hover{border-color:var(--nc-fg-dim)}.nc-dialog button.link-brackets{background:none;border:none;padding:0;color:var(--nc-fg-dim);flex:0 0 auto;text-transform:uppercase}.nc-dialog button.link-brackets:hover{border-color:var(--nc-fg)}.nc-dialog button.link-brackets .inner::before{content:"["}.nc-dialog button.link-brackets .inner::after{content:"]"}.nc-dialog button.nc-inline-btn{flex:0 0 auto;padding:.25rem .75rem;font-size:var(--font-size-base);background:var(--nc-bg);border:1px solid var(--nc-border);color:var(--nc-fg-dim);cursor:pointer;transition:border-color .15s,color .15s}.nc-dialog button.nc-inline-btn:hover{border-color:var(--nc-fg);color:var(--nc-fg)}.nc-dialog input[type=text],.nc-dialog textarea,.nc-dialog select{width:100%;padding:var(--spacing-xs) var(--spacing-sm);background:var(--nc-bg);border:1px solid var(--nc-border);color:var(--nc-fg);font-family:inherit;font-size:var(--font-size-base);box-sizing:border-box}.nc-dialog textarea{min-height:70px;resize:vertical}.nc-dialog .nc-toggle{display:flex;margin:var(--spacing-xs) 0}.nc-dialog .nc-toggle-label{display:inline-flex;align-items:center;gap:.75rem;cursor:pointer;flex-shrink:0}.nc-dialog .nc-toggle-value{font-size:var(--font-size-base);color:var(--nc-fg-dim);text-transform:uppercase;letter-spacing:.05em}.nc-dialog .nc-toggle-track{position:relative;width:2.5rem;height:1.25rem;border:1px solid var(--nc-border);border-radius:var(--radius-md);transition:background-color .15s}.nc-dialog .nc-toggle-track.active{background:var(--nc-fg)}.nc-dialog .nc-toggle-track:not(.active){background:var(--nc-fg-dim)}.nc-dialog .nc-toggle-thumb{position:absolute;top:2px;width:1rem;height:.875rem;background:var(--nc-bg);border-radius:var(--radius-md);transition:transform .15s}.nc-dialog .nc-toggle-thumb.pos-start{transform:translateX(2px)}.nc-dialog .nc-toggle-thumb.pos-middle{transform:translateX(10px)}.nc-dialog .nc-toggle-thumb.pos-end{transform:translateX(20px)}.nc-dialog .nc-sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);border:0}.nc-dialog .nc-text-dim{color:var(--nc-fg-dim)}.nc-dialog .nc-dialog-attribution{width:100%;display:flex;justify-content:right;gap:var(--spacing-xs);border-top:1px dotted var(--nc-border);margin-top:var(--spacing-xs);padding-top:var(--spacing-xs);font-size:calc(var(--font-size-base)*.875);line-height:calc(var(--font-size-base)*.875);color:var(--nc-fg-dim)}.nc-dialog .nc-dialog-attribution>span{flex:0 0 auto;border-right:1px solid var(--nc-border);padding-right:var(--spacing-xs);margin-right:var(--spacing-xs)}.nc-dialog .nc-dialog-attribution>span:last-child{border-right:none;padding-right:0;margin-right:0}.nc-dialog .nc-dialog-attribution a{color:var(--nc-fg-dim);text-decoration:none}.nc-dialog .nc-dialog-attribution a.github-link{height:calc(var(--font-size-base)*.875)}.nc-dialog .nc-dialog-error,.nc-dialog .nc-dialog-warning,.nc-dialog .nc-dialog-success,.nc-dialog .nc-dialog-info{font-size:calc(var(--font-size-base)*.875);line-height:calc(var(--line-height-base)*.875);padding:var(--spacing-xs) var(--spacing-sm)}.nc-dialog .nc-dialog-error{color:var(--nc-error);background-color:var(--nc-error-bg);border:1px dashed var(--nc-error)}.nc-dialog .nc-dialog-warning{color:var(--nc-warn);background-color:var(--nc-warn-bg);border:1px dashed var(--nc-warn)}.nc-dialog .nc-dialog-success{color:var(--nc-success);background-color:var(--nc-success-bg);border:1px dashed var(--nc-success)}.nc-dialog .nc-dialog-info{color:var(--nc-info);background-color:var(--nc-info-bg);border:1px dashed var(--nc-info)}.nc-dialog .nc-flex{display:flex}.nc-dialog .nc-flex-wrap{flex-wrap:wrap}.nc-dialog .nc-flex-shrink-0{flex-shrink:0}.nc-dialog .nc-items-center{align-items:center}.nc-dialog .nc-justify-between{justify-content:space-between}.nc-dialog .nc-gap-2{gap:var(--spacing-sm)}.nc-dialog .nc-gap-3{gap:.75rem}.nc-dialog .nc-gap-4{gap:1rem}.nc-dialog .nc-cursor-pointer{cursor:pointer}.nc-dialog pre,.nc-dialog div.nc-dialog-debug{max-width:100%;background-color:var(--nc-code-bg);color:var(--nc-fg);font-size:calc(var(--font-size-base)*.875);padding:var(--spacing-xs) var(--spacing-sm);border:2px dashed var(--nc-border)}.nc-dialog pre{white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word}.nc-dialog div.nc-dialog-debug{display:flex;flex-direction:column;gap:var(--spacing-xs);margin-bottom:var(--spacing-xs)}.nc-dialog div.nc-dialog-debug>span{display:flex;flex-direction:row;gap:.25rem;width:100%;max-width:100%;min-width:0}.nc-dialog div.nc-dialog-debug>span>*{flex:0 1 auto}.nc-dialog div.nc-dialog-debug>span>strong{flex:0 0 auto;font-weight:bold;min-width:7.5rem;text-align:right}.nc-dialog .nc-debug-color{display:inline-block;padding:0 .25em;font-size:.75em;border:1px solid var(--nc-border)}.nc-dialog-header{padding:var(--spacing-sm);border-bottom:1px solid var(--nc-border);flex-shrink:0;width:100%;box-sizing:border-box;gap:var(--spacing-sm)}.nc-dialog-content{padding:var(--spacing-sm);overflow-y:auto;flex:1}.nc-dialog-preview{padding:var(--spacing-xs) var(--spacing-sm);border-bottom:1px solid var(--nc-border);flex-shrink:0;background:var(--nc-code-bg);display:flex;flex-direction:column;gap:var(--spacing-xs)}.nc-dialog-preview .preview,.nc-dialog-preview .preview-row{font-size:var(--font-size-base);line-height:var(--line-height-base);margin:0;border:1px solid var(--nc-border);padding:var(--spacing-xs) var(--spacing-sm);background:var(--nc-bg);max-height:calc(var(--font-size-h)*2*var(--line-height-base) + var(--spacing-xs)*3);overflow:hidden}.nc-dialog-preview .preview.preview-inverted,.nc-dialog-preview .preview-row.preview-inverted{background:var(--nc-inverted-bg);color:var(--nc-inverted-fg)}.nc-dialog-preview .preview-row{display:flex;gap:var(--spacing-xs);flex-wrap:wrap;justify-content:space-around}.nc-dialog-footer{padding:var(--spacing-sm);border-top:1px solid var(--nc-border);flex-shrink:0}.nc-help-content h4{margin:var(--spacing-sm) 0 var(--spacing-xs);padding-top:var(--spacing-xs);border-top:1px dotted var(--nc-border)}.nc-help-content h4:first-child{margin-top:0;padding-top:0;border-top:none}.nc-help-content p{margin:0 0 var(--spacing-xs);color:var(--nc-fg-dim);font-size:calc(var(--font-size-base)*.875);line-height:1.4}.nc-help-content ul{margin:0 0 var(--spacing-xs);padding-left:1.25rem;list-style:disc}.nc-help-content li{margin:var(--spacing-xs) 0;color:var(--nc-fg-dim);font-size:calc(var(--font-size-base)*.875);line-height:1.4}.nc-help-content li strong{color:var(--nc-fg)}.nc-slider{position:relative;height:24px;margin:.5rem 0 .25rem}.nc-slider.nc-slider-simple{height:16px}.nc-slider.nc-slider-simple .nc-slider-track{inset:7px 0;height:2px;border:none;background:var(--nc-border)}.nc-slider.nc-slider-simple .nc-slider-thumb{top:3px;width:10px;height:10px;border-radius:50%}.nc-slider.nc-slider-simple .nc-slider-thumb::before{content:"";position:absolute;inset:-8px}.nc-slider.nc-slider-split{height:34px}.nc-slider.nc-slider-split .nc-slider-track{top:calc(50% + 1px);bottom:4px}.nc-slider.nc-slider-split .nc-slider-track-mapped{display:block !important}.nc-slider.nc-slider-split .nc-slider-thumb{height:32px}.nc-slider-track{position:absolute;inset:4px 0;border:1px solid var(--nc-border);background:var(--nc-code-bg);box-sizing:border-box}.nc-slider-track-mapped{display:none;position:absolute;top:4px;bottom:calc(50% + 1px);left:0;right:0;border:1px solid var(--nc-border);background:var(--nc-code-bg);box-sizing:border-box}.nc-slider-thumb{position:absolute;top:0;width:14px;height:22px;background:var(--nc-fg);border:2px solid var(--nc-bg);outline:1px solid var(--nc-border);cursor:ew-resize;transform:translateX(-50%);z-index:2;display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--nc-bg);user-select:none;box-sizing:border-box}.nc-slider-labels{display:flex;justify-content:space-between;font-size:calc(var(--font-size-base, 1rem)*.625);line-height:calc(var(--font-size-base, 1rem)*.625);margin-bottom:var(--spacing-sm)}.nc-slider-labels,.nc-slider-labels span{color:var(--nc-fg-dim)}.nc-debug-tooltip{position:fixed;z-index:9999999;background:var(--nc-bg, #0a0a0a);border:1px solid var(--nc-border, #333);color:var(--nc-fg, #e0e0e0);padding:.25rem;font-size:11px;font-family:monospace;max-width:350px;opacity:0;pointer-events:none;transition:opacity .15s;box-shadow:0 2px 8px rgba(0,0,0,.5)}.nc-debug-tooltip.visible{opacity:1}.nc-debug-row{display:flex;gap:var(--spacing-sm);padding:.125rem 0;border-bottom:1px dotted var(--nc-border, #333)}.nc-debug-row:last-child{border-bottom:none}.nc-debug-label{color:var(--nc-fg-dim, #888);min-width:90px;flex-shrink:0}.nc-debug-value{color:var(--nc-fg, #e0e0e0);display:flex;align-items:center;gap:.25rem}.nc-debug-swatch{display:inline-block;width:12px;height:12px;border:1px solid var(--nc-border, #333);flex-shrink:0}.nc-has-debug{cursor:help}.nc-notes-tooltip{position:fixed;z-index:9999999;background:var(--nc-bg, #0a0a0a);border:1px solid var(--nc-border, #333);color:var(--nc-fg, #e0e0e0);padding:.5rem .75rem;font-size:var(--font-size-base, 12px);font-family:inherit;max-width:300px;white-space:pre-wrap;word-wrap:break-word;opacity:0;pointer-events:none;transition:opacity .15s;box-shadow:0 2px 8px rgba(0,0,0,.5)}.nc-notes-tooltip.visible{opacity:1}.nc-has-notes{cursor:help}html[data-theme=poetry] [data-mention-colored=true],html[data-theme=poetry] [data-nick-colored=true],body[data-theme=poetry] [data-mention-colored=true],body[data-theme=poetry] [data-nick-colored=true]{border-radius:var(--radius-md)}',document.head.appendChild(t);const GM_setValue="function"==typeof window.GM_setValue?window.GM_setValue:(e,t)=>localStorage.setItem("nickColors_"+e,t),GM_getValue="function"==typeof window.GM_getValue?window.GM_getValue:(e,t)=>{const n=localStorage.getItem("nickColors_"+e);return null!==n?n:t};function n(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function o(e){const t=n(e);if(!t)return null;let o=t.r/255,i=t.g/255,s=t.b/255;const a=Math.max(o,i,s),r=Math.min(o,i,s);let l,c,d=(a+r)/2;if(a===r)l=c=0;else{const e=a-r;switch(c=d>.5?e/(2-a-r):e/(a+r),a){case o:l=((i-s)/e+(i<s?6:0))/6;break;case i:l=((s-o)/e+2)/6;break;case s:l=((o-i)/e+4)/6}}return{h:Math.round(360*l),s:Math.round(100*c),l:Math.round(100*d)}}function i(e,t,n){let o,i,s;if(e/=360,n/=100,0==(t/=100))o=i=s=n;else{const a=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e),r=n<.5?n*(1+t):n+t-n*t,l=2*n-r;o=a(l,r,e+1/3),i=a(l,r,e),s=a(l,r,e-1/3)}return{r:Math.round(255*o),g:Math.round(255*i),b:Math.round(255*s)}}function s(e,t="hsl"){if(!e)return null;let s,a,r;"string"==typeof e?(s=e.match(/hsla?\(([\d.]+),\s*([\d.]+)%?,\s*([\d.]+)%?(?:,\s*[\d.]+)?\)/),a=e.match(/rgba?\(([\d.]+),\s*([\d.]+),\s*([\d.]+)(?:,\s*[\d.]+)?\)/),r=e.match(/^#([a-f\d]{6}|[a-f\d]{3})$/i)):"object"==typeof e&&(void 0!==e.h&&void 0!==e.s&&void 0!==e.l?s=[null,e.h,e.s,e.l]:void 0!==e.r&&void 0!==e.g&&void 0!==e.b&&(a=[null,e.r,e.g,e.b]));const l=t.match("-string")?"string":"object";if("hsl"===(t=t.replace(/-string|-object$/,""))){if(s)return"string"===l?`hsl(${(+s[1]).toFixed(1)}, ${(+s[2]).toFixed(1)}%, ${(+s[3]).toFixed(1)}%)`:{h:+s[1],s:+s[2],l:+s[3]};if(a){const e=function(e,t,n){e/=255,t/=255,n/=255;const o=Math.max(e,t,n),i=Math.min(e,t,n);let s,a,r=(o+i)/2;if(o===i)s=a=0;else{const l=o-i;switch(a=r>.5?l/(2-o-i):l/(o+i),o){case e:s=((t-n)/l+(t<n?6:0))/6;break;case t:s=((n-e)/l+2)/6;break;case n:s=((e-t)/l+4)/6}}return{h:360*s,s:100*a,l:100*r}}(+a[1],+a[2],+a[3]);return"string"===l?`hsl(${e.h.toFixed(1)}, ${e.s.toFixed(1)}%, ${e.l.toFixed(1)}%)`:{h:e.h,s:e.s,l:e.l}}if(r)return o(e)}else if("rgb"===t){if(a)return"string"===l?`rgb(${(+a[1]).toFixed(1)}, ${(+a[2]).toFixed(1)}, ${(+a[3]).toFixed(1)})`:{r:+a[1],g:+a[2],b:+a[3]};if(s){const e=i(+s[1],+s[2],+s[3]);return"string"===l?`rgb(${e.r.toFixed(1)}, ${e.g.toFixed(1)}, ${e.b.toFixed(1)})`:{r:e.r,g:e.g,b:e.b}}if(r)return n(e)}else if("hex"===t){if(r)return e;if(s)return rgbToHex(i(+s[1],+s[2],+s[3]));if(a)return rgbToHex({r:+a[1],g:+a[2],b:+a[3]})}return null}function a(e){const t=s(e,"rgb");if(!t)return 0;const{r:n,g:o,b:i}=t,a=n/255,r=o/255,l=i/255;return.2126*(a<=.03928?a/12.92:Math.pow((a+.055)/1.055,2.4))+.7152*(r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4))+.0722*(l<=.03928?l/12.92:Math.pow((l+.055)/1.055,2.4))}function r(e,t){const n=a(e),o=a(t);return(Math.max(n,o)+.05)/(Math.min(n,o)+.05)}function l(e){if(e||(e=M),!e)return null;if(V[e])return V[e];const t=e.toLowerCase();for(const[e,n]of Object.entries(V))if(e.toLowerCase()===t)return n;return null}function c(e=null,t=null){const c=document.documentElement,d=getComputedStyle(c),g=(e=e??c.dataset.theme??document.body?.dataset?.theme)?l(e):null,p=O?{bg:O.bg,fg:O.fg,fgDim:O.fgDim||O.dim,border:O.border,codeBg:O.codeBg||O.code_bg}:null,f=V["Full Spectrum"].colors;function m(e){return!(!e||"transparent"===e||"none"===e||!n(e)&&!e.startsWith("rgb")&&!e.startsWith("hsl"))}function h(e,t){const n=d.getPropertyValue(e).trim();return m(n)?n:p&&m(p[t])?p[t]:g&&g.colors&&m(g.colors[t])?g.colors[t]:f[t]}let v=h("--color-fg","fg"),y=h("--color-bg","bg");if(g?.logic){const e=g.logic.invertedContainerBg??"fg",t=g.logic.invertedContainerFg??"bg",n="--color-"+u(e),o="--color-"+u(t);v=h(n,e),y=h(o,t)}const x={bg:h("--color-bg","bg"),fg:h("--color-fg","fg"),fgDim:h("--color-fg-dim","fgDim"),border:h("--color-border","border"),codeBg:h("--color-code-bg","codeBg"),invertedBg:v,invertedFg:y,error:"#ff6b6b",warn:"#ffd93d",success:"#6bcb77",info:"#4d96ff",errorBg:"#1a0d0d",warnBg:"#1a250d",successBg:"#152a15",infoBg:"#15152a"},C=o(x.fg)||s(x.fg,"hsl"),S=o(x.bg)||s(x.bg,"hsl");function k(e,t,n,o,s=4.5){let l=n,c=i(e,t,l),d=r(c,o);if(d>=s)return`hsl(${e}, ${t}%, ${l}%)`;const u=a(o)>.5?-5:5;for(let n=0;n<15&&(l=Math.max(5,Math.min(95,l+u)),c=i(e,t,l),d=r(c,o),!(d>=s));n++);return`hsl(${e}, ${t}%, ${l}%)`}if(C&&S){let e=Math.max(C.s,50),t=C.l;(t<20||t>80)&&(t=50,e=Math.max(e,70));const n=i(S.h,S.s,S.l);x.error=k(0,e,t,n),x.warn=k(45,e,t,n),x.success=k(120,e,t,n),x.info=k(210,e,t,n)}if(S){let e=Math.max(S.s,20),t=S.l;if(t<5?(t=10,e=Math.max(e,30)):t>95&&(t=90,e=Math.max(e,30)),x.errorBg=`hsl(0, ${e}%, ${t}%)`,x.warnBg=`hsl(45, ${e}%, ${t}%)`,x.successBg=`hsl(120, ${e}%, ${t}%)`,x.infoBg=`hsl(210, ${e}%, ${t}%)`,x.error&&x.errorBg){const e=b(x.errorBg,x.error,4.5,"hsl-string");x.error=e.colorAdjust,x.errorBg=e.colorCompare}if(x.warn&&x.warnBg){const e=b(x.warnBg,x.warn,4.5,"hsl-string");x.warn=e.colorAdjust,x.warnBg=e.colorCompare}if(x.success&&x.successBg){const e=b(x.successBg,x.success,4.5,"hsl-string");x.success=e.colorAdjust,x.successBg=e.colorCompare}if(x.info&&x.infoBg){const e=b(x.infoBg,x.info,4.5,"hsl-string");x.info=e.colorAdjust,x.infoBg=e.colorCompare}}if(t)for(const e in x){const n=s(x[e],t);n&&(x[e]=n)}return x}function d(e){const t=l(e=e??M??"Full Spectrum");return{theme:e,colors:c(e),colorVariables:c(e,"hsl"),settings:{...L,...t?.settings||{}}}}function u(e){return e.replace(/([A-Z])/g,"-$1").toLowerCase()}function g(e){return e.replace(/-([a-z])/g,(e,t)=>t.toUpperCase())}function p(e){const t={};return e.split(/[;\n]/).forEach(e=>{const n=e.trim();if(!n)return;const o=n.indexOf(":");if(-1===o)return;const i=n.slice(0,o).trim(),s=n.slice(o+1).trim();if(i&&s){const e=i.replace(/-([a-z])/g,(e,t)=>t.toUpperCase());t[e]=s}}),t}function f(e,t="; "){return Object.entries(e).map(([e,t])=>`${u(e)}: ${t}`).join(t)}function m(e,t,n){if(0===t&&360===n)return e;const o=e/360;if(t<=n)return t+o*(n-t);{const e=t+o*(360-t+n);return e>=360?e-360:e}}function h(e,t,n){return 0===t&&100===n?e:t+e/100*(n-t)}function b(e,t,n=4.5,o="hsl"){let i=r(e,t);const l={adjusted:!1},c=s(e,"hsl"),d=s(t,"hsl");if(!c||!d)return l.colorAdjust=t,l.colorCompare=e,l.contrast=i,l.loopCount=0,l;let u=0;for(;i<n&&u<20;){const e=a(c),t=a(d);0===d.l||100===d.l?e>t?c.l+=5:c.l-=5:t>e?d.l+=5:d.l-=5,i=r(c,d),u++,l.adjusted=!0}return l.colorAdjust=s(d,o),l.colorCompare=s(c,o),l.contrast=i,l.loopCount=u,l}function v(e,t="hsl",n={}){if(n={mapHue:!0,mapSat:!0,mapLit:!0,effectiveConfig:y(),...n},!e)return null;const o=s(e,"hsl");return o?s({h:n.mapHue?m(o.h,n.effectiveConfig.minHue??0,n.effectiveConfig.maxHue??360):o.h,s:n.mapSat?h(o.s,n.effectiveConfig.minSaturation??0,n.effectiveConfig.maxSaturation??100):o.s,l:n.mapLit?h(o.l,n.effectiveConfig.minLightness??0,n.effectiveConfig.maxLightness??100):o.l},t):null}function y(){const e={...A},t=c(null,"hsl"),n=s(t?.fg,"hsl")||{h:0,s:0,l:0};if(A.useSiteThemeHue&&(e.minHue=(n.h-A.hueSpread+360)%360,e.maxHue=(n.h+A.hueSpread)%360),A.useSiteThemeSat){const t=A.satSpread||0;e.minSaturation=Math.max(0,n.s-t),e.maxSaturation=Math.min(100,n.s+t)}if(A.useSiteThemeLit){const t=A.litSpread||0;e.minLightness=Math.max(0,n.l-t),e.maxLightness=Math.min(100,n.l+t)}return e}function x(e){let t=0;const n=e.toLowerCase().trim();for(let e=0;e<n.length;e++)t=n.charCodeAt(e)+((t<<5)-t),t&=t;return Math.abs(t)}function C(e=null){const t=c(e),n=document.documentElement;n.style.setProperty("--nc-bg",t.bg),n.style.setProperty("--nc-fg",t.fg),n.style.setProperty("--nc-fg-dim",t.fgDim),n.style.setProperty("--nc-border",t.border),n.style.setProperty("--nc-code-bg",t.codeBg),n.style.setProperty("--nc-inverted-bg",t.invertedBg),n.style.setProperty("--nc-inverted-fg",t.invertedFg),n.style.setProperty("--nc-error",t.error),n.style.setProperty("--nc-warn",t.warn),n.style.setProperty("--nc-success",t.success),n.style.setProperty("--nc-info",t.info),n.style.setProperty("--nc-error-bg",t.errorBg),n.style.setProperty("--nc-warn-bg",t.warnBg),n.style.setProperty("--nc-success-bg",t.successBg),n.style.setProperty("--nc-info-bg",t.infoBg)}function S(){document.querySelectorAll("[data-nick-colored]").forEach(e=>{e.dataset.originalText&&(e.textContent=e.dataset.originalText),delete e.dataset.nickColored,delete e.dataset.iconApplied,delete e.dataset.originalText,delete e.dataset.username,e.style.cssText=""}),document.querySelectorAll("[data-mention-colored]").forEach(e=>{const t=e.dataset.username,n=t?`@${t}`:e.textContent;e.replaceWith(document.createTextNode(n))}),ve()}let k="true"===GM_getValue("debugMode","false");const $="https://github.com/z0mbieparade/cyberspace-nick-colors/raw/refs/heads/main/overrides.json";let w={};const L={useSingleColor:!1,useSiteThemeHue:!1,useSiteThemeSat:!1,useSiteThemeLit:!1,singleColorHue:180,singleColorSat:85,singleColorLit:65,singleColorCustom:"",satSpread:15,hueSpread:30,litSpread:10,minHue:0,maxHue:360,minSaturation:70,maxSaturation:100,minLightness:55,maxLightness:75,contrastThreshold:4.5,varyWeight:!1,varyItalic:!1,varyCase:!1,prependIcon:!1,appendIcon:!1,iconSet:"● ○ ◆ ◇ ■ □ ▲ △ ★ ☆ ♦ ♠ ♣ ♥ ☢ ☣ ☠ ⚙ ⬡ ⬢ ♻ ⚛ ⚠ ⛒"},E=['a[href^="/"]'],T=[".chat-main-content",".profile-box-inverted"],I=[".sidebar","footer",".nc-dialog-attribution","code","pre","script"],N=["feed","topics","jukebox","notes","write","chat","messages","bookmarks","notifications","me","guilds","support","wiki","changelog","netiquette","faq","loading","error"],F=[".profile-box-inverted"],V={"Full Spectrum":{colors:{fg:"#e0e0e0",bg:"#0a0a0a",fgDim:"#888888",border:"#333333",codeBg:"#222222"},settings:{minSaturation:70,maxSaturation:100,minLightness:55,maxLightness:75,minHue:0,maxHue:360,contrastThreshold:4.5}},z0ylent:{colors:{fg:"#91ff00",bg:"#060f04",fgDim:"#12892d",border:"#12892d",codeBg:"#0c1c08"},settings:{minSaturation:80,maxSaturation:100,minLightness:45,maxLightness:65,minHue:60,maxHue:150,contrastThreshold:4.5}},Dark:{colors:{fg:"#efe5c0",bg:"#000000",fgDim:"#a89984",border:"#3a3a3a",codeBg:"hsla(0,0%,100%,.07)"},settings:{minSaturation:12,maxSaturation:60,minLightness:65,maxLightness:80,minHue:0,maxHue:70,contrastThreshold:4.5}},Light:{colors:{fg:"#000000",bg:"#efe5c0",fgDim:"#3a3a3a",border:"#a89984",codeBg:"rgba(0,0,0,.08)"},settings:{minSaturation:12,maxSaturation:60,minLightness:30,maxLightness:45,minHue:344,maxHue:44,contrastThreshold:4.5}},C64:{colors:{fg:"hsla(0,0%,100%,.75)",bg:"#2a2ab8",fgDim:"hsla(0,0%,100%,.4)",border:"hsla(0,0%,100%,.3)",codeBg:"hsla(0,0%,100%,.08)"},settings:{minSaturation:70,maxSaturation:90,minLightness:60,maxLightness:75,minHue:180,maxHue:280,contrastThreshold:4.5}},VT320:{colors:{fg:"#ff9a10",bg:"#170800",fgDim:"#ff9100",border:"rgba(255,155,0,.27)",codeBg:"rgba(255,155,0,.05)"},settings:{minSaturation:90,maxSaturation:100,minLightness:50,maxLightness:65,minHue:15,maxHue:55,contrastThreshold:4.5}},Matrix:{colors:{fg:"rgba(160,224,68,.9)",bg:"#000000",fgDim:"rgba(160,224,68,.5)",border:"rgba(160,224,68,.4)",codeBg:"rgba(0,255,65,.08)"},settings:{minSaturation:75,maxSaturation:95,minLightness:45,maxLightness:60,minHue:70,maxHue:140,contrastThreshold:4.5}},Poetry:{colors:{fg:"#222222",bg:"#fefaf8",fgDim:"#666666",border:"#cccccc",codeBg:"#f0e0dd"},settings:{minSaturation:0,maxSaturation:35,minLightness:30,maxLightness:45,minHue:339,maxHue:46,contrastThreshold:4.5},logic:{invertedContainerBg:"codeBg",invertedContainerFg:"fg"}},Brutalist:{colors:{fg:"#c0d0e8",bg:"#080810",fgDim:"#99a9bf",border:"rgba(160,180,220,.18)",codeBg:"rgba(160,180,220,.06)"},settings:{minSaturation:50,maxSaturation:70,minLightness:60,maxLightness:75,minHue:180,maxHue:260,contrastThreshold:4.5}},GRiD:{colors:{fg:"#fea813",bg:"#180f06",fgDim:"#d08c17",border:"rgba(245,169,28,.22)",codeBg:"rgba(245,169,28,.08)"},settings:{minSaturation:90,maxSaturation:100,minLightness:50,maxLightness:65,minHue:20,maxHue:60,contrastThreshold:4.5}},System:{colors:{fg:"#efe5c0",bg:"#000000",fgDim:"#a89984",border:"#3a3a3a",codeBg:"hsla(0,0%,100%,.07)"},settings:{minSaturation:60,maxSaturation:80,minLightness:65,maxLightness:80,minHue:0,maxHue:360,contrastThreshold:4.5}}};let H=null,M=null,O=null;try{M=document.documentElement?.dataset?.theme||null}catch(Ne){}function j(){try{const e=localStorage.getItem("custom_theme");e&&(O=JSON.parse(e))}catch(e){console.log("[Nick Colors] Could not parse site custom_theme:",e)}}function R(){const e=c();console.log("[Nick Colors] Theme variables:",e),e&&e.fg&&e.bg&&(M=document.documentElement?.dataset?.theme||null,H={...e})}j(),H||R();let A={...L};function q(){GM_setValue("siteConfig",JSON.stringify(A))}!function(){try{const e=GM_getValue("siteConfig",null);e&&(A={...L,...JSON.parse(e)})}catch(e){console.error("[Nick Colors] Failed to load site config:",e)}}();let D={};function z(){GM_setValue("customNickColors",JSON.stringify(D))}function W(){const e={version:2,exportedAt:(new Date).toISOString()},t=function(e,t){const n={};for(const o of Object.keys(e))JSON.stringify(e[o])!==JSON.stringify(t[o])&&(n[o]=e[o]);return Object.keys(n).length>0?n:null}(A,L);return t&&(e.siteConfig=t),Object.keys(D).length>0&&(e.customNickColors=D),e}!function(){try{const e=GM_getValue("customNickColors","{}");D=JSON.parse(e)}catch(e){D={}}}();const B={useHueRange:"useSiteThemeHue",useSaturation:"useSiteThemeSat",useLightness:"useSiteThemeLit",saturationSpread:"satSpread",lightnessSpread:"litSpread"};function G(e){const t={};for(const[n,o]of Object.entries(e))"excludeRanges"!==n&&(t[B[n]||n]=o);return t}function P(e){try{if(!e||"object"!=typeof e)return{success:!1,message:"Invalid data format"};const t=1===e.v||1===e.version||e.cc||e.stc||e.colorConfig||e.siteThemeConfig||e.styleConfig;if((e=t?function(e){const t={version:2},n={};return e.cc&&Object.assign(n,G(Z(e.cc))),e.stc&&Object.assign(n,G(Z(e.stc))),e.sc&&Object.assign(n,G(Z(e.sc))),e.colorConfig&&Object.assign(n,G(e.colorConfig)),e.siteThemeConfig&&Object.assign(n,G(e.siteThemeConfig)),e.styleConfig&&Object.assign(n,G(e.styleConfig)),Object.keys(n).length>0&&(t.siteConfig=n),e.cnc&&(t.customNickColors=Z(e.cnc)),e.customNickColors&&(t.customNickColors=e.customNickColors),(e.at||e.exportedAt)&&(t.exportedAt=e.at||e.exportedAt),t}(e):Z(e)).version&&e.version>2)return{success:!1,message:`Export version ${e.version} is newer than supported version 2`};if(e.siteConfig){for(const e in A)delete A[e];Object.assign(A,L,e.siteConfig),q()}if(e.customNickColors){for(const e in D)delete D[e];Object.assign(D,e.customNickColors),z()}return S(),{success:!0,message:"Settings imported successfully"+(t?" (migrated from v1)":"")}}catch(e){return{success:!1,message:`Import failed: ${e.message}`}}}const _={minSaturation:"mS",maxSaturation:"xS",minLightness:"mL",maxLightness:"xL",minHue:"mH",maxHue:"xH",contrastThreshold:"cT",useSiteThemeHue:"uH",hueSpread:"hS",useSiteThemeSat:"uS",satSpread:"sS",useSiteThemeLit:"uL",litSpread:"lS",useSingleColor:"uSC",singleColorHue:"sCH",singleColorSat:"sCS",singleColorLit:"sCL",singleColorCustom:"sCC",varyWeight:"vW",varyItalic:"vI",varyCase:"vC",prependIcon:"pI",appendIcon:"aI",iconSet:"iS",color:"c",backgroundColor:"bg",fontWeight:"fW",fontStyle:"fS",fontVariant:"fV",fontFamily:"fF",userNotes:"un",invert:"inv",siteConfig:"sc",customNickColors:"cnc",version:"v",exportedAt:"at"},J=Object.fromEntries(Object.entries(_).map(([e,t])=>[t,e]));function U(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(U);const t={};for(const[n,o]of Object.entries(e))t[_[n]||n]=U(o);return t}function Z(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(Z);const t={};for(const[n,o]of Object.entries(e))t[J[n]||n]=Z(o);return t}function X(e,t){!function(e,t){const n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}(U(e),t)}async function K(e){try{return await navigator.clipboard.writeText(JSON.stringify(U(e))),!0}catch(e){throw new Error(`Failed to copy: ${e.message}`)}}function Y(e){const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=t=>{const n=t.target.files[0];if(!n)return;const o=new FileReader;o.onload=t=>{try{const n=Z(JSON.parse(t.target.result));e(n,null)}catch(t){e(null,new Error(`Failed to parse file: ${t.message}`))}},o.readAsText(n)},t.click()}function Q(e){const t=document.createElement("div");t.className="nc-dialog-overlay",t.innerHTML='\n\t\t<div class="nc-dialog" style="min-width: 400px; max-width: 500px;">\n\t\t\t<div class="nc-dialog-header nc-flex nc-justify-between">\n\t\t\t\t<h3>Paste Settings</h3>\n\t\t\t\t<div class="spacer"></div>\n\t\t\t\t<button class="nc-header-close link-brackets"><span class="inner">ESC</span></button>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-content">\n\t\t\t\t<div class="hint">Paste your settings JSON below (Ctrl+V or right-click → Paste)</div>\n\t\t\t\t<textarea id="paste-settings-input" style="min-height: 150px; width: 100%; font-size: var(--font-size-base);" placeholder="Paste settings JSON here..."></textarea>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-footer">\n\t\t\t\t<div class="buttons nc-flex nc-items-center nc-gap-2">\n\t\t\t\t\t<button class="nc-import-btn link-brackets"><span class="inner">IMPORT</span></button>\n\t\t\t\t\t<button class="nc-cancel-btn link-brackets"><span class="inner">CANCEL</span></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t';const n=()=>t.remove(),o=t.querySelector("#paste-settings-input");t.querySelector(".nc-header-close").addEventListener("click",n),t.querySelector(".nc-cancel-btn").addEventListener("click",n),t.querySelector(".nc-import-btn").addEventListener("click",()=>{const t=o.value.trim();if(t)try{const o=Z(JSON.parse(t));n(),e(o,null)}catch(t){e(null,new Error(`Failed to parse: ${t.message}`))}else alert("Please paste settings JSON first")}),t.addEventListener("click",e=>{e.target===t&&n()}),t.addEventListener("keydown",e=>{"Escape"===e.key&&n()}),document.body.appendChild(t),o.focus()}function ee(e,t=null){const n=`https://cyberspace.online/${e}`;if(window.location.pathname===`/${e}`)return console.log("navigated to user profile, triggering compose shortcut"),void document.dispatchEvent(new KeyboardEvent("keydown",{key:"c",code:"KeyC",bubbles:!0}));sessionStorage.setItem("nickColors_openCompose","true"),t&&sessionStorage.setItem("nickColors_composeMessage",t),window.location.href=n}if("true"===sessionStorage.getItem("nickColors_openCompose")){function Fe(e=0){console.log(`[NickColors] tryOpenCompose attempt ${e}, readyState: ${document.readyState}`);let t=null;const n=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,!1);let o;for(;o=n.nextNode();){const e=o.textContent?.trim()||"";if(e.includes("[C]")&&e.includes("C-Mail")){t=o.parentElement,console.log(`[NickColors] Found text node with C-Mail, parent: ${t?.tagName}, text: "${e}"`);break}}if(t){console.log("[NickColors] Found C-Mail button, clicking it:",t),t.click();const e=sessionStorage.getItem("nickColors_composeMessage");e&&(sessionStorage.removeItem("nickColors_composeMessage"),setTimeout(()=>Ve(e,0),300))}else e>30?console.log("[NickColors] Max attempts reached, giving up"):(console.log("[NickColors] C-Mail button not found, retrying in 500ms"),setTimeout(()=>Fe(e+1),500))}function Ve(e,t){console.log(`[NickColors] tryFillMessage attempt ${t}`);const n=document.querySelector('input[placeholder="Type a message..."], textarea[placeholder="Type a message..."]');n?(console.log("[NickColors] Found message input, filling it"),n.focus(),n.value=e,n.dispatchEvent(new Event("input",{bubbles:!0}))):t<20?setTimeout(()=>Ve(e,t+1),200):console.log("[NickColors] Could not find message input, giving up")}sessionStorage.removeItem("nickColors_openCompose"),console.log("[NickColors] Detected openCompose flag, will try to open compose"),console.log("[NickColors] readyState:",document.readyState),"complete"===document.readyState?(console.log("[NickColors] Page already complete, starting in 1s"),setTimeout(Fe,1e3)):(console.log("[NickColors] Waiting for load event"),window.addEventListener("load",()=>{console.log("[NickColors] Load event fired, starting in 1s"),setTimeout(Fe,1e3)}))}function te(e,t=""){const n=k?"":' style="display: none;"',o="nc-dialog-debug"+(t?" "+t:"");return"string"==typeof e?`<div class="${o}"${n}>${e}</div>`:(console.log(e),`<div class="${o}"${n}>\n${Object.entries(e).map(([e,t])=>"object"!=typeof t||void 0===t.txt&&void 0===t.elem?"string"==typeof t?`<span><strong>${e}:</strong><span>${t??"N/A"}</span></span>`:void 0:`<span><strong>${e}:</strong><span>${t.txt??" N/A"}${t.elem?" "+t.elem:""}</span></span>`).filter(e=>e&&""!==e.trim()).join("\n").trim()}\n</div>`)}function ne(e,t=""){let n=e.querySelector(".nc-dynamic-debug");return n||(n=document.createElement("div"),n.className="nc-dynamic-debug nc-dialog-debug"+(t?" "+t:""),e.appendChild(n)),n.style.display=k?"":"none",n}function oe(){const t=y(),n=c(null,"hsl"),o=[];o.push("=".repeat(60)),o.push("NICK COLORS DEBUG LOG"),o.push("=".repeat(60)),o.push(""),o.push(`Exported: ${(new Date).toISOString()}`),o.push(`Version: ${e}`),o.push(`Debug Mode: ${k}`),o.push(`URL: ${window.location.href}`),o.push(`User Agent: ${navigator.userAgent}`),o.push(""),o.push("-".repeat(60)),o.push("THEME INFO"),o.push("-".repeat(60)),o.push(`Site Theme Name: ${M||"none"}`),o.push(`Site Theme Object: ${H?JSON.stringify(H):"none"}`),o.push(`Site Custom Theme: ${O?JSON.stringify(O):"none"}`),o.push(""),o.push("-".repeat(60)),o.push("THEME COLORS (resolved)"),o.push("-".repeat(60)),o.push(JSON.stringify(n,null,2)),o.push(""),o.push("-".repeat(60)),o.push("EFFECTIVE CONFIG (after site theme integration)"),o.push("-".repeat(60)),o.push(JSON.stringify(t,null,2)),o.push(""),o.push("-".repeat(60)),o.push("SAVED SITE CONFIG"),o.push("-".repeat(60)),o.push(JSON.stringify(A,null,2)),o.push(""),o.push("-".repeat(60)),o.push(`CUSTOM NICK COLORS (${Object.keys(D).length} total)`),o.push("-".repeat(60)),o.push(JSON.stringify(D,null,2)),o.push(""),o.push("-".repeat(60)),o.push(`MANUAL OVERRIDES (${Object.keys(w).length} total)`),o.push("-".repeat(60)),o.push(JSON.stringify(w,null,2)),o.push("");const i=document.querySelectorAll(".nc-dialog-debug, .nc-dynamic-debug");return i.length>0&&(o.push("-".repeat(60)),o.push(`DEBUG ELEMENTS (${i.length} found)`),o.push("-".repeat(60)),i.forEach((e,t)=>{o.push(`[${t+1}] ${e.textContent.trim()}`)}),o.push("")),o.push("=".repeat(60)),o.push("END OF DEBUG LOG"),o.push("=".repeat(60)),o.join("\n")}function ie(e){delete e.appendIcon,delete e.prependIcon,delete e.invert;for(const t in e)if(t.startsWith("color")&&"string"!=typeof e[t]){const n=s(e[t],"hsl");n?e[t]=n:delete e[t]}else t.startsWith("base")&&delete e[t];return e}function se(e,t="hsl",n={}){n={includeStyles:!1,effectiveConfig:y(),debugData:!1,...n};let o={color:null},i=[];if(D[e]){const a=D[e],r="string"==typeof a?a:a.color;if(r){const e=s(r,t);e&&(o.color=e),i.push(["Source","Custom"])}n.includeStyles&&"object"==typeof a&&(o={...a,...o})}if(null===o.color&&w[e]){const a=w[e],r="string"==typeof a?a:a.color;if(r){const e=s(r,t);e&&(o.color=e),i.push(["Source","Override"])}n.includeStyles&&"object"==typeof a&&(o={...a,...o})}if(n.effectiveConfig.useSingleColor){let e;e=n.effectiveConfig.singleColorCustom&&s(n.effectiveConfig.singleColorCustom,"hsl")||{h:n.effectiveConfig.singleColorHue,s:n.effectiveConfig.singleColorSat,l:n.effectiveConfig.singleColorLit},o={...o,color:s(e,t)},delete o.backgroundColor}if(null===o.color){const n={h:x(e)%360,s:x(e+"_sat")%101,l:x(e+"_lit")%101};o={...o,color:s(n,t)},i.push(["Source","Hashed"])}if(n.includeStyles){const t=re(e);if(n.effectiveConfig.varyWeight&&!o.fontWeight&&(o.fontWeight=t.fontWeight),n.effectiveConfig.varyItalic&&!o.fontStyle&&(o.fontStyle=t.fontStyle),n.effectiveConfig.varyCase&&!o.fontVariant&&(o.fontVariant=t.fontVariant),n.effectiveConfig.prependIcon||n.effectiveConfig.appendIcon){const t=ae(e,{effectiveConfig:n.effectiveConfig});!1!==o.appendIcon&&(o.appendIcon=t),!1!==o.prependIcon&&(o.prependIcon=t)}}return n.debugData&&(o.debugData=i),n.includeStyles?o:o.color}function ae(e,t={}){if(!(t={effectiveConfig:y(),...t}).effectiveConfig.prependIcon&&!t.effectiveConfig.appendIcon||!t.effectiveConfig.iconSet)return null;const n=t.effectiveConfig.iconSet.split(/\s+/).filter(Boolean);return 0===n.length?null:n[x(e+"_icon")%n.length]}function re(e){return{fontWeight:x(e+"_fontWeight")%2==0?"normal":"bold",fontStyle:x(e+"_fontStyle")%4==0?"italic":"normal",fontVariant:x(e+"_fontVariant")%4==1?"small-caps":"normal"}}function le(e){const t=se(e);let n={color:`hsl(${t.h}, ${t.s}%, ${t.l}%)`};if(D[e]&&"object"==typeof D[e]){const t={...D[e]};delete t.color,delete t.invert,n={...n,...t}}else if(w[e]&&"object"==typeof w[e]){const t={...w[e]};delete t.color,n={...n,...t}}return n}function ce(e,t,n={}){n={matchType:"nick",mergeStyles:{},overridesStyles:null,themeName:M,effectiveConfig:y(),debugData:!1,...n};let o=[];e.querySelector(".nc-nick-debug")&&e.querySelector(".nc-nick-debug").remove();const i=n.isInverted??(F.length>0&&F.some(t=>e.closest(t)));let{styles:a,nickConfig:l,contrastRatio:d,debugData:p}=function(e,t={}){let n=[];const o=(t={themeName:M,effectiveConfig:y(),isInverted:!1,debugData:!1,...t}).effectiveConfig.contrastThreshold??4.5,i=function(e,t="hsl",n={}){const o=se(e,t,n={includeStyles:!1,effectiveConfig:y(),debugData:!1,...n});let i=null,s=[];const a=n.effectiveConfig.useSingleColor;if(!0===n.includeStyles){n.debugData&&(s=o.debugData||[],delete o.debugData),i={...o};for(const e in o)e.startsWith("color")&&(i[g("base-"+e)]=o[e],i[e]=a?o[e]:v(o[e],t,{effectiveConfig:n.effectiveConfig}));n.debugData&&(i.debugData=s)}else i=a?o:v(o,t,{effectiveConfig:n.effectiveConfig});return i}(e,"hsl",{includeStyles:!0,effectiveConfig:t.effectiveConfig,debugData:t.debugData}),a=c(t.themeName);t.debugData&&(n=i.debugData||[],delete i.debugData);let l=s(i.color,"rgb"),d=t.isInverted?a.invertedBg:a.bg;const u=s(d,"rgb");n.push(["Element BG",d?s(u,"hsl-string"):"N/A"]);let p=s(i.backgroundColor??d,"rgb");n.push(["Nick FG (raw)",l?s(l,"hsl-string"):"N/A"]),n.push(["Nick BG (raw)",p?s(p,"hsl-string"):"N/A"]);let f=r(l,p);n.push(["Contrast (raw)",+f.toFixed(2)]);let m=!1;!0===i.invert||!1===i.invert?(m=i.invert,n.push(["User Invert",i.invert])):o>0&&(m=f<o,n.push(["Thresh Invert",m]));const h=s(i.color,"hsl-string"),x=i.backgroundColor?s(i.backgroundColor,"hsl-string"):null,C=i.prependIcon,S=i.appendIcon,k=ie(i);if(k.color=h,m){let e=h,i=x||function(e,t="hsl",n={}){const o=c((n={themeName:M,isInverted:!1,...n}).themeName,"hsl");let i=n.isInverted?o.invertedBg:o.bg,a=n.isInverted?o.invertedFg:o.fg;return s(r(i,e)>r(a,e)?i:a,t)}(h,"hsl-string",{themeName:t.themeName,isInverted:!0,effectiveConfig:t.effectiveConfig,debugData:t.debugData});if(t.effectiveConfig.useSingleColor)k.color=i,k.backgroundColor=e;else{const t=b(e,i,o,"hsl-string");k.color=t.colorAdjust,k.backgroundColor=t.colorCompare}n.push(["Nick FG (adj)",k.color||"N/A"]),n.push(["Nick BG (adj)",k.backgroundColor||"N/A"]),f=r(k.color,k.backgroundColor),k.padding="0 0.25em"}else{if(!t.effectiveConfig.useSingleColor){const e=b(p,h,o,"hsl-string");k.color=e.colorAdjust,n.push(["Nick FG (adj)",k.color||"N/A"])}f=r(k.color,p)}return n.push(["Contrast (adj)",+f.toFixed(2)]),{styles:k,nickConfig:{...i,prependIcon:C,appendIcon:S},debugData:n}}(t,{themeName:n.themeName,effectiveConfig:n.effectiveConfig,debugData:n.debugData,isInverted:i});if(o=[...o,...p||[]],a={...a,...n.mergeStyles},n.overrideStyles&&"object"==typeof n.overrideStyles&&(a={...n.overrideStyles}),a.data){for(const t in a.data)e.dataset[t]=a.data[t];delete a.data}e.style.cssText="";for(const t in a){const n=u(t);e.style.setProperty(n,a[t],"important")}e.dataset[`${n.matchType}Colored`]="true",e.dataset.username=t,e.dataset.contrastRatio=d;const f=l.prependIcon,m=l.appendIcon;if(f||m){e.dataset.iconApplied||(e.dataset.originalText=e.textContent,e.dataset.iconApplied="true");let t=e.dataset.originalText||e.textContent;f&&(t=f+" "+t),m&&(t=t+" "+m),e.textContent=t}else e.dataset.iconApplied&&(e.dataset.originalText&&(e.textContent=e.dataset.originalText),delete e.dataset.iconApplied,delete e.dataset.originalText);const h=D[t]?.userNotes;return h?(e.dataset.userNotes=h,e.classList.add("nc-has-notes"),e.dataset.notesListenerAttached||(e.addEventListener("mouseenter",me),e.addEventListener("mouseleave",he),e.dataset.notesListenerAttached="true")):(delete e.dataset.userNotes,e.classList.remove("nc-has-notes")),n.debugData&&(e.dataset.ncDebug=JSON.stringify(o),e.classList.add("nc-has-debug"),e.addEventListener("mouseenter",ue),e.addEventListener("mouseleave",ge)),e}let de=null;function ue(e){const t=e.currentTarget,n=JSON.parse(t.dataset.ncDebug||"[]");de||(de=document.createElement("div"),de.className="nc-debug-tooltip",document.body.appendChild(de)),de.innerHTML=n.map(([e,t])=>`<div class="nc-debug-row"><span class="nc-debug-label">${e}:</span> <span class="nc-debug-value">${"string"==typeof t&&t.startsWith("hsl")?`<span class="nc-debug-swatch" style="background:${t}"></span>${t}`:t}</span></div>`).join("");const o=t.getBoundingClientRect();de.style.left=o.left+"px",de.style.top=o.bottom+4+"px",de.classList.add("visible")}function ge(){de&&de.classList.remove("visible")}let pe=null,fe=null;function me(e){const t=e.currentTarget,n=t.dataset.userNotes;n&&(fe&&clearTimeout(fe),fe=setTimeout(()=>{pe||(pe=document.createElement("div"),pe.className="nc-notes-tooltip",document.body.appendChild(pe)),pe.textContent=n;const e=t.getBoundingClientRect();pe.style.left=e.left+"px",pe.style.top=e.bottom+4+"px",pe.classList.add("visible")},300))}function he(){fe&&(clearTimeout(fe),fe=null),pe&&pe.classList.remove("visible")}function be(e){return!!e&&(e.startsWith("@")&&(e=e.slice(1)),e=e.trim().toLowerCase(),!N.includes(e)&&!e.includes(" "))}function ve(){const e=E.join(", ");document.querySelectorAll(e).forEach(e=>{if(!function(e){if(e.dataset.nickColored)return!1;const t=e.textContent.trim();if(t.includes(" ")){const e=t.split(" ");if(2!==e.length||e[1].includes(" ")||0===e[1].length)return!1}const n=e.getAttribute("href")||"";return!((n.match(/\//g)||[]).length>1)&&(!(T.length>0&&!T.some(t=>e.closest(t)))&&(!(I.length>0&&I.some(t=>e.closest(t)))&&be(n.startsWith("/")?n.slice(1):n)))}(e))return;const t=function(e){const t=e.getAttribute("href");if(t&&t.startsWith("/")){const e=t.slice(1);if(!e.includes("/")&&!e.includes(".")){const e=t.match(/^\/([^\/\?#]+)/);if(e&&be(e[1]))return e[1]}}if(e.dataset.username&&be(e.dataset.username))return e.dataset.username;let n=e.textContent.trim();if(n.includes(" ")){const e=n.split(" ");n=e[e.length-1]}return n&&n.length<30&&(n.startsWith("@")&&(n=n.slice(1)),be(n))?n:null}(e);t&&ce(e,t)}),function(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:e=>{if(!e.textContent.includes("@"))return NodeFilter.FILTER_REJECT;if(e.parentElement?.closest("[data-mention-colored]"))return NodeFilter.FILTER_REJECT;if(e.parentElement?.closest("[data-nick-colored]"))return NodeFilter.FILTER_REJECT;if(e.parentElement?.closest(".nc-dialog-preview"))return NodeFilter.FILTER_REJECT;const t=e.parentElement?.tagName;return"SCRIPT"===t||"STYLE"===t||"TEXTAREA"===t||"INPUT"===t||I.length>0&&I.some(t=>e.parentElement?.closest(t))?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}}),t=[];let n;for(;n=e.nextNode();)t.push(n);t.forEach(e=>{const t=e.textContent,n=/@([a-zA-Z0-9_-]+)/g;let o;const i=[];for(;null!==(o=n.exec(t));){if(o.index>0&&/[a-zA-Z0-9._-]/.test(t[o.index-1]))continue;const e=t.slice(o.index+o[0].length);/^\.[a-zA-Z]/.test(e)||be(o[1])&&i.push({full:o[0],username:o[1],index:o.index})}if(0===i.length)return;const s=document.createDocumentFragment();let a=0;i.forEach(n=>{n.index>a&&s.appendChild(document.createTextNode(t.slice(a,n.index)));const o=document.createElement("span");o.textContent=n.full;const i=F.length>0&&!!e.parentElement?.closest(F.join(", "));ce(o,n.username,{matchType:"mention",isInverted:i}),s.appendChild(o),a=n.index+n.full.length}),a<t.length&&s.appendChild(document.createTextNode(t.slice(a))),e.parentNode.replaceChild(s,e)})}()}function ye(e){const{type:t="single",simple:n=!1,min:o=0,max:i=100,onChange:s,label:a}=e,r="range"===t,l=document.createElement("div");l.innerHTML=`\n\t\t${a?`<label>${a}</label>`:""}\n\t\t<div class="nc-slider${n?" nc-slider-simple":""}">\n\t\t\t<div class="nc-slider-track-mapped"></div>\n\t\t\t<div class="nc-slider-track"></div>\n\t\t\t${r?'<div class="nc-slider-thumb" data-i="0">▶</div><div class="nc-slider-thumb" data-i="1">◀</div>':'<div class="nc-slider-thumb" data-i="0"></div>'}\n\t\t</div>\n\t\t<div class="nc-slider-labels"><span></span>${r?"<span></span>":""}</div>\n\t`;const c=l.querySelector(".nc-slider-track"),d=l.querySelector(".nc-slider-track-mapped"),u=l.querySelectorAll(".nc-slider-thumb"),g=l.querySelectorAll(".nc-slider-labels span"),p=l.querySelector(".nc-slider");let f=r?[...e.values||[o,i]]:[e.value??o];function m(e){return(e-o)/(i-o)*100}function h(){u.forEach((e,t)=>e.style.left=m(f[t])+"%"),r?(g[0].contains(document.activeElement)||(g[0].textContent=`${f[0]}`),g[1].contains(document.activeElement)||(g[1].textContent=`${f[1]}`)):g[0].contains(document.activeElement)||(g[0].textContent=`${f[0]}`)}function b(e){if(r){const t=m(f[0]),n=m(f[1]),o=t>n,i=(e,t,n)=>{const[o,i,s,a,r]=e,[l,c,d,u,g]=t,p=g===r?0:(n-r)/(g-r);return[Math.round(o+p*(l-o)),Math.round(i+p*(c-i)),Math.round(s+p*(d-s)),a+p*(u-a),n]},s=t=>{for(let n=0;n<e.length-1;n++)if(t>=e[n][4]&&t<=e[n+1][4])return[e[n],e[n+1]];return[e[0],e[e.length-1]]},a=[],r=e.map(e=>e[4]);[...new Set([...r,t,n])].sort((e,t)=>e-t).forEach(e=>{const[r,l]=s(e),c=i(r,l,e);if(e===t||e===n)e===t?(a.push([...c.slice(0,3),.5,e]),a.push([...c.slice(0,3),1,e])):(a.push([...c.slice(0,3),1,e]),a.push([...c.slice(0,3),.5,e]));else{const i=o?e>=t||e<=n:e>=t&&e<=n;a.push([...c.slice(0,3),i?c[3]:.5,e])}}),e=a}c.style.background=`linear-gradient(to right, ${e.map(e=>{const[t,n,o,i=1,s=null]=e;let a=`hsla(${t}, ${n}%, ${o}%, ${i})`;return null!==s&&(a+=` ${s}%`),a}).join(", ")})`}g.forEach((e,t)=>{return a=t,(n=e).style.cursor="pointer",n.title="Click to edit",void n.addEventListener("click",e=>{if(n.querySelector("input"))return;const t=f[a],l=document.createElement("input");l.type="number",l.min=o,l.max=i,l.value=t,l.style.cssText="width: 4em; text-align: center; font-size: inherit; padding: 0 0.25em; background: var(--nc-bg); border: 1px solid var(--nc-border); color: var(--nc-fg);",n.textContent="",n.appendChild(l),l.focus(),l.select(),l.addEventListener("blur",()=>{let e=parseInt(l.value,10);isNaN(e)&&(e=t),e=Math.max(o,Math.min(i,e)),f[a]=e,n.textContent=`${e}`,h(),s?.(r?[...f]:f[0])}),l.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),l.blur()):"Escape"===e.key&&(n.textContent=`${t}`)})});var n,a});let v=null;function y(e){const t=p.getBoundingClientRect(),n=(e.clientX??e.touches?.[0]?.clientX)-t.left;return s=Math.max(0,Math.min(100,n/t.width*100)),Math.round(o+s/100*(i-o));var s}function x(e){const t=e.target.closest(".nc-slider-thumb");t&&(v=+t.dataset.i,e.preventDefault())}function C(e){null!==v&&(f[v]=y(e),h(),s?.(r?[...f]:f[0]))}function S(){v=null}function k(e){return`linear-gradient(to right, ${e.map(e=>{const[t,n,o,i=1,s=null]=e;let a=`hsla(${t}, ${n}%, ${o}%, ${i})`;return null!==s&&(a+=` ${s}%`),a}).join(", ")})`}return p.addEventListener("mousedown",x),document.addEventListener("mousemove",C),document.addEventListener("mouseup",S),p.addEventListener("touchstart",x,{passive:!1}),document.addEventListener("touchmove",C,{passive:!1}),document.addEventListener("touchend",S),c.addEventListener("click",e=>{const t=y(e);if(r){const e=Math.abs(t-f[0]),n=Math.abs(t-f[1]);f[e<=n?0:1]=t}else f[0]=t;h(),s?.(r?[...f]:f[0])}),e.gradient&&b(e.gradient),h(),{el:l,getValue:()=>f[0],getValues:()=>[...f],setValue:e=>{f[0]=e,h()},setValues:e=>{f=[...e],h()},setGradient:b,setSplitGradient:function(e,t){if(!e)return p.classList.remove("nc-slider-split"),void(d.style.background="");p.classList.add("nc-slider-split"),d.style.background=k(e),c.style.background=k(t)},setThumbColor:function(e){const t=Array.isArray(e)?e:[e];u.forEach((e,n)=>{t[n]&&(e.style.background=t[n])})}}}function xe(e){const{label:t,id:n,type:o="text",value:i="",placeholder:s="",hint:a="",classes:r="",options:l,checked:c=!1,disabled:d=!1,state:u=null,defaultLabel:g="",buttonText:p="",stacked:f=!1}=e;if(f||["text","textarea","select"].includes(o)){let e;return e="textarea"===o?`<textarea id="${n}" placeholder="${s}">${i}</textarea>`:"select"===o&&l?`<select id="${n}">${l}</select>`:`<input type="${o}" id="${n}" value="${i}" placeholder="${s}">`,`\n\t\t\t<div class="${"nc-input-row-stacked"+(r?" "+r:"")}">\n\t\t\t\t${t?`<label for="${n}">${t}</label>`:""}\n\t\t\t\t${e}\n\t\t\t\t${a?`<div class="hint">${a}</div>`:""}\n\t\t\t</div>\n\t\t`}if("toggle"===o)return`\n\t\t\t<div class="${"nc-input-row nc-flex nc-items-center nc-justify-between nc-gap-4 nc-toggle"+(r?" "+r:"")}">\n\t\t\t\t<label>${t}</label>\n\t\t\t\t<label class="nc-toggle-label">\n\t\t\t\t\t<div class="nc-toggle-value">${c?"true":"false"}</div>\n\t\t\t\t\t<input type="checkbox" id="${n}" class="nc-sr-only" ${c?"checked":""} ${d?"disabled":""}>\n\t\t\t\t\t<div class="nc-toggle-track${c?" active":""}">\n\t\t\t\t\t\t<div class="nc-toggle-thumb ${c?"pos-end":"pos-start"}"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t`;if("tristate"===o){const e=!0===u;return`\n\t\t\t<div class="${"nc-input-row nc-flex nc-items-center nc-justify-between nc-gap-4 nc-toggle nc-tristate-toggle"+(r?" "+r:"")}">\n\t\t\t\t<label>${t}${g?` <span class="nc-text-dim">(default: ${g})</span>`:""}</label>\n\t\t\t\t<label class="nc-toggle-label">\n\t\t\t\t\t<div class="nc-toggle-value">${!0===u?"true":!1===u?"false":"auto"}</div>\n\t\t\t\t\t<input type="checkbox" id="${n}" class="nc-sr-only" ${e?"checked":""}>\n\t\t\t\t\t<div class="nc-toggle-track${e?" active":""}">\n\t\t\t\t\t\t<div class="nc-toggle-thumb ${!0===u?"pos-end":!1===u?"pos-start":"pos-middle"}"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t`}return"button"===o?`\n\t\t\t<div class="${"nc-input-row nc-flex nc-items-center nc-justify-between nc-gap-4"+(r?" "+r:"")}">\n\t\t\t\t<label>${t}</label>\n\t\t\t\t<button id="${n}" class="nc-inline-btn nc-flex-shrink-0">${p}</button>\n\t\t\t</div>\n\t\t`:""}function Ce(t){C();const{title:n,content:o,buttons:i=[],width:s="400px",onClose:a,onSettings:r,preview:l=""}=t,c=document.createElement("div");c.className="nc-dialog-overlay",c.innerHTML=`\n\t\t<div class="nc-dialog" style="min-width: ${s}; max-width: calc(${s} + 100px);">\n\t\t\t<div class="nc-dialog-header nc-flex nc-justify-between">\n\t\t\t\t<h3>${n}</h3>\n\t\t\t\t<div class="spacer"></div>\n\t\t\t\t${r?'<button class="nc-header-settings link-brackets"><span class="inner">SETTINGS</span></button>':""}\n\t\t\t\t<button class="nc-header-help link-brackets"><span class="inner">?</span></button>\n\t\t\t\t<button class="nc-header-close link-brackets"><span class="inner">ESC</span></button>\n\t\t\t</div>\n\t\t\t${l?`<div class="nc-dialog-preview">${l}</div>`:""}\n\t\t\t<div class="nc-dialog-content">\n\t\t\t\t${o}\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-footer">\n\t\t\t\t<div class="nc-dialog-warning hint">\n\t\t\t\t\tThis is a custom userscript. Do NOT report issues to the creator of Cyberspace. Use the [SETTINGS] -> [REPORT ISSUE] button.\n\t\t\t\t</div>\n\t\t\t\t<div class="nc-dialog-attribution hint">\n\t\t\t\t\t<span>created by <a href="/z0ylent">@z0ylent</a></span>\n\t\t\t\t\t<span><a href="https://z0m.bi" target="_blank">https://z0m.bi</a></span>\n\t\t\t\t\t<span><a class="github-link" href="https://github.com/z0mbieparade/cyberspace-nick-colors" target="_blank" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" height="14px"> <path fill="currentColor" d="M5 2h4v2H7v2H5V2Zm0 10H3V6h2v6Zm2 2H5v-2h2v2Zm2 2v-2H7v2H3v-2H1v2h2v2h4v4h2v-4h2v-2H9Zm0 0v2H7v-2h2Zm6-12v2H9V4h6Zm4 2h-2V4h-2V2h4v4Zm0 6V6h2v6h-2Zm-2 2v-2h2v2h-2Zm-2 2v-2h2v2h-2Zm0 2h-2v-2h2v2Zm0 0h2v4h-2v-4Z"/> </svg></a></span>\n\t\t\t\t\t<span>v${e}</span>\n\t\t\t\t</div>\n\t\t\t\t<hr />\n\t\t\t\t<div class="buttons nc-flex nc-flex-wrap nc-items-center nc-gap-2">\n\t\t\t\t\t${i.map(e=>`<button class="${e.class||""} link-brackets"><span class="inner">${e.label}</span></button>`).join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`;const d=()=>{c.remove(),a?.()};i.forEach(e=>{const t=c.querySelector(`.nc-dialog-footer button.${e.class}`);t&&e.onClick&&t.addEventListener("click",()=>e.onClick(d))});const u=c.querySelector(".nc-header-close");u&&u.addEventListener("click",d);const g=c.querySelector(".nc-header-settings");g&&r&&g.addEventListener("click",()=>{d(),r()});const p=c.querySelector(".nc-header-help");p&&p.addEventListener("click",Se);let f=!1;return c.addEventListener("mousedown",e=>{f=e.target===c}),c.addEventListener("click",e=>{e.target===c&&f&&d(),f=!1}),c.addEventListener("keydown",e=>{"Escape"===e.key&&d()}),c.setAttribute("tabindex","-1"),document.body.appendChild(c),c.focus(),{el:c,close:d,querySelector:e=>c.querySelector(e),querySelectorAll:e=>c.querySelectorAll(e)}}function Se(){const e=document.createElement("div");e.className="nc-dialog-overlay",e.innerHTML='\n\t\t<div class="nc-dialog" style="min-width: 420px; max-width: 520px;">\n\t\t\t<div class="nc-dialog-header nc-flex nc-justify-between">\n\t\t\t\t<h3>Nick Colors - Help</h3>\n\t\t\t\t<div class="spacer"></div>\n\t\t\t\t<button class="nc-header-close link-brackets"><span class="inner">ESC</span></button>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-content nc-help-content">\n\t\t\t\t<h4>What is this?</h4>\n\t\t\t\t<p>A userscript that gives each username a unique, consistent color based on a hash of their name. Colors persist across sessions and pages.</p>\n\n\t\t\t\t<h4>Quick Start</h4>\n\t\t\t\t<ul>\n\t\t\t\t\t<li><strong>Right-click any username</strong> to customize its color, icon, or style</li>\n\t\t\t\t\t<li><strong>Use the SETTINGS button</strong> to configure global color ranges and options</li>\n\t\t\t\t</ul>\n\n\t\t\t\t<h4>Settings Overview</h4>\n\t\t\t\t<ul>\n\t\t\t\t\t<li><strong>Preset Themes</strong> - Match colors to site themes (VT320, Poetry, etc.)</li>\n\t\t\t\t\t<li><strong>Monochrome Mode</strong> - Use one color for all usernames</li>\n\t\t\t\t\t<li><strong>H/S/L Ranges</strong> - Limit hue, saturation, and lightness ranges</li>\n\t\t\t\t\t<li><strong>Contrast Threshold</strong> - Auto-invert colors for readability (WCAG ratios)</li>\n\t\t\t\t\t<li><strong>Style Variations</strong> - Add bold, italic, small-caps, or icons</li>\n\t\t\t\t</ul>\n\n\t\t\t\t<h4>Per-User Customization</h4>\n\t\t\t\t<ul>\n\t\t\t\t\t<li><strong>Color</strong> - Set via sliders or custom hex/hsl value</li>\n\t\t\t\t\t<li><strong>Icons</strong> - Prepend/append symbols (auto, custom, or disabled)</li>\n\t\t\t\t\t<li><strong>Styles</strong> - Override weight, italic, small-caps per user</li>\n\t\t\t\t\t<li><strong>Inversion</strong> - Force or prevent background inversion</li>\n\t\t\t\t\t<li><strong>Custom CSS</strong> - Add any additional styles</li>\n\t\t\t\t</ul>\n\n\t\t\t\t<h4>Tips</h4>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Colors are mapped proportionally to your configured ranges</li>\n\t\t\t\t\t<li>Site-wide overrides are loaded in remote from github, but can be overridden locally</li>\n\t\t\t\t\t<li>Export your settings to back them up or share with others</li>\n\t\t\t\t</ul>\n\n\t\t\t\t<h4>Bugs</h4>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Report issues either on <a href="https://github.com/z0mbieparade/cyberspace-nick-colors/issues" target="_blank" rel="noopener noreferrer">GitHub</a></li>\n\t\t\t\t\t<li>Or use the [SETTINGS] -> [REPORT ISSUE] button</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-footer">\n\t\t\t\t<div class="buttons nc-flex nc-items-center nc-gap-2">\n\t\t\t\t\t<button class="nc-close-btn link-brackets"><span class="inner">CLOSE</span></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t';const t=()=>e.remove();e.querySelector(".nc-header-close").addEventListener("click",t),e.querySelector(".nc-close-btn").addEventListener("click",t),e.addEventListener("click",n=>{n.target===e&&t()}),e.addEventListener("keydown",e=>{"Escape"===e.key&&t()}),e.setAttribute("tabindex","-1"),document.body.appendChild(e),e.focus()}function ke(e){const{schema:t,values:n={},defaults:o={},onChange:i,container:s}=e,a={},r={};function l(e){if(!e)return!0;if(void 0!==e.field){const t=a[e.field];return!t||t.value===e.is}return e.any?e.any.some(e=>l(e)):!e.all||e.all.every(e=>l(e))}function c(e){const t=a[e];if(!t||!t.definition.showWhen)return;const n=l(t.definition.showWhen);t.wrapper&&(t.wrapper.style.display=n?"":"none")}function d(e){(r[e]||[]).forEach(e=>c(e))}function u(e,t){if(!t)return;const n=t=>{t.field&&(r[t.field]||(r[t.field]=[]),r[t.field].includes(e)||r[t.field].push(e)),t.any&&t.any.forEach(n),t.all&&t.all.forEach(n)};n(t)}function g(e,t,n=!0){const o=a[e];o&&(o.value=t,function(e,t){const n=a[e];if(!n)return;const{definition:o,element:i,slider:s}=n;switch(o.type){case"toggle":i&&(i.checked=!!t,function(e){const t=e.closest(".nc-toggle");if(!t)return;const n=e.checked,o=t.querySelector(".nc-toggle-value"),i=t.querySelector(".nc-toggle-track"),s=t.querySelector(".nc-toggle-thumb");o&&(o.textContent=n?"true":"false"),i&&i.classList.toggle("active",n),s&&(s.classList.toggle("pos-end",n),s.classList.toggle("pos-start",!n))}(i));break;case"tristate":i&&(i.dataset.tristateValue=null===t?"null":String(t),function(e,t){const n=e.closest(".nc-tristate-toggle");if(!n)return;const o=!0===t?"true":!1===t?"false":"auto",i=n.querySelector(".nc-toggle-value"),s=n.querySelector(".nc-toggle-track"),a=n.querySelector(".nc-toggle-thumb");i&&(i.textContent=o),s&&s.classList.toggle("active",!0===t),a&&(a.classList.remove("pos-start","pos-middle","pos-end"),a.classList.add(!0===t?"pos-end":!1===t?"pos-start":"pos-middle"))}(i,t));break;case"slider":s&&s.setValue(t);break;case"range":s&&s.setValues(t);break;case"text":case"textarea":case"select":i&&(i.value=t||"")}}(e,t),n&&(d(e),o.definition.onChange?.(t,h),i?.(e,t,h)))}function p(e,t){const{key:o,type:i,label:s,hint:r,showWhen:l}=e,c=document.createElement("div");c.className="nc-settings-field",o&&(c.dataset.fieldKey=o);const d=o?void 0!==n[o]?n[o]:e.default:void 0;let p=null,f=null;switch(i){case"toggle":c.innerHTML=xe({type:"toggle",label:e.label,id:`settings-${o}`,checked:!!d,disabled:"function"==typeof e.disabled?e.disabled(n):e.disabled}),p=c.querySelector(`#settings-${o}`),p&&p.addEventListener("change",()=>{g(o,p.checked)});break;case"tristate":c.innerHTML=xe({type:"tristate",label:e.label,id:`settings-${o}`,state:d,defaultLabel:e.defaultLabel||""}),p=c.querySelector(`#settings-${o}`),p&&(p.dataset.tristateValue=null===d?"null":String(d),p.addEventListener("click",e=>{e.preventDefault();const t=a[o].value;g(o,null===t||!0!==t&&null)}));break;case"slider":f=ye({type:"single",simple:!1!==e.simple,min:e.min??0,max:e.max??100,step:e.step??1,value:d??e.default??e.min??0,label:e.label,onChange:e=>g(o,e)}),c.appendChild(f.el);break;case"range":f=ye({type:"range",min:e.min??0,max:e.max??100,values:d??e.default??[e.min??0,e.max??100],label:e.label,onChange:e=>g(o,e)}),c.appendChild(f.el);break;case"text":c.innerHTML=xe({type:"text",label:e.label,id:`settings-${o}`,value:d||"",placeholder:e.placeholder||""}),p=c.querySelector(`#settings-${o}`),p&&p.addEventListener("input",()=>{g(o,p.value)});break;case"textarea":c.innerHTML=xe({type:"textarea",label:e.label,id:`settings-${o}`,value:d||"",placeholder:e.placeholder||""}),p=c.querySelector(`#settings-${o}`),p&&p.addEventListener("input",()=>{g(o,p.value)});break;case"select":{const t=e.options.map(e=>"string"==typeof e?`<option value="${e}">${e}</option>`:`<option value="${e.value}">${e.label}</option>`).join("");c.innerHTML=xe({type:"select",label:e.label,id:`settings-${o}`,options:t}),p=c.querySelector(`#settings-${o}`),p&&(p.value=d||"",p.addEventListener("change",()=>{g(o,p.value)}));break}case"button":c.innerHTML=xe({type:"button",label:e.label,id:`settings-${o||e.id}`,buttonText:e.buttonText||e.label}),p=c.querySelector(`#settings-${o||e.id}`),p&&e.onClick&&p.addEventListener("click",()=>e.onClick(h));break;case"custom":if(e.render){const t=e.render(d,h);t&&c.appendChild(t)}break;case"hint":c.innerHTML=`<div class="hint">${e.text||e.label}</div>`;break;case"hr":c.innerHTML="<hr />"}if(r&&"hint"!==i){const e=document.createElement("div");e.className="hint",e.innerHTML=r,c.appendChild(e)}return o&&(a[o]={value:d,element:p,slider:f,wrapper:c,definition:e},l&&u(o,l)),t.appendChild(c),c}function f(e,t){const n=document.createElement("div");n.className="nc-settings-section-wrapper";const o=document.createElement("div");if(o.className="nc-settings-section",e.label){const t=document.createElement("h4");t.innerHTML=e.label,o.appendChild(t)}if(e.hint){const t=document.createElement("div");t.className="hint",t.innerHTML=e.hint,o.appendChild(t)}if(e.fields&&e.fields.forEach(e=>{"section"===e.type?f(e,o):p(e,o)}),n.appendChild(o),!e.noHr){const e=document.createElement("hr");n.appendChild(e)}if(t.appendChild(n),e.showWhen){const t=`_section_${e.label||Math.random()}`;a[t]={value:null,element:null,slider:null,wrapper:n,definition:e},u(t,e.showWhen)}return n}function m(e,t=!1){Object.keys(e).forEach(n=>{a[n]&&g(n,e[n],t)}),Object.keys(a).forEach(e=>c(e))}const h={render:function(){s&&(t.forEach(e=>{"section"===e.type?f(e,s):p(e,s)}),Object.keys(a).forEach(e=>{c(e)}))},getValues:function(){const e={};return Object.keys(a).forEach(t=>{const n=a[t];n&&"button"!==n.definition.type&&(e[t]=n.value)}),e},setValues:m,reset:function(){const e={...o},n=t=>{t.forEach(t=>{"section"===t.type&&t.fields?n(t.fields):t.key&&void 0!==t.default&&void 0===e[t.key]&&(e[t.key]=t.default)})};n(t),m(e,!0)},getField:function(e){const t=a[e];return t?{element:t.element,wrapper:t.wrapper,getValue:()=>t.value,setValue:t=>g(e,t),setGradient:t.slider?.setGradient,setSplitGradient:t.slider?.setSplitGradient,setThumbColor:t.slider?.setThumbColor,setValues:t.slider?.setValues,getValues:t.slider?.getValues}:null},destroy:function(){s&&(s.innerHTML=""),Object.keys(a).forEach(e=>delete a[e]),Object.keys(r).forEach(e=>delete r[e])},fields:a,setFieldValue:g,getFieldValue:function(e){const t=a[e];if(t)return t.value},updateDependencies:d};return h}function $e(e,t){const n=y(),o=["color","icon","fontWeight","fontStyle","fontVariant","fontFamily","invert"],i=f(Object.fromEntries(Object.entries(ie(t)).filter(([e])=>!o.includes(e))),";\n"),a=D[e]||{},r=a.prependIcon??"",l=a.appendIcon??"",c="prependIcon"in a?!!r:null,d="appendIcon"in a?!!l:null,u=ae(e,{effectiveConfig:n})||"",g=re(e),b=g.fontWeight,C=g.fontStyle,$=g.fontVariant,L=D[e]||{},E=L.fontWeight,T=L.fontStyle,I=L.fontVariant,N=L.invert,F=L.fontFamily||"",V=L.userNotes||"",H=w[e];let M="";if(H){const t=w[e];M="string"==typeof t?`color: ${t}`:f(t)}const O=0!==n.minHue||360!==n.maxHue,j=0!==n.minSaturation||100!==n.maxSaturation,R=0!==n.minLightness||100!==n.maxLightness,q=O||j||R,W=se(e,"hsl",{effectiveConfig:n}),B=v(W,"hsl",{effectiveConfig:n});let G="hash-generated",P="";D[e]?(G="customNickColors (local save)",P=JSON.stringify(D[e])):w[e]&&(G="MANUAL_OVERRIDES (remote)",P=JSON.stringify(w[e]));const _=x(e),J=x(e+"_sat"),Z=x(e+"_lit"),oe=x(e+"_style"),le=e=>A.iconSet?`<div class="picker-icon-options" data-target="${e}" style="display: flex; flex-wrap: wrap; gap: 0.25em; margin-bottom: 0.5rem;">${A.iconSet.split(/\s+/).filter(Boolean).map(e=>`<span class="nc-icon-option" style="cursor: pointer; padding: 0.2em 0.4em; border: 1px solid var(--nc-border); border-radius: var(--radius-md); transition: background 0.15s, border-color 0.15s;" title="Click to select">${e}</span>`).join("")}</div>`:"",de=Ce({title:`Nick: ${e}`,width:"350px",onSettings:()=>we(),preview:`<div class="preview">&lt;<span id="picker-preview">${e}</span>&gt; Example chat message in cIRC<br />Inline mention <span id="picker-preview-mention">@${e}</span> example</div>\n\t\t\t<div class="preview preview-inverted" id="picker-preview-inverted">&lt;<span id="picker-preview-inverted-nick">${e}</span>&gt; Inverted container preview</div>`,content:`\n\t\t\t${te({"Color Source":G,"Saved Data":P,"Hash Values":`h:${_} s:${J} l:${Z} style:${oe}`,"Base Color (raw)":{txt:`H:${W.h.toFixed(1)} S:${W.s.toFixed(1)} L:${W.l.toFixed(1)}`,elem:`<span class="nc-debug-color" style="background-color: hsl(${W.h}, ${W.s}%, ${W.l}%)">BASE</span>`},"Mapped Color":{txt:`H:${B.h.toFixed(1)} S:${B.s.toFixed(1)} L:${B.l.toFixed(1)}`,elem:`<span class="nc-debug-color" style="background-color: hsl(${B.h}, ${B.s}%, ${B.l}%)">MAPPED</span>`},"Effective Config":{txt:`H:${n.minHue}-${n.maxHue} S:${n.minSaturation}-${n.maxSaturation} L:${n.minLightness}-${n.maxLightness}`,elem:`<span class="nc-debug-color" style="background-color: hsl(${n.minHue}, ${n.minSaturation}%, ${n.minLightness}%)">MIN</span>-<span class="nc-debug-color" style="background-color: hsl(${n.maxHue}, ${n.maxSaturation}%, ${n.maxLightness}%)">MAX</span>`},"Style Variations":`weight:${b} italic:${C} case:${$}`})}\n\t\t\t${H?`<div class="hint">Site-wide override: <code style="background: var(--nc-code-bg); padding: 0.1em 0.3em;">${M}</code><br>Your changes will override this locally.</div>`:""}\n\t\t\t${n.useSingleColor?'\n\t\t\t<div class="nc-dialog-info" style="padding: 0.5rem;">\n\t\t\t\tPer-user color customization is disabled. Monochrome mode is enabled.<br>\n\t\t\t\t<button class="link-brackets" id="picker-open-settings" style="margin-top: 0.5rem;"><span class="inner">Change in Settings</span></button>\n\t\t\t</div>\n\t\t\t':`\n\t\t\t<h4>Nick Color</h4>\n\t\t\t<div id="picker-sliders"></div>\n\t\t\t${xe({label:"Custom color value:",id:"picker-custom",placeholder:"#ff6b6b or hsl(280, 90%, 65%)",classes:"no-padding-bottom"})}\n\t\t\t${q?'<div class="hint">Color range is restricted. Preview shows mapped result. Click SETTINGS to adjust.</div>':""}\n\t\t\t`}\n\t\t\t<div id="picker-engine-container"></div>\n\t\t`,buttons:[{label:"Save",class:"save",onClick:t=>{const n=Ee(),o={...p(be.getFieldValue("customCss")||"")};n&&(o.color=n);const i=be.getFieldValue("prependIconEnabled");!0===i?o.prependIcon=be.getFieldValue("prependIcon")?.trim()||"":!1===i&&(o.prependIcon="");const s=be.getFieldValue("appendIconEnabled");!0===s?o.appendIcon=be.getFieldValue("appendIcon")?.trim()||"":!1===s&&(o.appendIcon="");const a=be.getFieldValue("fontWeight"),r=be.getFieldValue("fontStyle"),l=be.getFieldValue("fontVariant"),c=be.getFieldValue("invert");null!==a&&(o.fontWeight=a?"bold":"normal"),null!==r&&(o.fontStyle=r?"italic":"normal"),null!==l&&(o.fontVariant=l?"small-caps":"normal"),null!==c&&(o.invert=c);const d=be.getFieldValue("fontFamily")?.trim();d&&(o.fontFamily=d);const u=be.getFieldValue("userNotes")?.trim();u&&(o.userNotes=u),D[e]=o,z(),S(),t()}},{label:"Reset",class:"reset",onClick:t=>{delete D[e],z(),S(),t()}},{label:"Cancel",class:"cancel",onClick:e=>e()}]}),ue=de.querySelector("#picker-preview"),ge=de.querySelector("#picker-preview-mention"),pe=de.querySelector("#picker-preview-inverted-nick"),fe=de.querySelector("#picker-custom"),me=de.querySelector("#picker-sliders"),he=de.querySelector("#picker-engine-container"),be=ke({schema:[{type:"hr"},{type:"section",label:"Notes",hint:"Personal notes about this user (visible on hover)",fields:[{key:"userNotes",type:"textarea",label:"",default:V,placeholder:"Add personal notes about this user..."}]},{type:"section",label:"Custom Icons",hint:"Prepend/Append a custom character or emoji to the nickname.",fields:[{key:"prependIconEnabled",type:"tristate",label:"Prepend icon",default:c,defaultLabel:u},{key:"prependIconPicker",type:"custom",showWhen:{field:"prependIconEnabled",is:!0},render:()=>{const e=document.createElement("div");return e.innerHTML=le("settings-prependIcon"),e}},{key:"prependIcon",type:"text",label:"",default:r,placeholder:"custom icon before nickname",showWhen:{field:"prependIconEnabled",is:!0}},{key:"appendIconEnabled",type:"tristate",label:"Append icon",default:d,defaultLabel:u},{key:"appendIconPicker",type:"custom",showWhen:{field:"appendIconEnabled",is:!0},render:()=>{const e=document.createElement("div");return e.innerHTML=le("settings-appendIcon"),e}},{key:"appendIcon",type:"text",label:"",default:l,placeholder:"custom icon after nickname",showWhen:{field:"appendIconEnabled",is:!0}}]},{type:"section",label:"Style Variations",hint:"Override the global style settings for this user to add some visual flair.",fields:[{key:"fontWeight",type:"tristate",label:"Bold",default:"bold"===E||"normal"!==E&&null,defaultLabel:b},{key:"fontStyle",type:"tristate",label:"Italic",default:"italic"===T||"normal"!==T&&null,defaultLabel:C},{key:"fontVariant",type:"tristate",label:"Small Caps",default:"small-caps"===I||"normal"!==I&&null,defaultLabel:$},{key:"invert",type:"tristate",label:"Invert",default:!0===N||!1!==N&&null,defaultLabel:"auto"},{key:"fontFamily",type:"text",label:"Font Family",default:F,placeholder:"Comic Sans MS, cursive"}]},{type:"section",label:"Additional CSS",fields:[{key:"customCss",type:"textarea",label:"",default:i,placeholder:"background-color: #1a1a2e;\ntext-decoration: underline;",hint:"CSS properties, one per line"}]},{type:"section",label:"Backup",fields:[{key:"exportFile",type:"button",label:"Export user settings to file",buttonText:"Save Settings File",onClick:()=>{const t={[e]:Ie()},n=(new Date).toISOString().slice(0,10);X(t,`nick-colors-${e}-${n}.json`)}},{key:"exportCopy",type:"button",label:"Export user settings to clipboard",buttonText:"Copy to Clipboard",onClick:async()=>{const t={[e]:Ie()};try{await K(t),alert("Copied to clipboard!")}catch(e){alert(e.message)}}},{key:"importFile",type:"button",label:"Import user settings from file",buttonText:"Load Settings File",onClick:()=>{Y((t,n)=>{if(n)return void alert(n.message);const o=t[e]||Object.values(t)[0];o?(Ne(o),alert("Settings imported!")):alert("No valid user settings found in file")})}},{key:"importPaste",type:"button",label:"Import user settings from clipboard",buttonText:"Paste from Clipboard",onClick:()=>{Q((t,n)=>{if(n)return void alert(n.message);const o=t[e]||Object.values(t)[0];o?(Ne(o),alert("Settings imported!")):alert("No valid user settings found in clipboard")})}}]},{type:"section",label:"Request Override",noHr:!0,hint:"If you want your nickname to show up the same for everyone using the Nick Colors script, you can request an override. If the button below doesn't work, you can click 'Copy to Clipboard' above, and send it manually to <a href=\"/z0ylent\">@z0ylent</a>.",fields:[{key:"requestOverride",type:"button",label:"Message @z0ylent to request override",buttonText:"Request Override",onClick:()=>{const t={[e]:Ie()};ee("z0ylent",`Hi! I'd like to request a site-wide nick color override: ${JSON.stringify(U(t))}`)}}]}],values:{},onChange:()=>Te(),container:he});be.render();let ve=null,Se=null,$e=null;if(me&&!n.useSingleColor){const e=O?`Hue <span class="nc-slider-values"></span> <span>→ mapped to ${n.minHue}-${n.maxHue}</span>`:'Hue <span class="nc-slider-values"></span>',t=j?`Sat <span class="nc-slider-values"></span> <span>→ mapped to ${n.minSaturation}-${n.maxSaturation}</span>`:'Sat <span class="nc-slider-values"></span>',o=R?`Lit <span class="nc-slider-values"></span> <span>→ mapped to ${n.minLightness}-${n.maxLightness}</span>`:'Lit <span class="nc-slider-values"></span>';ve=ye({label:e,min:0,max:360,value:180,onChange:()=>{fe.value="",Te()}}),Se=ye({label:t,min:0,max:100,value:85,onChange:()=>{fe.value="",Te()}}),$e=ye({label:o,min:0,max:100,value:65,onChange:()=>{fe.value="",Te()}}),me.append(ve.el,Se.el,$e.el)}const Le=de.querySelector("#picker-open-settings");function Ee(){return n.useSingleColor||!ve?fe?.value?.trim()||null:fe.value.trim()||`hsl(${ve.getValue()}, ${Se.getValue()}%, ${$e.getValue()}%)`}function Te(){!function(){if(!ve||!Se||!$e)return;const e=ve.getValue(),t=Se.getValue(),o=$e.getValue(),i=m(e,n.minHue,n.maxHue),s=h(t,n.minSaturation,n.maxSaturation),a=h(o,n.minLightness,n.maxLightness),r=Array.from({length:13},(e,n)=>{const i=30*n;return[i,t,o,1,i/360*100]});if(O){const e=[];for(let t=0;t<=36;t++){const o=10*t,i=m(o,n.minHue,n.maxHue),r=o/360*100;e.push([i,s,a,1,r])}ve.setSplitGradient(e,r)}else ve.setSplitGradient(null),ve.setGradient(r);const l=[[e,0,o,1,0],[e,100,o,1,100]];if(j){const e=[[i,n.minSaturation,a,1,0],[i,n.maxSaturation,a,1,100]];Se.setSplitGradient(e,l)}else Se.setSplitGradient(null),Se.setGradient(l);const c=[[e,t,0,1,0],[e,t,50,1,50],[e,t,100,1,100]];if(R){const e=[[i,s,n.minLightness,1,0],[i,s,n.maxLightness,1,100]];$e.setSplitGradient(e,c)}else $e.setSplitGradient(null),$e.setGradient(c);const d=`hsl(${i}, ${s}%, ${a}%)`;ve.setThumbColor(d),Se.setThumbColor(d),$e.setThumbColor(d);const u=ve.el.querySelector(".nc-slider-values"),g=Se.el.querySelector(".nc-slider-values"),p=$e.el.querySelector(".nc-slider-values");u&&(u.textContent=`[${Math.round(e)} → ${Math.round(i)}]`),g&&(g.textContent=`[${Math.round(t)} → ${Math.round(s)}]`),p&&(p.textContent=`[${Math.round(o)} → ${Math.round(a)}]`);const f=ne(ve.el),b=ne(Se.el),v=ne($e.el),y=n.maxHue-n.minHue,x=e/360;f.textContent=`t=${x.toFixed(3)} | ${n.minHue} + ${x.toFixed(3)} * (${n.maxHue} - ${n.minHue}) = ${n.minHue} + ${x.toFixed(3)} * ${y} = ${(n.minHue+x*y).toFixed(1)}`;const C=n.maxSaturation-n.minSaturation,S=t/100;b.textContent=`t=${S.toFixed(3)} | ${n.minSaturation} + ${S.toFixed(3)} * (${n.maxSaturation} - ${n.minSaturation}) = ${(n.minSaturation+S*C).toFixed(1)}`;const k=n.maxLightness-n.minLightness,$=o/100;v.textContent=`t=${$.toFixed(3)} | ${n.minLightness} + ${$.toFixed(3)} * (${n.maxLightness} - ${n.minLightness}) = ${(n.minLightness+$*k).toFixed(1)}`}();const t=Ee(),o=be.getFieldValue("prependIconEnabled"),i=be.getFieldValue("appendIconEnabled"),s=be.getFieldValue("fontWeight"),a=be.getFieldValue("fontStyle"),r=be.getFieldValue("fontVariant"),l=be.getFieldValue("invert"),c={...p(be.getFieldValue("customCss")||"")};t&&(c.color=t),!0===o?c.prependIcon=(be.getFieldValue("prependIcon")||"").trim():!1===o&&(c.prependIcon=""),!0===i?c.appendIcon=(be.getFieldValue("appendIcon")||"").trim():!1===i&&(c.appendIcon=""),null!==s&&(c.fontWeight=s?"bold":"normal"),null!==a&&(c.fontStyle=a?"italic":"normal"),null!==r&&(c.fontVariant=r?"small-caps":"normal"),null!==l&&(c.invert=l);const d=be.getFieldValue("fontFamily")?.trim();d&&(c.fontFamily=d);const g=D[e];D[e]=c;const f={...A};Object.assign(A,n),A.useSiteThemeHue=!1,A.useSiteThemeSat=!1,A.useSiteThemeLit=!1;let b="",v="";!0===o?b=(be.getFieldValue("prependIcon")||"").trim():null===o&&A.prependIcon&&(b=u),!0===i?v=(be.getFieldValue("appendIcon")||"").trim():null===i&&A.appendIcon&&(v=u);const y=(t,n,o=!1)=>{t.style.cssText="",ce(t,e,{matchType:n?"mention":"nick",isInverted:o,debugData:k,mergeStyles:{prependIcon:b,appendIcon:v}})};y(ue,!1,!1),ge&&y(ge,!0,!1),pe&&y(pe,!1,!0),Object.assign(A,f),void 0!==g?D[e]=g:delete D[e]}if(Le&&Le.addEventListener("click",()=>{de.close(),we()}),t.color&&ve&&Se&&$e){const e=s(t.color,"hsl");e?(ve.setValue(e.h),Se.setValue(e.s),$e.setValue(e.l)):fe&&(fe.value=t.color)}function Ie(){const e=Ee(),t=be.getFieldValue("prependIconEnabled"),n=be.getFieldValue("appendIconEnabled"),o=be.getFieldValue("fontWeight"),i=be.getFieldValue("fontStyle"),s=be.getFieldValue("fontVariant"),a=be.getFieldValue("invert"),r={...p(be.getFieldValue("customCss")||"")};e&&(r.color=e),!0===t?r.prependIcon=(be.getFieldValue("prependIcon")||"").trim():!1===t&&(r.prependIcon=""),!0===n?r.appendIcon=(be.getFieldValue("appendIcon")||"").trim():!1===n&&(r.appendIcon=""),null!==o&&(r.fontWeight=o?"bold":"normal"),null!==i&&(r.fontStyle=i?"italic":"normal"),null!==s&&(r.fontVariant=s?"small-caps":"normal"),null!==a&&(r.invert=a);const l=be.getFieldValue("fontFamily")?.trim();l&&(r.fontFamily=l);const c=be.getFieldValue("userNotes")?.trim();return c&&(r.userNotes=c),r}function Ne(e){if(e.color&&ve&&Se&&$e){const t=s(e.color,"hsl");t?(ve.setValue(t.h),Se.setValue(t.s),$e.setValue(t.l)):fe&&(fe.value=e.color)}const t=[];if(e.backgroundColor&&t.push(`background-color: ${e.backgroundColor}`),t.length>0&&be.setFieldValue("customCss",t.join(";\n")),void 0!==e.prependIcon&&(""===e.prependIcon?be.setFieldValue("prependIconEnabled",!1):(be.setFieldValue("prependIconEnabled",!0),be.setFieldValue("prependIcon",e.prependIcon))),void 0!==e.appendIcon&&(""===e.appendIcon?be.setFieldValue("appendIconEnabled",!1):(be.setFieldValue("appendIconEnabled",!0),be.setFieldValue("appendIcon",e.appendIcon))),void 0!==e.fontWeight){const t="bold"===e.fontWeight||"normal"!==e.fontWeight&&null;be.setFieldValue("fontWeight",t)}if(void 0!==e.fontStyle){const t="italic"===e.fontStyle||"normal"!==e.fontStyle&&null;be.setFieldValue("fontStyle",t)}if(void 0!==e.fontVariant){const t="small-caps"===e.fontVariant||"normal"!==e.fontVariant&&null;be.setFieldValue("fontVariant",t)}e.fontFamily&&be.setFieldValue("fontFamily",e.fontFamily),void 0!==e.invert&&be.setFieldValue("invert",e.invert),e.userNotes&&be.setFieldValue("userNotes",e.userNotes),Te()}fe&&fe.addEventListener("input",Te),he.addEventListener("click",e=>{const t=e.target.closest(".nc-icon-option");if(t){const e=t.textContent,n=t.closest(".picker-icon-options"),o=n?.dataset.target;if(o){const t="settings-prependIcon"===o?"prependIcon":"appendIcon";be.setFieldValue(t,e),Te()}t.style.background="var(--nc-fg-dim)",setTimeout(()=>{t.style.background=""},150)}}),Te()}function we(){const t=y(),n=c(null,"hsl"),{settings:o,colorVariables:i}=d(),a=Ce({title:"Nick Color Settings",width:"400px",preview:'<div class="preview-row" id="settings-preview"></div>\n\t\t\t<div class="preview-row preview-inverted" id="settings-preview-inverted"></div>',content:`\n\t\t\t${te({"Site Theme":Object.entries(n).length?"<span>"+Object.entries(n).filter(([e,t])=>!e.match(/^info|error|warn|success/i)).map(([e,t])=>`${e}: ${s(t,"hsl-string")+` <span style="border: 1px solid var(--nc-border); color: ${s(t,"hsl-string")}">███</span>`}`).join("</span><br /><span>")+"</span>":"not detected","Effective Config":`H:${t.minHue}-${t.maxHue} S:${t.minSaturation}-${t.maxSaturation} L:${t.minLightness}-${t.maxLightness}`,"Contrast Threshold":t.contrastThreshold,"Custom Colors Saved":Object.keys(D).length})}\n\t\t\t${xe({label:"Preset Theme:",id:"settings-preset",type:"select",options:`<option value="">-- Select a preset --</option>${Object.keys(V).map(e=>`<option value="${e.toLowerCase()}">${e}</option>`).join("")}`})}\n\t\t\t<hr />\n\t\t\t<div id="settings-engine-container"></div>\n\t\t`,buttons:[{label:"Save",class:"save",onClick:e=>{A=m.getValues(),q(),S(),e()}},{label:"Reset",class:"reset",onClick:()=>{const e=l.value||M||"",t=d(e),n=t.settings,o=t.colorVariables;m.setValues({...n,hueRange:[n.minHue,n.maxHue],satRange:[n.minSaturation,n.maxSaturation],litRange:[n.minLightness,n.maxLightness],singleColorHue:o.fg?.h??n.singleColorHue,singleColorSat:o.fg?.s??n.singleColorSat,singleColorLit:o.fg?.l??n.singleColorLit},!0),l.value=e.toLowerCase(),x()}},{label:"Cancel",class:"cancel",onClick:e=>e()}]}),r=a.querySelector("#settings-engine-container"),l=a.querySelector("#settings-preset"),u=a.querySelector("#settings-preview"),g=a.querySelector("#settings-preview-inverted"),p=["z0ylent","fr33Kevin","triNity","an0nym0us","ZeR0C00L","l1sb3th","enki","genghis_khan","acidBurn","neo","N3tRuNn3r","ByteMe99","CyB3rPuNk"];p.forEach(e=>{const t=document.createElement("span");t.className="preview-nick",t.textContent=e,u.appendChild(t)}),p.forEach(e=>{const t=document.createElement("span");t.className="preview-nick",t.textContent=e,g.appendChild(t)});const f=[{type:"section",label:"Monochrome Mode",fields:[{key:"useSingleColor",type:"toggle",label:"Use monochrome mode",default:!1},{type:"hint",text:"All usernames will use the same color. Per-user color customization is disabled.",showWhen:{field:"useSingleColor",is:!0}},{key:"singleColorHue",type:"slider",label:"Hue",min:0,max:360,default:i.fg?.h??180,simple:!1,showWhen:{field:"useSingleColor",is:!0}},{key:"singleColorSat",type:"slider",label:"Saturation",min:0,max:100,default:i.fg?.s??85,simple:!1,showWhen:{field:"useSingleColor",is:!0}},{key:"singleColorLit",type:"slider",label:"Lightness",min:0,max:100,default:i.fg?.l??65,simple:!1,showWhen:{field:"useSingleColor",is:!0}},{key:"singleColorCustom",type:"text",label:"Or use a custom color:",placeholder:"#ff6b6b or hsl(280, 90%, 65%)",default:"",showWhen:{field:"useSingleColor",is:!0}}]},{type:"section",label:"Hue Range"+(n.fg?"":' <span class="nc-text-dim">(no site theme)</span>'),showWhen:{field:"useSingleColor",is:!1},fields:[{key:"useSiteThemeHue",type:"toggle",label:"Use site theme foreground hue"+(n.fg?` <span style="color:hsl(${n.fg.h}, 100%, 50%)">(${n.fg.h}°)</span>`:""),default:!1,disabled:!n.fg,showWhen:{field:"useSingleColor",is:!1}},{key:"hueSpread",type:"slider",label:"Hue spread (±°)",min:5,max:180,default:30,showWhen:{all:[{field:"useSingleColor",is:!1},{field:"useSiteThemeHue",is:!0}]}},{key:"hueRange",type:"range",label:"Hue Range",min:0,max:360,default:[0,360],showWhen:{field:"useSingleColor",is:!1}}]},{type:"section",label:"Saturation Range",showWhen:{field:"useSingleColor",is:!1},fields:[{key:"useSiteThemeSat",type:"toggle",label:"Use site theme foreground saturation"+(n?.fg?` <span style="color:${n.fg}">(${n.fg.s}%)</span>`:""),default:!1,disabled:!n.fg,showWhen:{field:"useSingleColor",is:!1}},{key:"satSpread",type:"slider",label:"Saturation spread (±%)",min:0,max:50,default:15,showWhen:{all:[{field:"useSingleColor",is:!1},{field:"useSiteThemeSat",is:!0}]}},{key:"satRange",type:"range",label:"Saturation Range",min:0,max:100,default:[70,100],showWhen:{field:"useSingleColor",is:!1}}]},{type:"section",label:"Lightness Range",showWhen:{field:"useSingleColor",is:!1},fields:[{key:"useSiteThemeLit",type:"toggle",label:"Use site theme foreground lightness"+(n?.fg?` <span style="color:${n.fg}">(${n.fg.l}%)</span>`:""),default:!1,disabled:!n.fg,showWhen:{field:"useSingleColor",is:!1}},{key:"litSpread",type:"slider",label:"Lightness spread (±%)",min:0,max:50,default:10,showWhen:{all:[{field:"useSingleColor",is:!1},{field:"useSiteThemeLit",is:!0}]}},{key:"litRange",type:"range",label:"Lightness Range",min:0,max:100,default:[55,75],showWhen:{field:"useSingleColor",is:!1}}]},{type:"section",label:"Contrast",fields:[{type:"hint",text:"Auto-invert colors when WCAG contrast ratio is below threshold (0 = disabled, 3 = large text, 4.5 = AA, 7 = AAA)"},{key:"contrastThreshold",type:"slider",label:"Contrast Threshold (WCAG ratio)",min:0,max:21,step:.5,default:4.5}]},{type:"section",label:"Style Variation",fields:[{type:"hint",text:"Add non-color variation to usernames (useful for limited color ranges)"},{key:"varyWeight",type:"toggle",label:"Vary font weight",default:!1},{key:"varyItalic",type:"toggle",label:"Vary italic",default:!1},{key:"varyCase",type:"toggle",label:"Vary small-caps",default:!1},{key:"prependIcon",type:"toggle",label:"Prepend icon",default:!1},{key:"appendIcon",type:"toggle",label:"Append icon",default:!1},{key:"iconSet",type:"text",label:"Icon set (space-separated)",placeholder:"● ○ ◆ ◇ ■ □ ▲ △ ★ ☆",default:"● ○ ◆ ◇ ■ □ ▲ △ ★ ☆ ♦ ♠ ♣ ♥ ☢ ☣ ☠ ⚙ ⬡ ⬢ ♻ ⚛ ⚠ ⛒",showWhen:{any:[{field:"prependIcon",is:!0},{field:"appendIcon",is:!0}]}}]},{type:"section",label:"Backup",fields:[{type:"button",label:"Export settings to file",id:"settings-export-file",buttonText:"Save Settings File",onClick:()=>{X(W(),`nick-colors-settings-${(new Date).toISOString().slice(0,10)}.json`)}},{type:"button",label:"Export settings to clipboard",id:"settings-export-copy",buttonText:"Copy to Clipboard",onClick:async()=>{try{await K(W()),alert("Settings copied to clipboard")}catch(e){alert(e.message)}}},{type:"button",label:"Import settings from file",id:"settings-import-file",buttonText:"Load Settings File",onClick:()=>{Y((e,t)=>{if(t)return void alert(t.message);const n=P(e);if(alert(n.message),n.success){const e=document.querySelector(".nc-dialog-overlay");e&&(e.remove(),we())}})}},{type:"button",label:"Import settings from clipboard",id:"settings-import-paste",buttonText:"Paste from Clipboard",onClick:()=>{Q((e,t)=>{if(t)return void alert(t.message);const n=P(e);if(alert(n.message),n.success){const e=document.querySelector(".nc-dialog-overlay");e&&(e.remove(),we())}})}}]},{type:"section",label:"Debug",noHr:!0,fields:[{key:"debugMode",type:"toggle",label:"Enable debug mode",default:k,onChange:e=>{k=e,GM_setValue("debugMode",k?"true":"false")}},{type:"button",label:"Export debug log to file",id:"settings-debug-export-file",buttonText:"Save Debug File",onClick:()=>{!function(e,t){const n=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}(oe(),`nick-colors-debug-${(new Date).toISOString().slice(0,10)}.txt`)}},{type:"button",label:"Export debug log to clipboard",id:"settings-debug-export-copy",buttonText:"Copy to Clipboard",onClick:async()=>{try{await navigator.clipboard.writeText(oe()),alert("Debug log copied to clipboard")}catch(e){alert(`Failed to copy: ${e.message}`)}}},{type:"button",label:"Report an issue",id:"settings-report-issue",buttonText:"Report Issue",onClick:()=>function(){const t=document.createElement("div");t.className="nc-dialog-overlay",t.innerHTML='\n\t\t<div class="nc-dialog" style="min-width: 400px; max-width: 500px;">\n\t\t\t<div class="nc-dialog-header nc-flex nc-justify-between">\n\t\t\t\t<h3>Report Issue</h3>\n\t\t\t\t<div class="spacer"></div>\n\t\t\t\t<button class="nc-header-close link-brackets"><span class="inner">ESC</span></button>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-content">\n\t\t\t\t<div class="hint">Fill out the fields below to report an issue. All fields are required.</div>\n\t\t\t\t<div class="nc-input-row">\n\t\t\t\t\t<label for="report-issue">What issue are you experiencing?</label>\n\t\t\t\t\t<textarea id="report-issue" placeholder="Describe the problem..." style="width: 100%; min-height: 60px;"></textarea>\n\t\t\t\t</div>\n\t\t\t\t<div class="nc-input-row">\n\t\t\t\t\t<label for="report-steps">Steps to reproduce:</label>\n\t\t\t\t\t<textarea id="report-steps" placeholder="1. Go to...\n2. Click on...\n3. See error..." style="width: 100%; min-height: 60px;"></textarea>\n\t\t\t\t</div>\n\t\t\t\t<div class="nc-input-row">\n\t\t\t\t\t<label for="report-errors">Any error messages? (check browser console)</label>\n\t\t\t\t\t<input type="text" id="report-errors" placeholder="Optional - paste any errors" style="width: 100%;">\n\t\t\t\t</div>\n\t\t\t\t<div class="hint">Debug info will be automatically included.</div>\n\t\t\t</div>\n\t\t\t<div class="nc-dialog-footer">\n\t\t\t\t<div class="buttons nc-flex nc-items-center nc-gap-2">\n\t\t\t\t\t<button class="nc-submit-report-btn link-brackets"><span class="inner">SEND REPORT</span></button>\n\t\t\t\t\t<button class="nc-cancel-btn link-brackets"><span class="inner">CANCEL</span></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t';const n=()=>t.remove(),o=t.querySelector("#report-issue"),i=t.querySelector("#report-steps"),s=t.querySelector("#report-errors");t.querySelector(".nc-header-close").addEventListener("click",n),t.querySelector(".nc-cancel-btn").addEventListener("click",n),t.querySelector(".nc-submit-report-btn").addEventListener("click",()=>{const t=o.value.trim(),a=i.value.trim(),r=s.value.trim();if(!t)return alert("Please describe the issue"),void o.focus();if(!a)return alert("Please provide steps to reproduce"),void i.focus();const l=y(),c=`v${e} | ${Object.keys(D).length} custom | H:${l.minHue}-${l.maxHue} S:${l.minSaturation}-${l.maxSaturation} L:${l.minLightness}-${l.maxLightness}`,d={siteConfig:A,style:A};let u=`[Nick Colors Issue Report]| Issue: ${t} | Steps: ${a}`;r&&(u+=` | Errors: ${r}`),u+=` | Debug: ${c} | Page: ${window.location.href} | Settings: ${JSON.stringify(U(d))}`,n(),ee("z0ylent",u)}),t.addEventListener("click",e=>{e.target===t&&n()}),t.addEventListener("keydown",e=>{"Escape"===e.key&&n()}),document.body.appendChild(t),o.focus()}()}]}],m=ke({schema:f,values:{...t,hueRange:[t.minHue,t.maxHue],satRange:[t.minSaturation,t.maxSaturation],litRange:[t.minLightness,t.maxLightness],debugMode:k},defaults:o,onChange:(e,t)=>{"useSiteThemeHue"!==e&&"hueSpread"!==e||h("hue"),"useSiteThemeSat"!==e&&"satSpread"!==e||h("sat"),"useSiteThemeLit"!==e&&"litSpread"!==e||h("lit"),v(),x()},container:r});function h(e){if(!n.fg)return;if(!m.getFieldValue(`useSiteTheme${e.charAt(0).toUpperCase()+e.slice(1)}`))return;const t=m.getFieldValue(`${e}Spread`),o=m.getField(`${e}Range`);if("hue"===e){const e=(n.fg.h-t+360)%360,i=(n.fg.h+t)%360;o?.setValues([e,i])}else if("sat"===e){const e=Math.max(0,n.fg.s-t),i=Math.min(100,n.fg.s+t);o?.setValues([e,i])}else if("lit"===e){const e=Math.max(0,n.fg.l-t),i=Math.min(100,n.fg.l+t);o?.setValues([e,i])}}function b(e,t){const n=m.getField(e);n?.wrapper&&(n.wrapper.style.pointerEvents=t?"none":"auto",n.wrapper.querySelectorAll(".nc-slider-thumb").forEach(e=>{e.style.background=t?"var(--nc-fg-dim)":"",e.style.cursor=t?"default":""}))}function v(){const e=m.getField("hueRange"),t=m.getField("satRange"),n=m.getField("litRange"),o=m.getField("singleColorHue"),i=m.getField("singleColorSat"),s=m.getField("singleColorLit");if(!e||!t||!n)return;const[a,r]=e.getValues?.()||[0,360],[l,c]=t.getValues?.()||[70,100],[d,u]=n.getValues?.()||[55,75],g=(a+r)/2,p=(l+c)/2,f=(d+u)/2,h=Array.from({length:13},(e,t)=>[30*t,p,f,1,30*t/360*100]);if(e.setGradient?.(h),t.setGradient?.([[g,0,f,1,0],[g,100,f,1,100]]),n.setGradient?.([[g,p,0,1,0],[g,p,50,1,50],[g,p,100,1,100]]),e.setThumbColor?.([`hsl(${a}, ${p}%, ${f}%)`,`hsl(${r}, ${p}%, ${f}%)`]),t.setThumbColor?.([`hsl(${g}, ${l}%, ${f}%)`,`hsl(${g}, ${c}%, ${f}%)`]),n.setThumbColor?.([`hsl(${g}, ${p}%, ${d}%)`,`hsl(${g}, ${p}%, ${u}%)`]),o&&i&&s){const e=o.getValue?.()??180,t=i.getValue?.()??85,n=s.getValue?.()??65,a=Array.from({length:13},(e,o)=>{const i=30*o;return[i,t,n,1,i/360*100]});o.setGradient?.(a),i.setGradient?.([[e,0,n,1,0],[e,100,n,1,100]]),s.setGradient?.([[e,t,0,1,0],[e,t,50,1,50],[e,t,100,1,100]]),o.setThumbColor?.(`hsl(${e}, ${t}%, ${n}%)`),i.setThumbColor?.(`hsl(${e}, ${t}%, ${n}%)`),s.setThumbColor?.(`hsl(${e}, ${t}%, ${n}%)`)}b("hueRange",m.getFieldValue("useSiteThemeHue")),b("satRange",m.getFieldValue("useSiteThemeSat")),b("litRange",m.getFieldValue("useSiteThemeLit"))}function x(){v();const e=function(){const e=m.getValues(),t={...e};return e.hueRange&&(t.minHue=e.hueRange[0],t.maxHue=e.hueRange[1]),e.satRange&&(t.minSaturation=e.satRange[0],t.maxSaturation=e.satRange[1]),e.litRange&&(t.minLightness=e.litRange[0],t.maxLightness=e.litRange[1]),t}(),t=l.value||M||"";u.querySelectorAll(".preview-nick").forEach((n,o)=>{ce(n,p[o],{effectiveConfig:e,themeName:t,isInverted:!1,debugData:k})}),g.querySelectorAll(".preview-nick").forEach((n,o)=>{ce(n,p[o],{effectiveConfig:e,themeName:t,isInverted:!0,debugData:k})})}m.render(),l.addEventListener("change",()=>{const e=d(l.value);if(e?.settings){const t=e.settings;m.setValues({hueRange:[t.minHue,t.maxHue],satRange:[t.minSaturation,t.maxSaturation],litRange:[t.minLightness,t.maxLightness],contrastThreshold:t.contrastThreshold||4.5},!0),x()}});const C=m.getValues.bind(m);m.getValues=()=>{const e=C(),t={...e};return e.hueRange&&(t.minHue=e.hueRange[0],t.maxHue=e.hueRange[1],delete t.hueRange),e.satRange&&(t.minSaturation=e.satRange[0],t.maxSaturation=e.satRange[1],delete t.satRange),e.litRange&&(t.minLightness=e.litRange[0],t.maxLightness=e.litRange[1],delete t.litRange),delete t.debugMode,t},h("hue"),h("sat"),h("lit"),x()}document.addEventListener("contextmenu",e=>{const t=e.target.closest("[data-nick-colored], [data-mention-colored]");t&&t.dataset.username&&(e.preventDefault(),$e(t.dataset.username,le(t.dataset.username)))});let Le=null,Ee=null,Te=null;document.addEventListener("touchstart",e=>{const t=e.target.closest("[data-nick-colored], [data-mention-colored]");if(!t||!t.dataset.username)return;const n=e.touches[0];Te={x:n.clientX,y:n.clientY},Ee=t,t.style.transition="opacity 0.15s, transform 0.15s",t.style.opacity="0.7",t.style.transform="scale(0.97)",Le=setTimeout(()=>{Ee&&(Ee.style.opacity="",Ee.style.transform="",$e(Ee.dataset.username,le(Ee.dataset.username)),Ee=null)},500)},{passive:!0}),document.addEventListener("touchmove",e=>{if(!Le||!Te)return;const t=e.touches[0],n=Math.abs(t.clientX-Te.x),o=Math.abs(t.clientY-Te.y);(n>10||o>10)&&(clearTimeout(Le),Le=null,Ee&&(Ee.style.opacity="",Ee.style.transform="",Ee=null))},{passive:!0}),document.addEventListener("touchend",()=>{Le&&(clearTimeout(Le),Le=null),Ee&&(Ee.style.opacity="",Ee.style.transform="",Ee=null)}),document.addEventListener("touchcancel",()=>{Le&&(clearTimeout(Le),Le=null),Ee&&(Ee.style.opacity="",Ee.style.transform="",Ee=null)});const Ie="function"==typeof GM_registerMenuCommand?GM_registerMenuCommand:"undefined"!=typeof GM&&"function"==typeof GM.registerMenuCommand?GM.registerMenuCommand:null;Ie&&(Ie("Nick Colors Settings",we),Ie("Refresh Nick Colors",S),Ie("Clear All Custom Colors",()=>{confirm("Clear all custom color overrides?")&&(D={},z(),S())})),C(),new Promise(e=>{"undefined"!=typeof GM_xmlhttpRequest?GM_xmlhttpRequest({method:"GET",url:$,onload:t=>{try{const e=JSON.parse(t.responseText);w={...e,...w},console.log("[Nick Colors] Loaded remote overrides:",Object.keys(e).length)}catch(e){console.error("[Nick Colors] Failed to parse remote overrides:",e)}e()},onerror:t=>{console.error("[Nick Colors] Failed to fetch remote overrides:",t),e()}}):fetch($).then(e=>e.json()).then(e=>{w={...e,...w},console.log("[Nick Colors] Loaded remote overrides:",Object.keys(e).length)}).catch(e=>console.error("[Nick Colors] Failed to fetch remote overrides:",e)).finally(e)}).then(()=>{ve()}),new MutationObserver(e=>{let t=!1;for(const n of e)if(n.addedNodes.length>0){t=!0;break}t&&ve()}).observe(document.body,{childList:!0,subtree:!0}),new MutationObserver(e=>{for(const t of e)if("data-theme"===t.attributeName){console.log("[Nick Colors] Theme changed, refreshing colors",t),M=t.target.getAttribute("data-theme")||null,j(),R(),C(),S();break}}).observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]}),console.log("[Nick Colors] Loaded. Right-click or long-press any colored username to customize.")}();