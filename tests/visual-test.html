<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Nick Colors - Visual Test Suite</title>
	<style>
		:root { --color-bg: #0a0a0a; --color-fg: #e0e0e0; }
		* { box-sizing: border-box; margin: 0; padding: 0; }
		body {
			font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
			font-size: 11px;
			background: var(--color-bg);
			color: var(--color-fg);
			padding: 0.5rem;
			line-height: 1.4;
		}
		h1 { font-size: 1.2rem; margin-bottom: 0.25rem; }
		h1 + p { font-size: 0.9em; opacity: 0.6; margin-bottom: 0.5rem; }
		h2 {
			font-size: 0.95rem;
			border-bottom: 1px solid var(--color-fg);
			padding: 0.25rem 0;
			margin-top: 0.5rem;
			cursor: pointer; user-select: none;
			display: flex; align-items: center; gap: 0.3rem;
		}
		h2:hover { opacity: 0.8; }
		h2::before { content: '▼'; font-size: 0.6em; transition: transform 0.15s; width: 0.8em; }
		h2.collapsed::before { transform: rotate(-90deg); }
		h3 {
			font-size: 0.85rem; opacity: 0.85;
			margin: 0.4rem 0 0.2rem;
			cursor: pointer; user-select: none;
			display: flex; align-items: center; gap: 0.3rem;
		}
		h3:hover { opacity: 1; }
		h3::before { content: '▼'; font-size: 0.5em; transition: transform 0.15s; width: 0.7em; }
		h3.collapsed::before { transform: rotate(-90deg); }
		.subsection { overflow: hidden; transition: max-height 0.2s ease-out, opacity 0.15s; }
		.subsection.collapsed { max-height: 0 !important; opacity: 0; }
		.section {
			margin-bottom: 0.5rem; padding: 0.4rem 0.5rem;
			background: var(--color-bg); border: 1px solid var(--color-fg); border-radius: 4px;
			overflow: hidden; transition: max-height 0.2s ease-out, padding 0.2s ease-out, opacity 0.15s;
		}
		.section.collapsed { max-height: 0 !important; padding: 0 0.5rem; margin-bottom: 0.25rem; opacity: 0; border-color: transparent; }
		.test-row { display: flex; align-items: center; gap: 0.5rem; margin: 0.15rem 0; padding: 0.2rem 0.4rem; background: transparent; border-radius: 3px; }
		.test-label { min-width: 140px; opacity: 0.6; font-size: 0.9em; }
		.test-value { font-weight: bold; }
		.color-swatch { width: 40px; height: 18px; border-radius: 2px; border: 1px solid var(--color-fg); opacity: 0.8; flex-shrink: 0; }
		.nick-preview { padding: 0.1rem 0.3rem; border-radius: 2px; }
		.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.3rem; }
		.theme-card { padding: 0.4rem; border-radius: 4px; text-align: center; font-size: 0.85em; }
		.theme-card .name { font-weight: bold; margin-bottom: 0.2rem; }
		.theme-card .colors { font-size: 0.75em; opacity: 0.7; }
		.contrast-table { width: 100%; border-collapse: collapse; margin-top: 0.3rem; font-size: 0.9em; }
		.contrast-table th, .contrast-table td { padding: 0.2rem 0.4rem; text-align: left; border: 1px solid var(--color-fg); }
		.contrast-table th { opacity: 0.7; }
		.pass { opacity: 1; }
		.fail { opacity: 0.5; }
		.equation { font-family: serif; font-style: italic; opacity: 0.7; padding: 0.2rem 0.5rem; border-radius: 3px; margin: 0.2rem 0; font-size: 0.95em; }
		.result { font-weight: bold; }
		code { opacity: 0.8; padding: 0.1rem 0.3rem; border-radius: 2px; }
		input, select { background: rgba(255,255,255,0.1); border: 1px solid var(--color-fg); color: var(--color-fg); }
		p { margin: 0.2rem 0; }
		@media (min-width: 900px) {
			.columns { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; align-items: start; }
			.columns > * { margin-top: 0 !important; }
		}
	</style>
</head>
<body>
	<h1>Nick Colors - Visual Test Suite</h1>
	<p>Interactive visualization of color generation, range mapping, and WCAG contrast logic.</p>

	<h2>1. Theme & Settings</h2>
	<div class="section" id="theme-detection">
		<div class="columns">
			<div>
				<h3>1.1 Select Theme</h3>
				<div class="subsection">
					<div style="margin-bottom: 0.3rem;">
						<label for="theme-select">Theme:</label>
						<select id="theme-select" style="padding: 0.2rem; border-radius: 3px;"></select>
					</div>
					<div id="current-theme"></div>
				</div>

				<h3>1.2 Color Settings</h3>
				<div class="subsection">
					<div id="color-sliders"></div>
				</div>
			</div>
			<div>
				<h3>1.3 All Preset Themes</h3>
				<div class="subsection">
					<div class="grid" id="preset-themes"></div>
				</div>
			</div>
		</div>
	</div>

	<h2>2. Color Generation</h2>
	<div class="section" id="color-generation">
		<div class="columns">
			<div>
				<h3>2.1 Hash-Based Colors</h3>
				<div class="subsection">
					<p>Same username = same color (case-insensitive):</p>
					<div id="hash-colors"></div>
				</div>
			</div>
			<div>
				<h3>2.2 Base vs Mapped Colors</h3>
				<div class="subsection">
					<p>Base colors mapped to configured ranges:</p>
					<div id="base-vs-mapped"></div>
				</div>
			</div>
		</div>
	</div>

	<h2>3. Range Mapping</h2>
	<div class="section" id="range-mapping">
		<div class="columns">
			<div>
				<h3>3.1 Linear Mapping</h3>
				<div class="subsection">
					<p class="equation">mapped = min + (value/100) × (max-min)</p>
					<div id="linear-mapping"></div>
				</div>

				<h3>3.2 Hue Mapping (Normal)</h3>
				<div class="subsection">
					<p class="equation">mapped = minHue + (hue/360) × (maxHue-minHue)</p>
					<div id="hue-mapping"></div>
				</div>
			</div>
			<div>
				<h3>3.3 Hue Mapping (Wrap-Around)</h3>
				<div class="subsection">
					<p>Range [300,60] wraps through 0:</p>
					<div id="hue-wraparound"></div>
				</div>
			</div>
		</div>
	</div>

	<h2>4. WCAG Contrast Detection</h2>
	<div class="section" id="wcag-contrast">
		<div class="columns">
			<div>
				<h3>4.1 Relative Luminance</h3>
				<div class="subsection">
					<p class="equation">L = 0.2126R + 0.7152G + 0.0722B</p>
					<div id="luminance-tests"></div>
				</div>

				<h3>4.2 Contrast Ratio</h3>
				<div class="subsection">
					<p class="equation">ratio = (L₁+0.05) / (L₂+0.05)</p>
					<div id="contrast-ratio-tests"></div>
				</div>
			</div>
			<div>
				<h3>4.3 WCAG Thresholds</h3>
				<div class="subsection">
					<table class="contrast-table" id="wcag-thresholds">
						<thead><tr><th>Color</th><th>BG</th><th>Ratio</th><th>AA</th><th>AAA</th></tr></thead>
						<tbody></tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<h2>5. Contrast Inversion</h2>
	<div class="section" id="contrast-inversion">
		<div class="columns">
			<div>
				<h3>5.1 Auto-Inversion</h3>
				<div class="subsection">
					<p>Low contrast colors get inverted (bg=color, text=fg):</p>
					<div id="inversion-examples"></div>
				</div>
			</div>
			<div>
				<h3>5.2 Inverted Container</h3>
				<div class="subsection">
					<p>Light-bg containers reverse inversion logic:</p>
					<div class="profile-box-inverted" id="inverted-nicks"></div>
				</div>
			</div>
		</div>
	</div>

	<h2>6. Live Nick Preview</h2>
	<div class="section" id="live-preview">
		<div class="columns">
			<div>
				<h3>6.1 Sample Usernames</h3>
				<div class="subsection">
					<div id="sample-nicks" class="grid"></div>
				</div>
			</div>
			<div>
				<h3>6.2 Custom Test</h3>
				<div class="subsection">
					<input type="text" id="custom-username" placeholder="Enter username..." style="padding: 0.2rem; width: 150px; border-radius: 3px;">
					<div id="custom-nick-result" style="margin-top: 0.3rem;"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Mock GM APIs before loading source files -->
	<script>
		// Mock GM APIs for browser environment
		window.GM_setValue = (key, value) => localStorage.setItem('nickColors_' + key, value);
		window.GM_getValue = (key, defaultValue) => {
			const val = localStorage.getItem('nickColors_' + key);
			return val !== null ? val : defaultValue;
		};
		window.GM_registerMenuCommand = () => {};
		window.GM_xmlhttpRequest = () => {};
	</script>

	<!-- Load source files in order -->
	<script src="../src/helper-functions.js"></script>
	<script src="../src/header.js"></script>
	<script src="../src/nick-style-functions.js"></script>
	<script src="../src/slider-component.js"></script>

	<!-- Visual test specific code -->
	<script>
	// =====================================================
	// VISUAL TEST APPLICATION
	// Uses functions from loaded source files
	// =====================================================

	let currentThemeName = 'Full Spectrum';
	let bgRgb = { r: 10, g: 10, b: 10 };

	// Slider instances
	let hueSlider, satSlider, litSlider, contrastSlider;
	let slidersInitialized = false;

	function setTheme(themeName) {
		const theme = PRESET_THEMES[themeName];
		if (!theme) return;

		currentThemeName = themeName;
		// Update colorConfig from theme
		Object.assign(colorConfig, { ...DEFAULT_COLOR_CONFIG, ...theme.color });
		bgRgb = hexToRgb(theme.bg) || { r: 10, g: 10, b: 10 };

		// Update siteTheme for getBackgroundRgb/getForegroundRgb
		siteTheme = { fg: theme.fg, bg: theme.bg };

		// Update CSS variables for the page
		document.documentElement.style.setProperty('--color-bg', theme.bg);
		document.documentElement.style.setProperty('--color-fg', theme.fg);
		document.body.style.background = theme.bg;
		document.body.style.color = theme.fg;

		// Update sliders if they exist
		if (slidersInitialized) {
			hueSlider.setValues([colorConfig.minHue, colorConfig.maxHue]);
			satSlider.setValues([colorConfig.minSaturation, colorConfig.maxSaturation]);
			litSlider.setValues([colorConfig.minLightness, colorConfig.maxLightness]);
			contrastSlider.setValue(colorConfig.contrastThreshold);
			updateSliderGradients();
		}

		// Re-render all sections
		renderThemeDetection();
		renderColorGeneration();
		renderRangeMapping();
		renderWcagContrast();
		renderContrastInversion();
		renderLivePreview();

		requestAnimationFrame(updateSectionHeights);
	}
	// Make setTheme available globally for onclick handlers
	window.setTheme = setTheme;

	function updateSliderGradients() {
		const [minH, maxH] = hueSlider.getValues();
		const [minS, maxS] = satSlider.getValues();
		const [minL, maxL] = litSlider.getValues();
		const midH = (minH + maxH) / 2, midS = (minS + maxS) / 2, midL = (minL + maxL) / 2;

		// Hue gradient
		const hueStops = Array.from({ length: 13 }, (_, i) => [i * 30, midS, midL, 1, (i * 30 / 360) * 100]);
		hueSlider.setGradient(hueStops);

		// Saturation gradient
		satSlider.setGradient([[midH, 0, midL, 1, 0], [midH, 100, midL, 1, 100]]);

		// Lightness gradient
		litSlider.setGradient([[midH, midS, 0, 1, 0], [midH, midS, 50, 1, 50], [midH, midS, 100, 1, 100]]);

		// Update thumb colors
		hueSlider.setThumbColor([`hsl(${minH}, ${midS}%, ${midL}%)`, `hsl(${maxH}, ${midS}%, ${midL}%)`]);
		satSlider.setThumbColor([`hsl(${midH}, ${minS}%, ${midL}%)`, `hsl(${midH}, ${maxS}%, ${midL}%)`]);
		litSlider.setThumbColor([`hsl(${midH}, ${midS}%, ${minL}%)`, `hsl(${midH}, ${midS}%, ${maxL}%)`]);
	}

	function onSliderChange() {
		const [minHue, maxHue] = hueSlider.getValues();
		const [minSaturation, maxSaturation] = satSlider.getValues();
		const [minLightness, maxLightness] = litSlider.getValues();
		const contrastThreshold = contrastSlider.getValue();

		Object.assign(colorConfig, { minHue, maxHue, minSaturation, maxSaturation, minLightness, maxLightness, contrastThreshold });
		updateSliderGradients();

		renderColorGeneration();
		renderContrastInversion();
		renderLivePreview();

		requestAnimationFrame(updateSectionHeights);
	}

	function initSliders() {
		const container = document.getElementById('color-sliders');

		hueSlider = createSlider({
			type: 'range', min: 0, max: 360,
			values: [colorConfig.minHue, colorConfig.maxHue],
			label: 'Hue Range (0-360°)',
			onChange: onSliderChange
		});

		satSlider = createSlider({
			type: 'range', min: 0, max: 100,
			values: [colorConfig.minSaturation, colorConfig.maxSaturation],
			label: 'Saturation Range (0-100%)',
			onChange: onSliderChange
		});

		litSlider = createSlider({
			type: 'range', min: 0, max: 100,
			values: [colorConfig.minLightness, colorConfig.maxLightness],
			label: 'Lightness Range (0-100%)',
			onChange: onSliderChange
		});

		contrastSlider = createSlider({
			simple: true, min: 0, max: 21, step: 0.5,
			value: colorConfig.contrastThreshold,
			label: 'Contrast Threshold (WCAG ratio, 0=disabled, 4.5=AA, 7=AAA)',
			onChange: onSliderChange
		});

		container.appendChild(hueSlider.el);
		container.appendChild(satSlider.el);
		container.appendChild(litSlider.el);
		container.appendChild(contrastSlider.el);

		updateSliderGradients();
		slidersInitialized = true;
	}

	// =====================================================
	// RENDER FUNCTIONS
	// =====================================================

	function renderThemeDetection() {
		const select = document.getElementById('theme-select');
		if (select.options.length === 0) {
			Object.keys(PRESET_THEMES).forEach(name => {
				const option = document.createElement('option');
				option.value = name;
				option.textContent = name;
				if (name === currentThemeName) option.selected = true;
				select.appendChild(option);
			});
			select.addEventListener('change', (e) => setTheme(e.target.value));
		} else {
			select.value = currentThemeName;
		}

		const currentThemeDiv = document.getElementById('current-theme');
		const theme = PRESET_THEMES[currentThemeName];

		currentThemeDiv.innerHTML = `
			<div class="test-row">
				<span class="test-label">FG/BG:</span>
				<div class="color-swatch" style="background: ${theme.fg}"></div>
				<div class="color-swatch" style="background: ${theme.bg}"></div>
				<span class="test-value">${theme.fg} / ${theme.bg}</span>
			</div>
		`;

		const presetsDiv = document.getElementById('preset-themes');
		presetsDiv.innerHTML = Object.entries(PRESET_THEMES).map(([name, theme]) => `
			<div class="theme-card" style="background: ${theme.bg}; color: ${theme.fg}; border: 1px solid ${name === currentThemeName ? theme.fg : theme.fg + '33'}; cursor: pointer;" onclick="setTheme('${name}')">
				<div class="name">${name}</div>
				<div style="font-size: 0.7em; opacity: 0.7;">H:${theme.color.minHue}-${theme.color.maxHue}</div>
			</div>
		`).join('');
	}

	function renderColorGeneration() {
		const hashDiv = document.getElementById('hash-colors');
		const testUsers = ['Alice', 'alice', 'Bob', 'z0ylent'];

		hashDiv.innerHTML = testUsers.map(user => {
			const base = getBaseColor(user);
			const color = `hsl(${base.h}, ${base.s}%, ${base.l}%)`;
			return `<div class="test-row">
				<span class="test-label">${user}</span>
				<div class="color-swatch" style="background: ${color}"></div>
				<span class="test-value">H${base.h} S${base.s} L${base.l}</span>
			</div>`;
		}).join('');

		const mappedDiv = document.getElementById('base-vs-mapped');
		mappedDiv.innerHTML = ['neo', 'trinity', 'morpheus', 'alice', 'bob', 'cypher', 'tank', 'dozer'].map(user => {
			const base = getBaseColor(user);
			const mapped = applyRangeMapping(base, colorConfig);
			const baseColor = `hsl(${base.h}, ${base.s}%, ${base.l}%)`;
			const mappedColor = `hsl(${mapped.h.toFixed(1)}, ${mapped.s.toFixed(1)}%, ${mapped.l.toFixed(1)}%)`;
			return `<div class="test-row">
				<span class="test-label">${user}</span>
				<div class="color-swatch" style="background: ${baseColor}" title="Base"></div>
				<span style="opacity:0.5">→</span>
				<div class="color-swatch" style="background: ${mappedColor}" title="Mapped"></div>
				<span class="test-value">H${mapped.h.toFixed(0)} S${mapped.s.toFixed(0)} L${mapped.l.toFixed(0)}</span>
			</div>`;
		}).join('');
	}

	function renderRangeMapping() {
		const linearDiv = document.getElementById('linear-mapping');
		const linearTests = [
			{ input: 50, min: 70, max: 100, expected: 85 },
			{ input: 0, min: 30, max: 80, expected: 30 },
			{ input: 100, min: 30, max: 80, expected: 80 },
		];

		linearDiv.innerHTML = linearTests.map(t => {
			const result = mapToRange(t.input, t.min, t.max);
			const pass = Math.abs(result - t.expected) < 0.01;
			return `<div class="test-row">
				<span class="test-label">(${t.input},${t.min},${t.max})</span>
				<span class="test-value result">${result.toFixed(1)}</span>
				<span class="${pass ? 'pass' : 'fail'}">${pass ? '✓' : '✗'} ${t.expected}</span>
			</div>`;
		}).join('');

		const hueDiv = document.getElementById('hue-mapping');
		const hueTests = [
			{ input: 0, min: 100, max: 200, expected: 100 },
			{ input: 360, min: 100, max: 200, expected: 200 },
			{ input: 180, min: 100, max: 200, expected: 150 },
		];

		hueDiv.innerHTML = hueTests.map(t => {
			const result = mapHueToRange(t.input, t.min, t.max);
			const pass = Math.abs(result - t.expected) < 0.01;
			return `<div class="test-row">
				<span class="test-label">(${t.input},${t.min},${t.max})</span>
				<span class="test-value result">${result.toFixed(1)}</span>
				<span class="${pass ? 'pass' : 'fail'}">${pass ? '✓' : '✗'} ${t.expected}</span>
			</div>`;
		}).join('');

		const wrapDiv = document.getElementById('hue-wraparound');
		const wrapTests = [
			{ input: 0, min: 300, max: 60, expected: 300 },
			{ input: 180, min: 300, max: 60, expected: 0 },
			{ input: 360, min: 300, max: 60, expected: 60 },
		];

		wrapDiv.innerHTML = wrapTests.map(t => {
			const result = mapHueToRange(t.input, t.min, t.max);
			const pass = Math.abs(result - t.expected) < 0.5;
			const color = `hsl(${result}, 80%, 60%)`;
			return `<div class="test-row">
				<span class="test-label">(${t.input},${t.min},${t.max})</span>
				<div class="color-swatch" style="background: ${color}"></div>
				<span class="test-value result">${result.toFixed(0)}</span>
				<span class="${pass ? 'pass' : 'fail'}">${pass ? '✓' : '✗'} ${t.expected}</span>
			</div>`;
		}).join('');
	}

	function renderWcagContrast() {
		const lumDiv = document.getElementById('luminance-tests');
		const lumTests = [
			{ color: 'Black', rgb: {r:0,g:0,b:0}, expected: 0 },
			{ color: 'White', rgb: {r:255,g:255,b:255}, expected: 1 },
			{ color: 'Red', rgb: {r:255,g:0,b:0}, expected: 0.2126 },
			{ color: 'Green', rgb: {r:0,g:255,b:0}, expected: 0.7152 },
			{ color: 'Blue', rgb: {r:0,g:0,b:255}, expected: 0.0722 },
		];

		lumDiv.innerHTML = lumTests.map(t => {
			const result = getRelativeLuminance(t.rgb.r, t.rgb.g, t.rgb.b);
			const pass = Math.abs(result - t.expected) < 0.01;
			const bg = `rgb(${t.rgb.r}, ${t.rgb.g}, ${t.rgb.b})`;
			return `<div class="test-row">
				<div class="color-swatch" style="background: ${bg}"></div>
				<span class="test-label">${t.color}</span>
				<span class="test-value result">${result.toFixed(3)}</span>
				<span class="${pass ? 'pass' : 'fail'}">${pass ? '✓' : '✗'}</span>
			</div>`;
		}).join('');

		const contrastDiv = document.getElementById('contrast-ratio-tests');
		const black = {r:0,g:0,b:0}, white = {r:255,g:255,b:255};
		const contrastTests = [
			{ c1: black, c2: white, name: 'Blk/Wht', expected: 21 },
			{ c1: {r:128,g:128,b:128}, c2: {r:128,g:128,b:128}, name: 'Same', expected: 1 },
		];

		contrastDiv.innerHTML = contrastTests.map(t => {
			const result = getContrastRatio(t.c1, t.c2);
			const pass = Math.abs(result - t.expected) < 0.5;
			return `<div class="test-row">
				<div class="color-swatch" style="background: rgb(${t.c1.r},${t.c1.g},${t.c1.b})"></div>
				<div class="color-swatch" style="background: rgb(${t.c2.r},${t.c2.g},${t.c2.b})"></div>
				<span class="test-label">${t.name}</span>
				<span class="test-value result">${result.toFixed(1)}:1</span>
				<span class="${pass ? 'pass' : 'fail'}">${pass ? '✓' : '✗'}</span>
			</div>`;
		}).join('');

		const tbody = document.querySelector('#wcag-thresholds tbody');
		const testColors = [
			{ name: 'White', hex: '#ffffff' },
			{ name: 'Lt gray', hex: '#bbbbbb' },
			{ name: 'Dk gray', hex: '#666666' },
			{ name: 'V.dark', hex: '#333333' },
		];

		tbody.innerHTML = testColors.map(c => {
			const rgb = hexToRgb(c.hex);
			const ratio = getContrastRatio(rgb, bgRgb);
			const passAA = ratio >= 4.5;
			const passAAA = ratio >= 7.0;
			return `<tr>
				<td><div class="color-swatch" style="background: ${c.hex}; display: inline-block; vertical-align: middle;"></div> ${c.name}</td>
				<td><div class="color-swatch" style="background: rgb(${bgRgb.r},${bgRgb.g},${bgRgb.b}); display: inline-block; vertical-align: middle;"></div></td>
				<td>${ratio.toFixed(1)}</td>
				<td class="${passAA ? 'pass' : 'fail'}">${passAA ? '✓' : '✗'}</td>
				<td class="${passAAA ? 'pass' : 'fail'}">${passAAA ? '✓' : '✗'}</td>
			</tr>`;
		}).join('');
	}

	function renderContrastInversion() {
		const inversionDiv = document.getElementById('inversion-examples');
		const testUsers = ['dark', 'light', 'mid'];

		const configs = [
			{ name: 'L:5-15', minLightness: 5, maxLightness: 15 },
			{ name: 'L:40-50', minLightness: 40, maxLightness: 50 },
			{ name: 'L:70-90', minLightness: 70, maxLightness: 90 },
		];

		inversionDiv.innerHTML = configs.map(cfg => {
			const config = { ...DEFAULT_COLOR_CONFIG, ...cfg, contrastThreshold: 4.5 };
			return `<div style="margin-bottom:0.3rem;"><strong style="opacity:0.6;font-size:0.85em;">${cfg.name}</strong>
				${testUsers.map(user => {
					// Temporarily set colorConfig for generateStyles
					const savedConfig = { ...colorConfig };
					Object.assign(colorConfig, config);
					const styles = generateStyles(user);
					Object.assign(colorConfig, savedConfig);

					const preview = styles.backgroundColor
						? `<span class="nick-preview" style="background:${styles.backgroundColor};color:${styles.color};padding:${styles.padding}">${user}</span>`
						: `<span class="nick-preview" style="color:${styles.color}">${user}</span>`;

					const hsl = parseColorToHsl(styles.backgroundColor || styles.color);
					const colorRgb = hsl ? hslToRgb(hsl.h, hsl.s, hsl.l) : null;
					const ratio = colorRgb ? getContrastRatio(colorRgb, bgRgb) : 0;
					return `${preview}<span style="opacity:0.5;font-size:0.8em;margin-left:0.2rem;">${ratio.toFixed(1)}</span>`;
				}).join(' ')}
			</div>`;
		}).join('');

		// Inverted container demo - use actual applyStyles with DOM elements
		const theme = PRESET_THEMES[currentThemeName];
		const invertedNicks = document.getElementById('inverted-nicks');
		invertedNicks.style.background = theme.fg;
		invertedNicks.style.color = theme.bg;
		invertedNicks.style.padding = '0.4rem';
		invertedNicks.style.borderRadius = '4px';
		invertedNicks.innerHTML = '';

		// Use more test users to show variety of contrast scenarios
		const invertedTestUsers = ['dark', 'light', 'mid', 'neo', 'trinity', 'alice'];
		const containerBgRgb = hexToRgb(theme.fg) || { r: 224, g: 224, b: 224 };

		// Force high lightness to demonstrate inversion in light containers
		const savedConfig = { ...colorConfig };
		Object.assign(colorConfig, { ...colorConfig, minLightness: 70, maxLightness: 90 });

		invertedTestUsers.forEach(user => {
			const span = document.createElement('span');
			span.className = 'nick-preview';
			span.textContent = user;
			invertedNicks.appendChild(span);

			// Use the actual applyStyles function from the source
			applyStyles(span, user);

			// Show contrast ratio
			const styles = generateStyles(user);
			const hsl = parseColorToHsl(styles.backgroundColor || styles.color);
			if (hsl) {
				const rgb = hslToRgb(hsl.h, hsl.s, hsl.l);
				const ratio = getContrastRatio(rgb, containerBgRgb);
				const ratioSpan = document.createElement('span');
				ratioSpan.style.opacity = '0.5';
				ratioSpan.style.fontSize = '0.8em';
				ratioSpan.style.marginRight = '0.5em';
				ratioSpan.textContent = ratio.toFixed(1);
				invertedNicks.appendChild(ratioSpan);
			} else {
				invertedNicks.appendChild(document.createTextNode(' '));
			}
		});

		// Restore config
		Object.assign(colorConfig, savedConfig);
	}

	let customInputInitialized = false;

	function updateCustomNickResult() {
		const input = document.getElementById('custom-username');
		const result = document.getElementById('custom-nick-result');
		const username = input.value.trim();
		if (!username) { result.innerHTML = ''; return; }

		const base = getBaseColor(username);
		const styles = generateStyles(username);
		const preview = styles.backgroundColor
			? `<span class="nick-preview" style="background:${styles.backgroundColor};color:${styles.color};padding:${styles.padding};font-size:1.2em;">${username}</span>`
			: `<span class="nick-preview" style="color:${styles.color};font-size:1.2em;">${username}</span>`;

		const hsl = parseColorToHsl(styles.backgroundColor || styles.color);
		const colorRgb = hsl ? hslToRgb(hsl.h, hsl.s, hsl.l) : null;
		const contrastRatio = colorRgb ? getContrastRatio(colorRgb, bgRgb) : null;

		const ratioText = contrastRatio !== null ? `${contrastRatio.toFixed(1)}:1` : 'N/A';
		const aaStatus = contrastRatio !== null
			? `<span class="${contrastRatio >= 4.5 ? 'pass' : 'fail'}">${contrastRatio >= 4.5 ? 'AA✓' : 'AA✗'}</span>`
			: '';
		const isOverride = MANUAL_OVERRIDES[username] || MANUAL_OVERRIDES[username?.toLowerCase()];
		result.innerHTML = `${preview}
			<div class="test-row" style="margin-top:0.3rem;">
				<span class="test-label">HSL:</span>
				<span class="test-value">H${base.h} S${base.s} L${base.l}</span>
				<span class="test-label">Ratio:</span>
				<span class="test-value">${ratioText}</span>
				${aaStatus}
				<span class="test-value" style="margin-left:0.5rem;">${isOverride ? 'Override' : styles.backgroundColor ? 'Inverted' : ''}</span>
			</div>`;
	}

	function renderLivePreview() {
		const sampleNicks = document.getElementById('sample-nicks');
		const sampleUsers = ['z0ylent', 'frexxx', 'CyB3rPuNk', 'ZeR0C00L', 'enki', 'neo', 'acidBurn', 'trinity'];

		sampleNicks.innerHTML = sampleUsers.map(user => {
			const styles = generateStyles(user);
			if (styles.backgroundColor) {
				return `<span class="nick-preview" style="background:${styles.backgroundColor};color:${styles.color};padding:${styles.padding}">${user}</span>`;
			}
			return `<span class="nick-preview" style="color:${styles.color}">${user}</span>`;
		}).join('');

		if (!customInputInitialized) {
			document.getElementById('custom-username').addEventListener('input', updateCustomNickResult);
			customInputInitialized = true;
		}

		updateCustomNickResult();
	}

	// =====================================================
	// COLLAPSIBLE SECTIONS
	// =====================================================

	function getCollapsedState() {
		try {
			return JSON.parse(localStorage.getItem('visualTestCollapsed') || '{}');
		} catch { return {}; }
	}

	function saveCollapsedState(id, isCollapsed) {
		const state = getCollapsedState();
		if (isCollapsed) {
			state[id] = true;
		} else {
			delete state[id];
		}
		localStorage.setItem('visualTestCollapsed', JSON.stringify(state));
	}

	function initCollapsibleSections() {
		const collapsedState = getCollapsedState();

		document.querySelectorAll('h2').forEach((h2, i) => {
			const section = h2.nextElementSibling;
			if (!section || !section.classList.contains('section')) return;

			const id = `h2-${i}`;
			section.style.maxHeight = section.scrollHeight + 'px';

			if (collapsedState[id]) {
				h2.classList.add('collapsed');
				section.classList.add('collapsed');
			}

			h2.addEventListener('click', () => {
				const isCollapsed = h2.classList.toggle('collapsed');
				if (isCollapsed) {
					section.classList.add('collapsed');
				} else {
					section.classList.remove('collapsed');
					section.style.maxHeight = section.scrollHeight + 'px';
				}
				saveCollapsedState(id, isCollapsed);
			});
		});

		document.querySelectorAll('h3').forEach((h3, i) => {
			const subsection = h3.nextElementSibling;
			if (!subsection || !subsection.classList.contains('subsection')) return;

			const id = `h3-${i}`;
			subsection.style.maxHeight = subsection.scrollHeight + 'px';

			if (collapsedState[id]) {
				h3.classList.add('collapsed');
				subsection.classList.add('collapsed');
			}

			h3.addEventListener('click', (e) => {
				e.stopPropagation();
				const isCollapsed = h3.classList.toggle('collapsed');
				if (isCollapsed) {
					subsection.classList.add('collapsed');
				} else {
					subsection.classList.remove('collapsed');
					subsection.style.maxHeight = subsection.scrollHeight + 'px';
				}
				saveCollapsedState(id, isCollapsed);
				updateSectionHeights();
			});
		});
	}

	function updateSectionHeights() {
		document.querySelectorAll('.subsection:not(.collapsed)').forEach(subsection => {
			subsection.style.maxHeight = subsection.scrollHeight + 'px';
		});
		document.querySelectorAll('.section:not(.collapsed)').forEach(section => {
			section.style.maxHeight = section.scrollHeight + 'px';
		});
	}

	// =====================================================
	// INITIALIZE
	// =====================================================

	async function loadOverrides() {
		try {
			const response = await fetch('../overrides.json');
			if (response.ok) {
				MANUAL_OVERRIDES = await response.json();
				console.log('[Visual Test] Loaded overrides:', MANUAL_OVERRIDES);
			}
		} catch (e) {
			console.warn('[Visual Test] Could not load overrides.json:', e);
			// Fallback for file:// protocol
			MANUAL_OVERRIDES = {
				"z0ylent": { "color": "#00FF00" },
				"frexxx": { "color": "#5a8a55", "backgroundColor": "#000000" }
			};
		}
	}

	document.addEventListener('DOMContentLoaded', async () => {
		await loadOverrides();
		// Initialize with the default theme
		setTheme(currentThemeName);
		initSliders();
		initCollapsibleSections();
	});
	</script>
</body>
</html>
